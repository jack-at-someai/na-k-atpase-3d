<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workbench — Asset Studio</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0a;--surface:#111;--border:#222;--text:#e0e0e0;
  --dim:#666;--accent:#00e5ff;--green:#4caf50;--amber:#ffab00;
  --purple:#bb86fc;
}
body{background:var(--bg);color:var(--text);font-family:'SF Mono','Cascadia Code','Consolas',monospace;font-size:13px}
header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px}
header h1{font-size:14px;font-weight:600;letter-spacing:0.5px;text-transform:uppercase;color:var(--accent)}
header .controls{display:flex;gap:8px;margin-left:auto}
header button{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:6px 14px;border-radius:4px;cursor:pointer;font-family:inherit;font-size:12px;transition:all .15s}
header button:hover{border-color:var(--accent);color:var(--accent)}
header button.active{background:var(--accent);color:#000;border-color:var(--accent)}
.layout{display:flex;height:calc(100vh - 53px)}
.sidebar{width:240px;border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0}
.sidebar .entity{border-bottom:1px solid var(--border)}
.sidebar .entity-name{padding:10px 16px;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);cursor:pointer;display:flex;align-items:center;gap:8px;transition:color .15s}
.sidebar .entity-name:hover{color:var(--text)}
.sidebar .entity-name .count{margin-left:auto;background:var(--surface);padding:1px 6px;border-radius:8px;font-size:10px}
.sidebar .entity-name.active{color:var(--accent)}
.sidebar .file-list{display:none;padding:0 16px 8px}
.sidebar .file-list.open{display:block}
.sidebar .file-item{padding:4px 8px;font-size:12px;cursor:pointer;border-radius:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:background .15s}
.sidebar .file-item:hover{background:var(--surface)}
.sidebar .file-item.active{background:var(--accent);color:#000}
.sidebar .file-item .ext{color:var(--dim);font-size:10px}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.toolbar{padding:8px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;font-size:12px}
.toolbar .filename{color:var(--accent);font-weight:600}
.toolbar .meta{color:var(--dim)}
.toolbar .actions{margin-left:auto;display:flex;gap:6px}
.toolbar button{background:none;border:1px solid var(--border);color:var(--dim);padding:4px 10px;border-radius:3px;cursor:pointer;font-family:inherit;font-size:11px}
.toolbar button:hover{color:var(--text);border-color:var(--text)}
.canvas-area{flex:1;display:flex;align-items:center;justify-content:center;overflow:auto;background:var(--bg);position:relative}
.canvas-area .checker{position:absolute;inset:0;background-image:
  linear-gradient(45deg,#0e0e0e 25%,transparent 25%),
  linear-gradient(-45deg,#0e0e0e 25%,transparent 25%),
  linear-gradient(45deg,transparent 75%,#0e0e0e 75%),
  linear-gradient(-45deg,transparent 75%,#0e0e0e 75%);
  background-size:20px 20px;background-position:0 0,0 10px,10px -10px,-10px 0;opacity:0.3}
#preview{position:relative;z-index:1}
#preview svg{max-width:90vw;max-height:80vh}
.gallery{flex:1;overflow-y:auto;padding:24px}
.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
.gallery-card{background:var(--surface);border:1px solid var(--border);border-radius:6px;overflow:hidden;cursor:pointer;transition:border-color .15s}
.gallery-card:hover{border-color:var(--accent)}
.gallery-card .thumb{height:160px;display:flex;align-items:center;justify-content:center;background:var(--bg);position:relative;overflow:hidden}
.gallery-card .thumb svg,.gallery-card .thumb img{max-width:90%;max-height:90%;object-fit:contain}
.gallery-card .info{padding:8px 12px;border-top:1px solid var(--border)}
.gallery-card .info .name{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gallery-card .info .type{font-size:10px;color:var(--dim)}
.drop-zone{border:2px dashed var(--border);border-radius:12px;padding:48px;text-align:center;color:var(--dim);margin:24px}
.drop-zone.over{border-color:var(--accent);color:var(--accent)}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--dim);gap:12px}
.empty-state .big{font-size:48px;opacity:0.2}
.json-editor{display:none;flex:1;overflow:hidden}
.json-editor textarea{width:100%;height:100%;background:var(--bg);color:var(--green);border:none;padding:16px;font-family:inherit;font-size:12px;resize:none;outline:none}
.split-view .canvas-area{width:50%}
.split-view .json-editor{display:flex;width:50%;border-left:1px solid var(--border)}
.status{position:fixed;bottom:0;left:0;right:0;padding:6px 24px;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;gap:16px;font-size:11px;color:var(--dim);z-index:100}
.status .dot{width:6px;height:6px;border-radius:50%;background:var(--green)}
.status .auto-label{margin-left:auto}
</style>
</head>
<body>

<header>
  <h1>Workbench</h1>
  <span style="color:var(--dim);font-size:12px">Asset Studio</span>
  <div class="controls">
    <button id="btn-gallery" class="active" onclick="showView('gallery')">Gallery</button>
    <button id="btn-preview" onclick="showView('preview')">Preview</button>
    <button id="btn-split" onclick="showView('split')">Split</button>
  </div>
</header>

<div class="layout">
  <div class="sidebar" id="sidebar"></div>
  <div class="main" id="main-area">
    <div class="toolbar" id="toolbar" style="display:none">
      <span class="filename" id="tb-filename">—</span>
      <span class="meta" id="tb-meta"></span>
      <div class="actions">
        <button onclick="reloadCurrent()">Reload</button>
        <button onclick="copyJSON()">Copy JSON</button>
      </div>
    </div>
    <div class="canvas-area" id="canvas-area" style="display:none">
      <div class="checker"></div>
      <div id="preview"></div>
    </div>
    <div class="json-editor" id="json-editor">
      <textarea id="json-src" spellcheck="false" oninput="liveUpdate()"></textarea>
    </div>
    <div class="gallery" id="gallery-view">
      <div class="empty-state" id="empty-state">
        <div class="big">&#9678;</div>
        <div>No assets yet. Generate Lottie JSON or SVG files in the asset folders.</div>
        <div style="font-size:11px">workbench/assets/{entity}/filename.json</div>
      </div>
      <div class="gallery-grid" id="gallery-grid"></div>
    </div>
  </div>
</div>

<div class="status">
  <span class="dot" id="status-dot"></span>
  <span id="status-text">Ready</span>
  <span id="asset-count">0 assets</span>
  <span class="auto-label">
    Auto-refresh: <strong id="auto-status">polling</strong>
  </span>
</div>

<script>
const ENTITIES = [
  'charlotte','someai','sounder','isg','richard-enterprises','prier-violins',
  'top-tier-moving','lineleap','gesdate','sea-lion','serengeti','hoshin-kanri','shared'
];

let registry = {};       // entity -> [{name, type, path, data}]
let currentAsset = null;
let currentView = 'gallery';
let lottieAnim = null;

// ── Sidebar ──
function buildSidebar() {
  const sb = document.getElementById('sidebar');
  sb.innerHTML = ENTITIES.map(e => `
    <div class="entity" data-entity="${e}">
      <div class="entity-name" onclick="toggleEntity('${e}')">
        <span>${e}</span>
        <span class="count" id="count-${e}">0</span>
      </div>
      <div class="file-list" id="files-${e}"></div>
    </div>
  `).join('');
}

function toggleEntity(entity) {
  const fl = document.getElementById('files-' + entity);
  const en = fl.previousElementSibling;
  fl.classList.toggle('open');
  en.classList.toggle('active');
}

function updateSidebar() {
  ENTITIES.forEach(e => {
    const items = registry[e] || [];
    document.getElementById('count-' + e).textContent = items.length;
    document.getElementById('files-' + e).innerHTML = items.map((a, i) => `
      <div class="file-item ${currentAsset && currentAsset.path === a.path ? 'active' : ''}"
           onclick="selectAsset('${e}', ${i})">
        ${a.name} <span class="ext">.${a.type}</span>
      </div>
    `).join('');
  });
  const total = Object.values(registry).flat().length;
  document.getElementById('asset-count').textContent = total + ' asset' + (total !== 1 ? 's' : '');
}

// ── Views ──
function showView(v) {
  currentView = v;
  document.querySelectorAll('header button').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-' + v).classList.add('active');

  const canvas = document.getElementById('canvas-area');
  const editor = document.getElementById('json-editor');
  const gallery = document.getElementById('gallery-view');
  const toolbar = document.getElementById('toolbar');
  const main = document.getElementById('main-area');

  main.classList.remove('split-view');
  canvas.style.display = 'none';
  editor.style.display = 'none';
  gallery.style.display = 'none';
  toolbar.style.display = 'none';

  if (v === 'gallery') {
    gallery.style.display = 'block';
    buildGallery();
  } else if (v === 'preview') {
    canvas.style.display = 'flex';
    toolbar.style.display = 'flex';
    renderCurrent();
  } else if (v === 'split') {
    main.classList.add('split-view');
    canvas.style.display = 'flex';
    editor.style.display = 'flex';
    toolbar.style.display = 'flex';
    renderCurrent();
    if (currentAsset && currentAsset.type === 'json') {
      document.getElementById('json-src').value = JSON.stringify(currentAsset.data, null, 2);
    }
  }
}

// ── Gallery ──
function buildGallery() {
  const all = Object.entries(registry).flatMap(([entity, assets]) =>
    assets.map(a => ({...a, entity}))
  );
  const grid = document.getElementById('gallery-grid');
  const empty = document.getElementById('empty-state');

  if (all.length === 0) {
    empty.style.display = 'flex';
    grid.innerHTML = '';
    return;
  }
  empty.style.display = 'none';
  grid.innerHTML = all.map(a => {
    const id = 'thumb-' + a.entity + '-' + a.name.replace(/\W/g, '_');
    return `
      <div class="gallery-card" onclick="selectAssetByPath('${a.entity}','${a.name}')">
        <div class="thumb" id="${id}"></div>
        <div class="info">
          <div class="name">${a.name}</div>
          <div class="type">${a.entity} / ${a.type}</div>
        </div>
      </div>`;
  }).join('');

  // Render thumbnails
  all.forEach(a => {
    const id = 'thumb-' + a.entity + '-' + a.name.replace(/\W/g, '_');
    const el = document.getElementById(id);
    if (!el) return;
    if (a.type === 'json' && a.data) {
      try {
        lottie.loadAnimation({
          container: el, renderer: 'svg', loop: true, autoplay: true,
          animationData: JSON.parse(JSON.stringify(a.data))
        });
      } catch(e) { el.textContent = 'Invalid Lottie'; }
    } else if (a.type === 'svg') {
      el.innerHTML = a.data;
    }
  });
}

// ── Selection & Rendering ──
function selectAsset(entity, index) {
  currentAsset = registry[entity][index];
  updateSidebar();
  if (currentView === 'gallery') showView('preview');
  else renderCurrent();
}

function selectAssetByPath(entity, name) {
  const items = registry[entity] || [];
  const idx = items.findIndex(a => a.name === name);
  if (idx >= 0) selectAsset(entity, idx);
}

function renderCurrent() {
  const el = document.getElementById('preview');
  const fn = document.getElementById('tb-filename');
  const meta = document.getElementById('tb-meta');

  if (lottieAnim) { lottieAnim.destroy(); lottieAnim = null; }
  el.innerHTML = '';

  if (!currentAsset) {
    fn.textContent = '—';
    meta.textContent = '';
    return;
  }

  fn.textContent = currentAsset.name;

  if (currentAsset.type === 'json' && currentAsset.data) {
    const d = currentAsset.data;
    meta.textContent = `${d.w || '?'}x${d.h || '?'} @ ${d.fr || '?'}fps — ${d.op || '?'} frames`;
    try {
      lottieAnim = lottie.loadAnimation({
        container: el, renderer: 'svg', loop: true, autoplay: true,
        animationData: JSON.parse(JSON.stringify(d))
      });
    } catch(e) { el.textContent = 'Render error: ' + e.message; }
  } else if (currentAsset.type === 'svg') {
    meta.textContent = 'SVG';
    el.innerHTML = currentAsset.data;
  }

  if (currentView === 'split' && currentAsset.type === 'json') {
    document.getElementById('json-src').value = JSON.stringify(currentAsset.data, null, 2);
  }
}

function reloadCurrent() { scanAssets(); }

function copyJSON() {
  if (!currentAsset) return;
  const text = currentAsset.type === 'json'
    ? JSON.stringify(currentAsset.data, null, 2)
    : currentAsset.data;
  navigator.clipboard.writeText(text);
  setStatus('Copied to clipboard');
}

// ── Live Edit ──
let liveTimer = null;
function liveUpdate() {
  clearTimeout(liveTimer);
  liveTimer = setTimeout(() => {
    const src = document.getElementById('json-src').value;
    try {
      const data = JSON.parse(src);
      if (currentAsset) {
        currentAsset.data = data;
        renderCurrent();
      }
    } catch(e) {}
  }, 300);
}

// ── File Scanning ──
// We load assets by fetching a manifest or scanning known paths.
// Since this is local, we use a simple approach: assets are loaded
// via loadAsset() calls injected by the CLI workflow, or via
// the manifest file.

async function loadManifest() {
  try {
    const res = await fetch('manifest.json?t=' + Date.now());
    if (!res.ok) return;
    const manifest = await res.json();
    registry = {};
    for (const entry of manifest) {
      if (!registry[entry.entity]) registry[entry.entity] = [];
      try {
        const r = await fetch(entry.path + '?t=' + Date.now());
        const text = await r.text();
        const isJson = entry.path.endsWith('.json');
        registry[entry.entity].push({
          name: entry.name || entry.path.split('/').pop(),
          type: isJson ? 'json' : 'svg',
          path: entry.path,
          data: isJson ? JSON.parse(text) : text
        });
      } catch(e) {}
    }
    updateSidebar();
    if (currentView === 'gallery') buildGallery();
    setStatus('Loaded ' + Object.values(registry).flat().length + ' assets');
  } catch(e) {}
}

function scanAssets() { loadManifest(); }

// ── Direct load (called from CLI-generated script tags or console) ──
window.loadLottie = function(entity, name, data) {
  if (!registry[entity]) registry[entity] = [];
  const existing = registry[entity].findIndex(a => a.name === name);
  const asset = { name, type: 'json', path: `assets/${entity}/${name}`, data };
  if (existing >= 0) registry[entity][existing] = asset;
  else registry[entity].push(asset);
  updateSidebar();
  if (currentView === 'gallery') buildGallery();
  currentAsset = asset;
  if (currentView !== 'gallery') renderCurrent();
  setStatus('Loaded: ' + entity + '/' + name);
};

window.loadSVG = function(entity, name, svgString) {
  if (!registry[entity]) registry[entity] = [];
  const existing = registry[entity].findIndex(a => a.name === name);
  const asset = { name, type: 'svg', path: `assets/${entity}/${name}`, data: svgString };
  if (existing >= 0) registry[entity][existing] = asset;
  else registry[entity].push(asset);
  updateSidebar();
  if (currentView === 'gallery') buildGallery();
  currentAsset = asset;
  if (currentView !== 'gallery') renderCurrent();
  setStatus('Loaded: ' + entity + '/' + name);
};

// ── Status ──
function setStatus(msg) {
  document.getElementById('status-text').textContent = msg;
  setTimeout(() => { document.getElementById('status-text').textContent = 'Ready'; }, 3000);
}

// ── Polling ──
let pollInterval = null;
function startPolling() {
  pollInterval = setInterval(scanAssets, 2000);
}

// ── Init ──
buildSidebar();
scanAssets();
startPolling();
</script>
</body>
</html>
