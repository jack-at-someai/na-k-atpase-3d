<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charlotte Agent — Kollege Klub</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
/* ── Reset & Base ─────────────────────────────────────── */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #232324;
  --surface: #2D2B2E;
  --surface-variant: #3D3B3E;
  --primary: #7200CB;
  --secondary: #F000D2;
  --tertiary: #21D6C6;
  --error: #CE4F51;
  --text-primary: #FFFFFF;
  --text-secondary: #B0B0B0;
  --positive: #21D6C6;
  --negative: #CE4F51;
  --accent-yellow: #EFAE00;

  /* Glass levels */
  --glass-subtle-bg: rgba(255,255,255,0.05);
  --glass-subtle-border: rgba(255,255,255,0.10);
  --glass-standard-bg: rgba(255,255,255,0.10);
  --glass-standard-border: rgba(255,255,255,0.20);
  --glass-frosted-bg: rgba(255,255,255,0.15);
  --glass-frosted-border: rgba(255,255,255,0.25);
  --glass-deep-bg: rgba(255,255,255,0.25);
  --glass-deep-border: rgba(255,255,255,0.30);

  --radius-card: 16px;
  --radius-btn: 12px;
  --radius-input: 12px;
  --radius-chip: 8px;
}

html, body {
  height: 100%;
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text-primary);
  overflow: hidden;
}

h1, h2, h3, h4, h5, h6 {
  font-family: 'Oswald', sans-serif;
}

/* ── Layout Shell ─────────────────────────────────────── */
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  width: 100vw;
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 28px;
  backdrop-filter: blur(24px);
  background: var(--glass-standard-bg);
  border-bottom: 1px solid var(--glass-standard-border);
  z-index: 100;
  flex-shrink: 0;
}

.header-left {
  display: flex;
  align-items: baseline;
  gap: 6px;
}

.header-brand {
  font-family: 'Oswald', sans-serif;
  font-weight: 700;
  font-size: 22px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--text-primary);
  text-shadow: 0 0 20px rgba(114,0,203,0.6), 0 0 40px rgba(114,0,203,0.3);
}

.header-venue {
  font-family: 'Oswald', sans-serif;
  font-weight: 300;
  font-size: 18px;
  color: var(--text-secondary);
  letter-spacing: 1px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-btn {
  width: 38px;
  height: 38px;
  border-radius: var(--radius-btn);
  border: 1px solid var(--glass-standard-border);
  background: var(--glass-subtle-bg);
  backdrop-filter: blur(12px);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  transition: all 0.3s ease;
}

.header-btn:hover {
  background: var(--glass-standard-bg);
  color: var(--text-primary);
}

.header-btn.voice-active {
  color: var(--tertiary);
  border-color: var(--tertiary);
  box-shadow: 0 0 12px rgba(33,214,198,0.4);
  animation: voicePulseBtn 2s infinite;
}

@keyframes voicePulseBtn {
  0%, 100% { box-shadow: 0 0 12px rgba(33,214,198,0.4); }
  50% { box-shadow: 0 0 24px rgba(33,214,198,0.7); }
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--positive);
  box-shadow: 0 0 8px rgba(33,214,198,0.6);
  animation: statusPulse 3s infinite;
}

.status-dot.local { background: var(--accent-yellow); box-shadow: 0 0 8px rgba(239,174,0,0.6); }

@keyframes statusPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ── Main Body ────────────────────────────────────────── */
.main {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* ── Left Panel: Dashboard ────────────────────────────── */
.dashboard {
  flex: 1;
  padding: 20px 24px;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-width: thin;
  scrollbar-color: var(--surface-variant) transparent;
}

.dashboard::-webkit-scrollbar { width: 6px; }
.dashboard::-webkit-scrollbar-track { background: transparent; }
.dashboard::-webkit-scrollbar-thumb { background: var(--surface-variant); border-radius: 3px; }

/* ── Glass Card Base ──────────────────────────────────── */
.glass-card {
  backdrop-filter: blur(24px);
  background: var(--glass-standard-bg);
  border: 1px solid var(--glass-standard-border);
  border-radius: var(--radius-card);
  padding: 20px;
  transition: all 0.3s ease;
}

.glass-card:hover {
  background: var(--glass-frosted-bg);
  border-color: var(--glass-frosted-border);
  box-shadow: 0 4px 30px rgba(0,0,0,0.3);
}

.glass-card.pulse-update {
  animation: cardPulse 0.6s ease;
}

@keyframes cardPulse {
  0% { border-color: var(--glass-standard-border); box-shadow: none; }
  30% { border-color: var(--tertiary); box-shadow: 0 0 20px rgba(33,214,198,0.3); }
  100% { border-color: var(--glass-standard-border); box-shadow: none; }
}

.card-header {
  font-family: 'Oswald', sans-serif;
  font-weight: 500;
  font-size: 13px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-secondary);
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-header i { font-size: 12px; color: var(--primary); }

/* ── Metrics Grid ─────────────────────────────────────── */
.metrics-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  margin-bottom: 16px;
}

.metric-card {
  padding: 18px;
}

.metric-label {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-secondary);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.metric-label i {
  font-size: 11px;
  opacity: 0.7;
}

.metric-value {
  font-family: 'Oswald', sans-serif;
  font-weight: 600;
  font-size: 34px;
  line-height: 1;
  margin-bottom: 6px;
  transition: all 0.4s ease;
}

.metric-change {
  font-size: 12px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 4px;
}

.metric-change.positive { color: var(--positive); }
.metric-change.negative { color: var(--negative); }

.metric-change i { font-size: 10px; }

/* Circular progress for sell-through */
.circular-progress {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.circular-progress svg {
  transform: rotate(-90deg);
}

.circular-progress .metric-value {
  position: absolute;
  font-size: 28px;
}

/* ── Sparkline Chart ──────────────────────────────────── */
.sparkline-section { margin-bottom: 16px; }

.sparkline-container {
  position: relative;
  width: 100%;
  height: 140px;
}

.sparkline-container svg {
  width: 100%;
  height: 100%;
}

.sparkline-tooltip {
  position: absolute;
  background: var(--glass-deep-bg);
  backdrop-filter: blur(40px);
  border: 1px solid var(--glass-frosted-border);
  border-radius: var(--radius-chip);
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 600;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s ease;
  z-index: 10;
}

/* ── Forecast Card ────────────────────────────────────── */
.forecast-section { margin-bottom: 16px; }

.forecast-big {
  font-family: 'Oswald', sans-serif;
  font-weight: 600;
  font-size: 52px;
  line-height: 1;
  margin-bottom: 4px;
}

.forecast-sub {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 16px;
}

.confidence-bar-track {
  width: 100%;
  height: 6px;
  background: var(--surface-variant);
  border-radius: 3px;
  margin-bottom: 4px;
  overflow: hidden;
}

.confidence-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--tertiary));
  border-radius: 3px;
  transition: width 1s ease;
}

.confidence-label {
  font-size: 11px;
  color: var(--text-secondary);
  margin-bottom: 16px;
}

.staffing-row {
  display: flex;
  gap: 16px;
  margin-bottom: 18px;
}

.staffing-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--text-secondary);
}

.staffing-item i { color: var(--tertiary); font-size: 14px; }
.staffing-item strong { color: var(--text-primary); font-weight: 600; }

.drink-predictions {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.drink-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.drink-name {
  font-size: 12px;
  font-weight: 500;
  width: 80px;
  flex-shrink: 0;
  color: var(--text-secondary);
}

.drink-bar-track {
  flex: 1;
  height: 8px;
  background: var(--surface-variant);
  border-radius: 4px;
  overflow: hidden;
}

.drink-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 1s ease;
}

.drink-bar-fill.beer { background: var(--accent-yellow); }
.drink-bar-fill.bourbon { background: var(--primary); }
.drink-bar-fill.vodka { background: var(--tertiary); }

.drink-count {
  font-size: 12px;
  font-weight: 600;
  width: 36px;
  text-align: right;
  flex-shrink: 0;
}

/* ── Protocols Card ───────────────────────────────────── */
.protocols-section { margin-bottom: 16px; }

.protocol-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.protocol-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.protocol-item:last-child { border-bottom: none; }

.protocol-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.protocol-dot.active { background: var(--tertiary); box-shadow: 0 0 6px rgba(33,214,198,0.5); }
.protocol-dot.inactive { background: var(--surface-variant); }

.protocol-info { flex: 1; min-width: 0; }

.protocol-name {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.protocol-trigger {
  font-size: 11px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.protocol-toggle {
  width: 36px;
  height: 20px;
  border-radius: 10px;
  background: var(--surface-variant);
  position: relative;
  cursor: pointer;
  flex-shrink: 0;
  transition: background 0.3s ease;
}

.protocol-toggle.on { background: var(--tertiary); }

.protocol-toggle::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: white;
  transition: transform 0.3s ease;
}

.protocol-toggle.on::after { transform: translateX(16px); }

/* ── Signals Feed ─────────────────────────────────────── */
.signals-section { margin-bottom: 16px; }

.signal-list {
  display: flex;
  flex-direction: column;
  gap: 2px;
  max-height: 200px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--surface-variant) transparent;
}

.signal-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 8px 4px;
  border-radius: var(--radius-chip);
  transition: background 0.2s ease;
}

.signal-item:hover { background: rgba(255,255,255,0.03); }

.signal-item.new-signal {
  animation: signalSlideIn 0.4s ease;
}

@keyframes signalSlideIn {
  from { opacity: 0; transform: translateY(-12px); }
  to { opacity: 1; transform: translateY(0); }
}

.signal-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
  margin-top: 5px;
}

.signal-dot.purchase { background: var(--primary); box-shadow: 0 0 6px rgba(114,0,203,0.5); }
.signal-dot.check-in { background: var(--tertiary); box-shadow: 0 0 6px rgba(33,214,198,0.5); }
.signal-dot.campaign { background: var(--secondary); box-shadow: 0 0 6px rgba(240,0,210,0.5); }
.signal-dot.price { background: var(--accent-yellow); box-shadow: 0 0 6px rgba(239,174,0,0.5); }

.signal-text {
  flex: 1;
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.4;
}

.signal-time {
  font-size: 10px;
  color: var(--surface-variant);
  flex-shrink: 0;
  margin-top: 3px;
  min-width: 55px;
  text-align: right;
}

/* ── Right Panel: Chat ────────────────────────────────── */
.chat-panel {
  width: 420px;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  border-left: 1px solid var(--glass-subtle-border);
  backdrop-filter: blur(12px);
  background: var(--glass-subtle-bg);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  scrollbar-width: thin;
  scrollbar-color: var(--surface-variant) transparent;
}

.chat-messages::-webkit-scrollbar { width: 4px; }
.chat-messages::-webkit-scrollbar-track { background: transparent; }
.chat-messages::-webkit-scrollbar-thumb { background: var(--surface-variant); border-radius: 2px; }

/* ── Chat Bubbles ─────────────────────────────────────── */
.msg {
  max-width: 92%;
  animation: msgIn 0.35s ease;
}

@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.charlotte { align-self: flex-start; }
.msg.user { align-self: flex-end; }
.msg.system { align-self: center; }

.msg-label {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.msg.charlotte .msg-label { color: var(--primary); }
.msg.charlotte .msg-label::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--primary);
  box-shadow: 0 0 6px rgba(114,0,203,0.6);
}

.msg.user .msg-label {
  color: var(--text-secondary);
  justify-content: flex-end;
}

.msg-bubble {
  padding: 12px 16px;
  border-radius: var(--radius-card);
  font-size: 13.5px;
  line-height: 1.55;
}

.msg.charlotte .msg-bubble {
  background: rgba(114,0,203,0.15);
  border: 1px solid rgba(114,0,203,0.25);
  backdrop-filter: blur(12px);
}

.msg.user .msg-bubble {
  background: var(--surface);
  border: 1px solid var(--glass-subtle-border);
}

.msg.system .msg-bubble {
  background: transparent;
  font-size: 12px;
  color: var(--text-secondary);
  padding: 6px 12px;
}

/* Action cards */
.msg-action {
  max-width: 92%;
  align-self: flex-start;
  animation: actionIn 0.4s ease;
}

@keyframes actionIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.action-card {
  background: var(--glass-subtle-bg);
  backdrop-filter: blur(24px);
  border: 1px solid var(--tertiary);
  border-radius: var(--radius-card);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.action-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: rgba(33,214,198,0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--tertiary);
  font-size: 15px;
  flex-shrink: 0;
}

.action-content { flex: 1; }

.action-title {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 2px;
}

.action-detail {
  font-size: 11px;
  color: var(--text-secondary);
}

/* Thinking indicator */
.thinking-dots {
  display: flex;
  gap: 5px;
  padding: 4px 0;
}

.thinking-dots span {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--primary);
  animation: dotBounce 1.2s ease-in-out infinite;
}

.thinking-dots span:nth-child(2) { animation-delay: 0.15s; }
.thinking-dots span:nth-child(3) { animation-delay: 0.3s; }

@keyframes dotBounce {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-8px); opacity: 1; }
}

/* ── Quick Action Chips ───────────────────────────────── */
.quick-actions {
  display: flex;
  gap: 8px;
  padding: 10px 20px;
  overflow-x: auto;
  flex-shrink: 0;
  scrollbar-width: none;
}

.quick-actions::-webkit-scrollbar { display: none; }

.chip {
  white-space: nowrap;
  padding: 7px 14px;
  border-radius: var(--radius-chip);
  border: 1px solid var(--glass-standard-border);
  background: var(--glass-subtle-bg);
  backdrop-filter: blur(12px);
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.25s ease;
  flex-shrink: 0;
}

.chip:hover {
  background: var(--glass-standard-bg);
  border-color: var(--primary);
  color: var(--text-primary);
}

/* ── Chat Input ───────────────────────────────────────── */
.chat-input-area {
  padding: 14px 20px 16px;
  flex-shrink: 0;
}

.chat-input-row {
  display: flex;
  align-items: center;
  gap: 10px;
  backdrop-filter: blur(24px);
  background: var(--glass-standard-bg);
  border: 1px solid var(--glass-standard-border);
  border-radius: var(--radius-input);
  padding: 6px 8px;
  transition: border-color 0.3s ease;
}

.chat-input-row:focus-within {
  border-color: var(--primary);
  box-shadow: 0 0 12px rgba(114,0,203,0.2);
}

.mic-btn {
  width: 36px;
  height: 36px;
  border: none;
  border-radius: 10px;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  transition: all 0.3s ease;
  position: relative;
  flex-shrink: 0;
}

.mic-btn:hover { color: var(--tertiary); }

.mic-btn.active {
  color: var(--tertiary);
}

.mic-btn.active::before {
  content: '';
  position: absolute;
  inset: -4px;
  border-radius: 14px;
  border: 2px solid var(--tertiary);
  animation: micRing 1.8s ease-in-out infinite;
}

.mic-btn.active::after {
  content: '';
  position: absolute;
  inset: -10px;
  border-radius: 18px;
  border: 1px solid rgba(33,214,198,0.3);
  animation: micRing 1.8s ease-in-out infinite 0.3s;
}

@keyframes micRing {
  0%, 100% { opacity: 0.3; transform: scale(0.9); }
  50% { opacity: 1; transform: scale(1); }
}

.chat-input {
  flex: 1;
  border: none;
  background: transparent;
  color: var(--text-primary);
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  outline: none;
}

.chat-input::placeholder { color: var(--surface-variant); }

.send-btn {
  width: 36px;
  height: 36px;
  border: none;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.send-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 16px rgba(114,0,203,0.4);
}

.send-btn:active { transform: scale(0.96); }

/* ── Footer Status ────────────────────────────────────── */
.footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 28px;
  backdrop-filter: blur(12px);
  background: var(--glass-subtle-bg);
  border-top: 1px solid var(--glass-subtle-border);
  font-size: 11px;
  color: var(--text-secondary);
  flex-shrink: 0;
}

.footer-left { display: flex; gap: 6px; }
.footer-center { opacity: 0.6; }
.footer-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ── Stagger Fade In ──────────────────────────────────── */
.stagger-in {
  opacity: 0;
  transform: translateY(12px);
  animation: staggerFade 0.5s ease forwards;
}

@keyframes staggerFade {
  to { opacity: 1; transform: translateY(0); }
}

/* ── Mobile Responsive ────────────────────────────────── */
@media (max-width: 768px) {
  .main {
    flex-direction: column;
  }

  .dashboard {
    flex: none;
    max-height: 45vh;
    overflow-y: auto;
  }

  .metrics-grid {
    display: flex;
    overflow-x: auto;
    gap: 12px;
    padding-bottom: 8px;
    scrollbar-width: none;
  }

  .metrics-grid::-webkit-scrollbar { display: none; }

  .metrics-grid .glass-card {
    min-width: 160px;
    flex-shrink: 0;
  }

  .chat-panel {
    width: 100%;
    flex: 1;
    border-left: none;
    border-top: 1px solid var(--glass-subtle-border);
  }

  .header { padding: 10px 16px; }
  .header-brand { font-size: 18px; letter-spacing: 2px; }
  .header-venue { font-size: 14px; }
  .dashboard { padding: 14px 16px; }
}

/* ── Utility ──────────────────────────────────────────── */
.hidden { display: none !important; }
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <span class="header-brand">Charlotte</span>
      <span class="header-venue">&middot; Kollege Klub</span>
    </div>
    <div class="header-right">
      <button class="header-btn" id="voiceToggle" title="Toggle voice mode">
        <i class="fa-solid fa-microphone"></i>
      </button>
      <button class="header-btn" id="statusBtn" title="Connection status">
        <i class="fa-solid fa-bolt"></i>
      </button>
      <div class="status-dot" id="statusDot"></div>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Left: Dashboard -->
    <div class="dashboard" id="dashboard">

      <!-- Metric Cards -->
      <div class="metrics-grid">
        <div class="glass-card metric-card stagger-in" style="animation-delay: 0.1s" id="metricRevenue">
          <div class="metric-label"><i class="fa-solid fa-dollar-sign"></i> Revenue Today</div>
          <div class="metric-value" id="valRevenue">$4,250</div>
          <div class="metric-change positive" id="changeRevenue"><i class="fa-solid fa-arrow-up"></i> <span>12% vs yesterday</span></div>
        </div>
        <div class="glass-card metric-card stagger-in" style="animation-delay: 0.2s" id="metricCovers">
          <div class="metric-label"><i class="fa-solid fa-users"></i> Covers Today</div>
          <div class="metric-value" id="valCovers">187</div>
          <div class="metric-change positive" id="changeCovers"><i class="fa-solid fa-arrow-up"></i> <span>8% vs yesterday</span></div>
        </div>
        <div class="glass-card metric-card stagger-in" style="animation-delay: 0.3s" id="metricSellThrough">
          <div class="metric-label"><i class="fa-solid fa-forward"></i> Sell-Through</div>
          <div class="metric-value" id="valSellThrough">94%</div>
          <div class="metric-change positive" id="changeSellThrough"><i class="fa-solid fa-arrow-up"></i> <span>+6pts</span></div>
        </div>
        <div class="glass-card metric-card stagger-in" style="animation-delay: 0.4s" id="metricAvgSpend">
          <div class="metric-label"><i class="fa-solid fa-receipt"></i> Per Customer</div>
          <div class="metric-value" id="valAvgSpend">$22.70</div>
          <div class="metric-change positive" id="changeAvgSpend"><i class="fa-solid fa-arrow-up"></i> <span>$1.20 vs avg</span></div>
        </div>
      </div>

      <!-- Revenue Sparkline -->
      <div class="glass-card sparkline-section stagger-in" style="animation-delay: 0.5s">
        <div class="card-header"><i class="fa-solid fa-chart-line"></i> 7-Day Revenue</div>
        <div class="sparkline-container" id="sparklineContainer">
          <svg id="sparklineSvg" viewBox="0 0 500 130" preserveAspectRatio="none"></svg>
          <div class="sparkline-tooltip" id="sparklineTooltip"></div>
        </div>
      </div>

      <!-- Tonight's Forecast -->
      <div class="glass-card forecast-section stagger-in" style="animation-delay: 0.6s">
        <div class="card-header"><i class="fa-solid fa-cloud-sun"></i> Tonight's Forecast</div>
        <div class="forecast-big" id="forecastCovers">245</div>
        <div class="forecast-sub">predicted covers &mdash; 15% above Thursday avg</div>
        <div class="confidence-bar-track">
          <div class="confidence-bar-fill" id="confidenceBar" style="width: 0%"></div>
        </div>
        <div class="confidence-label">Confidence: <strong id="confidenceVal">82%</strong></div>
        <div class="staffing-row">
          <div class="staffing-item"><i class="fa-solid fa-martini-glass"></i> <strong>3</strong> bartenders</div>
          <div class="staffing-item"><i class="fa-solid fa-door-open"></i> <strong>2</strong> door</div>
        </div>
        <div class="card-header" style="margin-top: 4px;"><i class="fa-solid fa-glass-water"></i> Top Predicted Drinks</div>
        <div class="drink-predictions">
          <div class="drink-row">
            <div class="drink-name">Beer</div>
            <div class="drink-bar-track"><div class="drink-bar-fill beer" id="drinkBeer" style="width: 0%"></div></div>
            <div class="drink-count" id="drinkBeerCount">340</div>
          </div>
          <div class="drink-row">
            <div class="drink-name">Bourbon</div>
            <div class="drink-bar-track"><div class="drink-bar-fill bourbon" id="drinkBourbon" style="width: 0%"></div></div>
            <div class="drink-count" id="drinkBourbonCount">120</div>
          </div>
          <div class="drink-row">
            <div class="drink-name">Vodka Soda</div>
            <div class="drink-bar-track"><div class="drink-bar-fill vodka" id="drinkVodka" style="width: 0%"></div></div>
            <div class="drink-count" id="drinkVodkaCount">95</div>
          </div>
        </div>
      </div>

      <!-- Active Protocols -->
      <div class="glass-card protocols-section stagger-in" style="animation-delay: 0.7s">
        <div class="card-header"><i class="fa-solid fa-bolt"></i> Active Protocols</div>
        <div class="protocol-list" id="protocolList"></div>
      </div>

      <!-- Signal Feed -->
      <div class="glass-card signals-section stagger-in" style="animation-delay: 0.8s">
        <div class="card-header"><i class="fa-solid fa-signal"></i> Signal Feed</div>
        <div class="signal-list" id="signalList"></div>
      </div>

    </div>

    <!-- Right: Chat -->
    <div class="chat-panel">
      <div class="chat-messages" id="chatMessages"></div>
      <div class="quick-actions" id="quickActions">
        <div class="chip" data-msg="Tonight's forecast">Tonight's forecast</div>
        <div class="chip" data-msg="Raise prices">Raise prices</div>
        <div class="chip" data-msg="Send a push">Send a push</div>
        <div class="chip" data-msg="Weekly report">Weekly report</div>
        <div class="chip" data-msg="Top drinks">Top drinks</div>
        <div class="chip" data-msg="Staffing">Staffing</div>
      </div>
      <div class="chat-input-area">
        <div class="chat-input-row">
          <button class="mic-btn" id="micBtn"><i class="fa-solid fa-microphone"></i></button>
          <input class="chat-input" id="chatInput" type="text" placeholder="Talk to Charlotte..." autocomplete="off">
          <button class="send-btn" id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="footer-left" id="footerLeft">SUBSTRATE: 214 facts &middot; 6 protocols &middot; 42 signals</div>
    <div class="footer-center">Charlotte v1.0 &middot; Kollege Klub, Madison WI</div>
    <div class="footer-right">
      <div class="status-dot" style="width:6px;height:6px;"></div>
      <span id="footerTime"></span>
    </div>
  </div>
</div>

<script>
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Charlotte Bar Agent — Frontend Controller
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

(() => {
'use strict';

// ── State ─────────────────────────────────────────────────
const state = {
  voiceMode: false,
  listening: false,
  metrics: {
    revenue: 4250,
    covers: 187,
    sellThrough: 94,
    avgSpend: 22.70,
    revenueChange: { pct: 12, dir: 'up' },
    coversChange: { pct: 8, dir: 'up' },
    sellThroughChange: { pts: 6, dir: 'up' },
    avgSpendChange: { val: 1.20, dir: 'up' },
  },
  sparklineData: [3100, 3800, 2900, 4100, 3600, 4800, 4250],
  sparklineLabels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
  forecast: { covers: 245, confidence: 82, bartenders: 3, door: 2 },
  drinks: { beer: 340, bourbon: 120, vodka: 95 },
  protocols: [
    { name: 'Dynamic LineSkip Pricing', trigger: 'Adjusts price based on demand curve', active: true },
    { name: 'Capacity Gate Control', trigger: 'Triggers at 85% venue capacity', active: true },
    { name: 'VIP Fast-Track', trigger: 'Auto-upgrades repeat customers', active: true },
    { name: 'Happy Hour Wind-Down', trigger: 'Tapers discounts before peak', active: false },
    { name: 'Push Notification Blast', trigger: 'Sends to opted-in within 2 mi radius', active: true },
    { name: 'Staff Alert Escalation', trigger: 'Notifies manager on anomaly', active: true },
  ],
  signals: [
    { type: 'purchase', text: "User 'Alex M.' purchased LineSkip — $13.00", time: '2 min ago' },
    { type: 'check-in', text: "VIP 'Sarah K.' checked in — 4th visit this month", time: '5 min ago' },
    { type: 'price', text: "LineSkip price adjusted $12 → $13 (demand surge)", time: '8 min ago' },
    { type: 'purchase', text: "User 'Jake R.' purchased LineSkip — $13.00", time: '12 min ago' },
    { type: 'campaign', text: "Push campaign 'Thursday Vibes' sent to 847 users", time: '18 min ago' },
    { type: 'check-in', text: "Group of 6 checked in via QR scan", time: '22 min ago' },
    { type: 'purchase', text: "User 'Mia L.' purchased 2x LineSkip — $26.00", time: '25 min ago' },
    { type: 'check-in', text: "Staff member 'Tyler' clocked in (bartender)", time: '30 min ago' },
    { type: 'price', text: "Dynamic pricing activated — base $12 for evening", time: '45 min ago' },
    { type: 'campaign', text: "Geo-fence trigger: 23 users entered 2-mile radius", time: '1 hr ago' },
  ],
  factCount: 214,
  signalCount: 42,
  isOnline: false,
};

// ── DOM Refs ──────────────────────────────────────────────
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

const chatMessages = $('#chatMessages');
const chatInput = $('#chatInput');
const sendBtn = $('#sendBtn');
const micBtn = $('#micBtn');
const voiceToggle = $('#voiceToggle');
const statusDot = $('#statusDot');

// ── Utilities ─────────────────────────────────────────────
function formatCurrency(n) {
  return '$' + n.toLocaleString('en-US', { minimumFractionDigits: n % 1 === 0 ? 0 : 2, maximumFractionDigits: 2 });
}

function animateValue(el, start, end, duration, formatter) {
  const startTime = performance.now();
  const update = (now) => {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
    const current = start + (end - start) * eased;
    el.textContent = formatter ? formatter(current) : Math.round(current).toString();
    if (progress < 1) requestAnimationFrame(update);
  };
  requestAnimationFrame(update);
}

function pulseCard(el) {
  el.classList.remove('pulse-update');
  void el.offsetWidth; // force reflow
  el.classList.add('pulse-update');
}

// ── Render Protocols ──────────────────────────────────────
function renderProtocols() {
  const container = $('#protocolList');
  container.innerHTML = '';
  state.protocols.forEach((p, i) => {
    const item = document.createElement('div');
    item.className = 'protocol-item';
    item.innerHTML = `
      <div class="protocol-dot ${p.active ? 'active' : 'inactive'}"></div>
      <div class="protocol-info">
        <div class="protocol-name">${p.name}</div>
        <div class="protocol-trigger">${p.trigger}</div>
      </div>
      <div class="protocol-toggle ${p.active ? 'on' : ''}" data-idx="${i}"></div>
    `;
    container.appendChild(item);
  });
  // Toggle clicks (visual only)
  container.querySelectorAll('.protocol-toggle').forEach(tog => {
    tog.addEventListener('click', () => {
      const idx = parseInt(tog.dataset.idx);
      state.protocols[idx].active = !state.protocols[idx].active;
      renderProtocols();
    });
  });
}

// ── Render Signals ────────────────────────────────────────
function renderSignals(animate) {
  const container = $('#signalList');
  container.innerHTML = '';
  state.signals.slice(0, 10).forEach((s, i) => {
    const item = document.createElement('div');
    item.className = 'signal-item' + (animate && i === 0 ? ' new-signal' : '');
    item.innerHTML = `
      <div class="signal-dot ${s.type}"></div>
      <div class="signal-text">${s.text}</div>
      <div class="signal-time">${s.time}</div>
    `;
    container.appendChild(item);
  });
}

// ── Sparkline Chart ───────────────────────────────────────
function renderSparkline() {
  const svg = $('#sparklineSvg');
  const data = state.sparklineData;
  const labels = state.sparklineLabels;
  const tooltip = $('#sparklineTooltip');
  const container = $('#sparklineContainer');
  const w = 500, h = 130;
  const padX = 30, padY = 20;
  const min = Math.min(...data) * 0.85;
  const max = Math.max(...data) * 1.05;

  const points = data.map((v, i) => ({
    x: padX + (i / (data.length - 1)) * (w - 2 * padX),
    y: padY + (1 - (v - min) / (max - min)) * (h - 2 * padY),
    val: v,
    label: labels[i],
  }));

  // Gradient definition
  let svgContent = `
    <defs>
      <linearGradient id="sparkGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#21D6C6" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="#21D6C6" stop-opacity="0"/>
      </linearGradient>
    </defs>
  `;

  // Area fill
  const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x},${p.y}`).join(' ');
  const areaD = pathD + ` L${points[points.length - 1].x},${h - padY + 5} L${points[0].x},${h - padY + 5} Z`;
  svgContent += `<path d="${areaD}" fill="url(#sparkGrad)"/>`;

  // Line
  svgContent += `<path d="${pathD}" fill="none" stroke="#21D6C6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>`;

  // Dots and labels
  points.forEach((p) => {
    svgContent += `<circle cx="${p.x}" cy="${p.y}" r="4" fill="#232324" stroke="#21D6C6" stroke-width="2"/>`;
    svgContent += `<text x="${p.x}" y="${h - 4}" text-anchor="middle" fill="#B0B0B0" font-size="10" font-family="Inter, sans-serif">${p.label}</text>`;
  });

  // Invisible hover zones
  points.forEach((p, i) => {
    svgContent += `<rect x="${p.x - 25}" y="0" width="50" height="${h}" fill="transparent" class="spark-hover" data-idx="${i}"/>`;
  });

  svg.innerHTML = svgContent;

  // Tooltip interaction
  svg.querySelectorAll('.spark-hover').forEach(rect => {
    rect.addEventListener('mouseenter', (e) => {
      const idx = parseInt(rect.dataset.idx);
      const pt = points[idx];
      tooltip.textContent = `${pt.label}: ${formatCurrency(pt.val)}`;
      const containerRect = container.getBoundingClientRect();
      const svgRect = svg.getBoundingClientRect();
      const scaleX = svgRect.width / w;
      const scaleY = svgRect.height / h;
      tooltip.style.left = (pt.x * scaleX - 30) + 'px';
      tooltip.style.top = (pt.y * scaleY - 32) + 'px';
      tooltip.style.opacity = '1';
    });
    rect.addEventListener('mouseleave', () => {
      tooltip.style.opacity = '0';
    });
  });
}

// ── Render Drink Bars ─────────────────────────────────────
function renderDrinkBars() {
  const maxDrink = Math.max(state.drinks.beer, state.drinks.bourbon, state.drinks.vodka);
  setTimeout(() => {
    $('#drinkBeer').style.width = (state.drinks.beer / maxDrink * 100) + '%';
    $('#drinkBourbon').style.width = (state.drinks.bourbon / maxDrink * 100) + '%';
    $('#drinkVodka').style.width = (state.drinks.vodka / maxDrink * 100) + '%';
  }, 300);
  $('#drinkBeerCount').textContent = state.drinks.beer;
  $('#drinkBourbonCount').textContent = state.drinks.bourbon;
  $('#drinkVodkaCount').textContent = state.drinks.vodka;
}

// ── Render Confidence Bar ─────────────────────────────────
function renderConfidence() {
  setTimeout(() => {
    $('#confidenceBar').style.width = state.forecast.confidence + '%';
  }, 400);
  $('#confidenceVal').textContent = state.forecast.confidence + '%';
}

// ── Chat: Add Message ─────────────────────────────────────
function addMessage(type, content) {
  // type: 'charlotte', 'user', 'system', 'action'
  const div = document.createElement('div');

  if (type === 'action') {
    div.className = 'msg-action';
    div.innerHTML = `
      <div class="action-card">
        <div class="action-icon"><i class="fa-solid ${content.icon || 'fa-bolt'}"></i></div>
        <div class="action-content">
          <div class="action-title">${content.title}</div>
          <div class="action-detail">${content.detail}</div>
        </div>
      </div>
    `;
  } else {
    div.className = `msg ${type}`;
    const labelText = type === 'charlotte' ? 'Charlotte' : type === 'user' ? 'You' : '';
    div.innerHTML = `
      ${labelText ? `<div class="msg-label">${labelText}</div>` : ''}
      <div class="msg-bubble">${type === 'system' ? content : ''}</div>
    `;
    if (type === 'charlotte') {
      // Typing animation
      const bubble = div.querySelector('.msg-bubble');
      bubble.textContent = '';
      let i = 0;
      const speed = 8;
      const typeChar = () => {
        if (i < content.length) {
          bubble.textContent += content[i];
          i++;
          chatMessages.scrollTop = chatMessages.scrollHeight;
          setTimeout(typeChar, speed);
        } else {
          // Speak if voice mode
          if (state.voiceMode) speakText(content);
        }
      };
      setTimeout(typeChar, 100);
    } else if (type === 'user') {
      div.querySelector('.msg-bubble').textContent = content;
    }
  }

  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return div;
}

function addThinking() {
  const div = document.createElement('div');
  div.className = 'msg charlotte';
  div.id = 'thinkingMsg';
  div.innerHTML = `
    <div class="msg-label">Charlotte</div>
    <div class="msg-bubble">
      <div class="thinking-dots"><span></span><span></span><span></span></div>
    </div>
  `;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return div;
}

function removeThinking() {
  const el = $('#thinkingMsg');
  if (el) el.remove();
}

// ── Chat: Agent Response Engine ───────────────────────────
// Since the backend may not be running, we have a local agent brain
const agentResponses = {
  "tonight's forecast": {
    text: "Tonight is shaping up strong. I'm projecting 245 covers with 82% confidence, which is 15% above your typical Thursday. LineSkip pre-sales are at 47, and we have 12 VIP reservations.\n\nBeer is the top predicted pour at 340 units, followed by bourbon at 120 and vodka soda at 95. I'd recommend staffing 3 bartenders and 2 at the door.\n\nThe dynamic pricing protocol has already adjusted LineSkip to $13 based on tonight's demand curve.",
    actions: [],
  },
  "raise prices": {
    text: "Done. I've bumped LineSkip pricing from $13 to $15 based on current demand velocity. Sell-through is at 94%, so there's room to capture more. I'll auto-revert if sell-through drops below 80%.\n\nEstimated additional revenue from this adjustment: $180-$240 over the next 2 hours.",
    actions: [
      { icon: 'fa-arrow-up', title: 'LineSkip Price Updated', detail: '$13 → $15 — Dynamic pricing protocol triggered' },
    ],
    metricUpdates: {
      avgSpend: 24.10,
      avgSpendChange: { val: 2.60, dir: 'up' },
    },
    newSignals: [
      { type: 'price', text: 'LineSkip price adjusted $13 → $15 (manual override + demand)', time: 'just now' },
    ],
  },
  "send a push": {
    text: "Push notification sent to 1,247 opted-in users within a 2-mile radius of Kollege Klub.\n\nMessage: \"Thursday Night at KK — LineSkip available, skip the line for $15. Live DJ starts at 10.\"\n\nBased on past campaigns, I'd expect a 6-8% conversion rate, which could drive 75-100 additional walk-ins over the next 90 minutes.",
    actions: [
      { icon: 'fa-bell', title: 'Push Campaign Sent', detail: '"Thursday Night at KK" — 1,247 recipients within 2mi radius' },
    ],
    newSignals: [
      { type: 'campaign', text: "Push campaign 'Thursday Night at KK' sent to 1,247 users", time: 'just now' },
    ],
    footerUpdate: { signals: 43 },
  },
  "weekly report": {
    text: "Here's your week at a glance, Jordan:\n\nTotal revenue: $27,840 (+11% vs last week)\nTotal covers: 1,342 (+8%)\nLineSkip revenue: $8,410 (30% of total)\nTop night: Saturday — $6,200, 312 covers\nAvg LineSkip price: $12.80\nPush campaign conversions: 14.2% avg\n\nYour strongest growth is in LineSkip adoption — sell-through has increased 6 points over the last month. I'd recommend experimenting with tiered pricing ($10/$15/$20) next weekend to capture the full demand curve.",
    actions: [],
  },
  "top drinks": {
    text: "Here's tonight's drink leaderboard so far:\n\n1. Bud Light — 89 pours\n2. Miller Lite — 67 pours\n3. Bourbon & Coke — 43 pours\n4. Vodka Soda — 38 pours\n5. Tequila Sunrise — 24 pours\n\nBeer is dominant at 68% of total pours. Bourbon is trending up 15% vs last Thursday. I'd flag that your Tito's inventory might run low if vodka soda demand spikes during peak hours — you have about 4 bottles left.",
    actions: [],
  },
  "staffing": {
    text: "Current staffing for tonight:\n\nBartenders: 3 (Tyler, Jess, Marco) — optimal for projected volume\nDoor: 2 (Dave, Kim) — sufficient through midnight\nBarback: 1 (Eli) — could use a second after 11pm\n\nBased on the demand forecast of 245 covers, you're well-staffed until 11pm. After that, I'd recommend calling in one additional barback. Historical data shows a 20% service speed drop when cover count exceeds 200 with only one barback.\n\nWant me to send a shift alert to your on-call list?",
    actions: [],
  },
};

function findBestResponse(input) {
  const lower = input.toLowerCase().trim();
  // Direct match
  if (agentResponses[lower]) return agentResponses[lower];

  // Keyword matching
  const keywords = {
    'forecast': "tonight's forecast",
    'tonight': "tonight's forecast",
    'predict': "tonight's forecast",
    'price': 'raise prices',
    'raise': 'raise prices',
    'pricing': 'raise prices',
    'push': 'send a push',
    'notification': 'send a push',
    'campaign': 'send a push',
    'blast': 'send a push',
    'weekly': 'weekly report',
    'report': 'weekly report',
    'summary': 'weekly report',
    'drink': 'top drinks',
    'pour': 'top drinks',
    'beer': 'top drinks',
    'bourbon': 'top drinks',
    'vodka': 'top drinks',
    'staff': 'staffing',
    'bartend': 'staffing',
    'door': 'staffing',
    'schedule': 'staffing',
  };

  for (const [kw, key] of Object.entries(keywords)) {
    if (lower.includes(kw)) return agentResponses[key];
  }

  // Fallback
  return {
    text: `I understand you're asking about "${input}". Right now I'm running in local demo mode, so I can help with: tonight's forecast, pricing, push campaigns, weekly reports, top drinks, and staffing.\n\nIn production, I'd have full access to every signal in your substrate — every check-in, purchase, and environmental reading in real time. Try asking about one of those topics to see me in action.`,
    actions: [],
  };
}

async function handleSend(text) {
  if (!text.trim()) return;
  addMessage('user', text);
  chatInput.value = '';

  const thinking = addThinking();

  // Try backend first, fall back to local
  let response;
  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text }),
    });
    if (res.ok) {
      response = await res.json();
      state.isOnline = true;
      statusDot.classList.remove('local');
    } else {
      throw new Error('Not OK');
    }
  } catch {
    state.isOnline = false;
    statusDot.classList.add('local');
    response = findBestResponse(text);
  }

  // Simulate thinking delay
  await new Promise(r => setTimeout(r, 800 + Math.random() * 600));
  removeThinking();

  // Display response
  addMessage('charlotte', response.text);

  // Actions
  if (response.actions && response.actions.length > 0) {
    response.actions.forEach((a, i) => {
      setTimeout(() => addMessage('action', a), 400 + i * 300);
    });
  }

  // Metric updates
  if (response.metricUpdates) {
    setTimeout(() => applyMetricUpdates(response.metricUpdates), 600);
  }

  // New signals
  if (response.newSignals) {
    response.newSignals.forEach(s => state.signals.unshift(s));
    state.signalCount += response.newSignals.length;
    setTimeout(() => renderSignals(true), 800);
  }

  // Footer update
  if (response.footerUpdate) {
    if (response.footerUpdate.signals) state.signalCount = response.footerUpdate.signals;
    updateFooter();
  }

  // Refresh metrics from backend
  try {
    const mRes = await fetch('/api/metrics');
    if (mRes.ok) {
      const mData = await mRes.json();
      applyMetricUpdates(mData);
    }
  } catch { /* local mode */ }
}

function applyMetricUpdates(updates) {
  if (updates.revenue !== undefined) {
    const old = state.metrics.revenue;
    state.metrics.revenue = updates.revenue;
    animateValue($('#valRevenue'), old, updates.revenue, 600, formatCurrency);
    pulseCard($('#metricRevenue'));
  }
  if (updates.covers !== undefined) {
    const old = state.metrics.covers;
    state.metrics.covers = updates.covers;
    animateValue($('#valCovers'), old, updates.covers, 600);
    pulseCard($('#metricCovers'));
  }
  if (updates.sellThrough !== undefined) {
    const old = state.metrics.sellThrough;
    state.metrics.sellThrough = updates.sellThrough;
    animateValue($('#valSellThrough'), old, updates.sellThrough, 600, v => Math.round(v) + '%');
    pulseCard($('#metricSellThrough'));
  }
  if (updates.avgSpend !== undefined) {
    const old = state.metrics.avgSpend;
    state.metrics.avgSpend = updates.avgSpend;
    animateValue($('#valAvgSpend'), old, updates.avgSpend, 600, formatCurrency);
    pulseCard($('#metricAvgSpend'));
  }
  // Change indicators
  if (updates.revenueChange) {
    const el = $('#changeRevenue');
    const d = updates.revenueChange;
    el.className = 'metric-change ' + (d.dir === 'up' ? 'positive' : 'negative');
    el.innerHTML = `<i class="fa-solid fa-arrow-${d.dir}"></i> <span>${d.pct}% vs yesterday</span>`;
  }
  if (updates.avgSpendChange) {
    const el = $('#changeAvgSpend');
    const d = updates.avgSpendChange;
    el.className = 'metric-change ' + (d.dir === 'up' ? 'positive' : 'negative');
    el.innerHTML = `<i class="fa-solid fa-arrow-${d.dir}"></i> <span>${formatCurrency(d.val)} vs avg</span>`;
  }
}

// ── Voice: Speech Recognition ─────────────────────────────
let recognition = null;
let speechTimeout = null;

function initSpeechRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return null;

  const rec = new SpeechRecognition();
  rec.continuous = true;
  rec.interimResults = true;
  rec.lang = 'en-US';

  rec.onresult = (event) => {
    let transcript = '';
    let isFinal = false;
    for (let i = event.resultIndex; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript;
      if (event.results[i].isFinal) isFinal = true;
    }
    chatInput.value = transcript;

    // Auto-send after 1.5s pause on final result
    clearTimeout(speechTimeout);
    if (isFinal) {
      speechTimeout = setTimeout(() => {
        if (chatInput.value.trim()) {
          handleSend(chatInput.value.trim());
          chatInput.value = '';
        }
      }, 1500);
    }
  };

  rec.onerror = (e) => {
    console.warn('Speech recognition error:', e.error);
    stopListening();
  };

  rec.onend = () => {
    // Restart if still in voice mode
    if (state.listening) {
      try { rec.start(); } catch {}
    }
  };

  return rec;
}

function startListening() {
  if (!recognition) recognition = initSpeechRecognition();
  if (!recognition) {
    addMessage('system', 'Speech recognition is not supported in this browser.');
    return;
  }
  state.listening = true;
  micBtn.classList.add('active');
  try { recognition.start(); } catch {}
}

function stopListening() {
  state.listening = false;
  micBtn.classList.remove('active');
  clearTimeout(speechTimeout);
  if (recognition) {
    try { recognition.stop(); } catch {}
  }
}

// ── Voice: Speech Synthesis ───────────────────────────────
function speakText(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 0.95;
  utterance.pitch = 1.05;

  // Try to find a female voice
  const voices = window.speechSynthesis.getVoices();
  const femaleVoice = voices.find(v =>
    v.name.includes('Samantha') || v.name.includes('Female') ||
    v.name.includes('Zira') || v.name.includes('Google UK English Female') ||
    v.name.includes('Karen') || v.name.includes('Victoria') ||
    v.name.includes('Fiona') || v.name.includes('Moira')
  );
  if (femaleVoice) utterance.voice = femaleVoice;
  window.speechSynthesis.speak(utterance);
}

// ── Footer Time ───────────────────────────────────────────
function updateFooter() {
  const now = new Date();
  const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
  $('#footerTime').textContent = time;
  $('#footerLeft').innerHTML = `SUBSTRATE: ${state.factCount} facts &middot; ${state.protocols.filter(p => p.active).length} protocols &middot; ${state.signalCount} signals`;
}

// ── Event Bindings ────────────────────────────────────────
sendBtn.addEventListener('click', () => handleSend(chatInput.value.trim()));
chatInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    handleSend(chatInput.value.trim());
  }
});

micBtn.addEventListener('click', () => {
  if (state.listening) {
    stopListening();
  } else {
    startListening();
  }
});

voiceToggle.addEventListener('click', () => {
  state.voiceMode = !state.voiceMode;
  voiceToggle.classList.toggle('voice-active', state.voiceMode);
  if (state.voiceMode) {
    startListening();
  } else {
    stopListening();
    window.speechSynthesis && window.speechSynthesis.cancel();
  }
});

// Quick action chips
$$('.chip').forEach(chip => {
  chip.addEventListener('click', () => {
    handleSend(chip.dataset.msg);
  });
});

// ── Live Simulation ───────────────────────────────────────
// Periodically add new signals and nudge metrics to feel alive
let simInterval = null;

function startSimulation() {
  const randomSignals = [
    { type: 'purchase', text: () => `User '${randomName()}' purchased LineSkip — $${state.metrics.avgSpend > 23 ? 15 : 13}.00` },
    { type: 'check-in', text: () => `${randomName()} checked in — ${Math.floor(Math.random() * 5) + 1} in party` },
    { type: 'purchase', text: () => `User '${randomName()}' purchased 2 drinks — $${(Math.random() * 8 + 8).toFixed(2)}` },
    { type: 'check-in', text: () => `VIP '${randomName()}' scanned at door — repeat visitor` },
  ];

  const names = ['Emma W.', 'Liam T.', 'Olivia P.', 'Noah R.', 'Ava S.', 'Mason K.', 'Sophia L.', 'Lucas B.', 'Isla M.', 'Ethan C.', 'Chloe D.', 'Logan F.', 'Grace H.', 'Jack N.', 'Lily V.', 'Ryan G.', 'Zoe A.'];
  function randomName() { return names[Math.floor(Math.random() * names.length)]; }

  simInterval = setInterval(() => {
    // Add a new signal
    const sig = randomSignals[Math.floor(Math.random() * randomSignals.length)];
    state.signals.unshift({ type: sig.type, text: sig.text(), time: 'just now' });
    if (state.signals.length > 20) state.signals.pop();
    state.signalCount++;
    renderSignals(true);

    // Nudge revenue up slightly
    const bump = Math.floor(Math.random() * 25 + 5);
    state.metrics.revenue += bump;
    animateValue($('#valRevenue'), state.metrics.revenue - bump, state.metrics.revenue, 400, formatCurrency);

    // Occasionally bump covers
    if (Math.random() > 0.5) {
      state.metrics.covers += 1;
      animateValue($('#valCovers'), state.metrics.covers - 1, state.metrics.covers, 400);
    }

    state.factCount++;
    updateFooter();
  }, 12000); // Every 12 seconds
}

// ── Init ──────────────────────────────────────────────────
function init() {
  // Render all
  renderProtocols();
  renderSignals(false);
  renderSparkline();
  renderDrinkBars();
  renderConfidence();
  updateFooter();

  // Update footer clock every 30s
  setInterval(updateFooter, 30000);

  // Welcome message
  setTimeout(() => {
    addMessage('charlotte',
      "Good evening, Jordan. Kollege Klub is looking strong tonight.\n\n" +
      "We're projecting 245 covers \u2014 15% above your Thursday average. LineSkip demand is tracking high at 94% sell-through. I've already nudged pricing up to $13 via dynamic pricing protocol.\n\n" +
      "47 pre-sold covers, 12 VIP reservations locked. Suggested staffing: 3 bartenders, 2 door.\n\n" +
      "What can I help with?"
    );
  }, 600);

  // Check backend availability
  fetch('/api/substrate').then(r => {
    if (r.ok) {
      state.isOnline = true;
      statusDot.classList.remove('local');
    }
  }).catch(() => {
    state.isOnline = false;
    statusDot.classList.add('local');
  });

  // Preload voices
  if (window.speechSynthesis) {
    window.speechSynthesis.getVoices();
    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
  }

  // Start live simulation
  startSimulation();
}

init();

})();
</script>
</body>
</html>
