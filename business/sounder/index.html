<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sounder ‚Äî Biological Lifecycle Intelligence | Charlotte Substrate</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a0f;color:#e0ddd5;font-family:'Courier New',monospace;overflow:hidden}
#canvas-container{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0}
#dashboard{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;display:flex;flex-direction:column}
#header{pointer-events:auto;background:linear-gradient(180deg,rgba(10,10,15,0.95),rgba(10,10,15,0.7));padding:12px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #d4a37330}
#header h1{font-size:22px;letter-spacing:4px;background:linear-gradient(90deg,#d4a373,#bc8cff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:700}
#header .subtitle{font-size:11px;color:#8a8578;letter-spacing:2px}
#stats{pointer-events:auto;background:rgba(10,10,15,0.85);display:flex;gap:0;border-bottom:1px solid #d4a37315;flex-wrap:wrap}
.stat{flex:1;min-width:100px;padding:8px 12px;text-align:center;border-right:1px solid #d4a37310}
.stat-value{display:block;font-size:16px;font-weight:700;color:#d4a373}
.stat-label{display:block;font-size:8px;letter-spacing:2px;color:#8a8578;margin-top:2px}
#middle{flex:1;display:flex;overflow:hidden}
#left-panel{pointer-events:auto;width:260px;background:rgba(10,10,15,0.88);padding:16px;overflow-y:auto;border-right:1px solid #d4a37315;scrollbar-width:thin;scrollbar-color:#d4a37330 transparent}
#left-panel::-webkit-scrollbar{width:4px}
#left-panel::-webkit-scrollbar-thumb{background:#d4a37330;border-radius:2px}
#center-gap{flex:1;pointer-events:none}
#right-panel{pointer-events:auto;width:260px;background:rgba(10,10,15,0.88);padding:16px;overflow-y:auto;border-left:1px solid #d4a37315;scrollbar-width:thin;scrollbar-color:#d4a37330 transparent}
#right-panel::-webkit-scrollbar{width:4px}
#right-panel::-webkit-scrollbar-thumb{background:#d4a37330;border-radius:2px}
.panel-title{font-size:11px;letter-spacing:2px;color:#bc8cff;margin-bottom:10px;padding-bottom:4px;border-bottom:1px solid #bc8cff20}
.chart-row{display:flex;align-items:center;gap:6px;margin:3px 0}
.chart-label{width:38px;font-size:9px;text-align:right;color:#8a8578;flex-shrink:0}
.chart-fill{height:12px;border-radius:2px;min-width:2px;transition:width 0.8s}
.chart-value{font-size:9px;color:#8a857880;flex-shrink:0;width:40px}
.legend-item{display:flex;align-items:center;gap:8px;margin:4px 0;font-size:10px;cursor:pointer;padding:3px 6px;border-radius:4px;transition:background 0.2s}
.legend-item:hover{background:rgba(255,255,255,0.05)}
.legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.legend-shape-box .legend-dot{border-radius:2px}
.legend-shape-diamond .legend-dot{transform:rotate(45deg);border-radius:1px}
.legend-count{margin-left:auto;color:#8a8578;font-size:9px}
#detail-panel{display:none;margin-top:12px;padding:12px;background:rgba(188,140,255,0.06);border:1px solid #bc8cff20;border-radius:6px}
#detail-panel h3{font-size:13px;color:#d4a373;margin-bottom:6px}
#detail-panel .detail-type{font-size:9px;color:#bc8cff;letter-spacing:1px;margin-bottom:8px}
#detail-panel .detail-stat{font-size:10px;margin:3px 0;color:#e0ddd5cc}
#detail-panel .connections{margin-top:8px;font-size:9px;color:#8a8578}
#detail-panel .conn-item{margin:2px 0;padding:2px 4px;cursor:pointer;border-radius:2px}
#detail-panel .conn-item:hover{background:rgba(255,255,255,0.05);color:#e0ddd5}
#bottom-panel{pointer-events:auto;background:rgba(10,10,15,0.92);padding:10px 24px;border-top:1px solid #d4a37315;display:flex;gap:24px;flex-wrap:wrap}
.encoding-col{flex:1;min-width:140px}
.encoding-col h4{font-size:10px;letter-spacing:2px;margin-bottom:4px}
.encoding-col p{font-size:9px;color:#8a8578;line-height:1.6}
.enc-primitive{color:#bc8cff}
.enc-breed{color:#d4a373}
.enc-teal{color:#4ecdc4}
.enc-coral{color:#ff6b6b}
.enc-mint{color:#95e1d3}
#fact-example{flex:2;min-width:300px;background:rgba(0,0,0,0.3);padding:8px 12px;border-radius:4px;border:1px solid #d4a37310;font-size:9px;line-height:1.7;font-family:'Courier New',monospace}
.fact-key{color:#bc8cff}.fact-val{color:#d4a373}.fact-op{color:#4ecdc4}
#tooltip{display:none;position:fixed;background:rgba(10,10,15,0.95);border:1px solid #d4a37340;padding:10px 14px;border-radius:6px;font-size:11px;pointer-events:none;z-index:100;max-width:280px;backdrop-filter:blur(8px)}
#tooltip strong{color:#d4a373}
#tooltip .tt-type{color:#bc8cff;font-size:9px;letter-spacing:1px}
#labels-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5}
.node-label{position:absolute;font-size:9px;white-space:nowrap;text-shadow:0 0 4px rgba(0,0,0,0.9),0 0 8px rgba(0,0,0,0.6);transform:translate(-50%,-100%);transition:opacity 0.3s;letter-spacing:0.5px}
#controls-hint{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);font-size:10px;color:#8a857860;z-index:20;pointer-events:none;text-align:center;letter-spacing:1px}
.filter-btn{pointer-events:auto;background:rgba(255,255,255,0.05);border:1px solid #d4a37320;color:#8a8578;padding:3px 8px;font-size:9px;font-family:'Courier New',monospace;cursor:pointer;border-radius:3px;transition:all 0.2s;letter-spacing:1px}
.filter-btn:hover,.filter-btn.active{background:rgba(212,163,115,0.15);color:#d4a373;border-color:#d4a37360}
#type-filters{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px}
</style>
</head>
<body>

<div id="gate" style="position:fixed;inset:0;z-index:9999;background:#0a0a0f;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Courier New',monospace;transition:opacity 0.5s;">
  <div style="width:100px;height:100px;border-radius:20px;background:#151518;border:1px solid #d4a37330;display:flex;align-items:center;justify-content:center;font-size:40px;margin-bottom:28px;">üêó</div>
  <p style="color:#8a8578;font-size:12px;letter-spacing:2px;text-transform:uppercase;margin-bottom:20px;">Enter Access Code</p>
  <input id="gate-input" type="password" autocomplete="off" autofocus placeholder="&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;" style="background:#151518;border:1px solid #d4a37330;border-radius:12px;padding:14px 24px;font-size:18px;color:#e0ddd5;text-align:center;letter-spacing:4px;width:220px;outline:none;font-family:inherit;">
  <p id="gate-error" style="color:#ef4444;font-size:12px;margin-top:12px;opacity:0;transition:opacity 0.3s;">&nbsp;</p>
</div>
<script>
(function(){
  var code='trogdon',g=document.getElementById('gate'),inp=document.getElementById('gate-input'),err=document.getElementById('gate-error');
  if(sessionStorage.getItem('sounder_auth')==='1'){g.style.display='none';}
  inp.addEventListener('keydown',function(e){
    if(e.key==='Enter'){
      if(inp.value.toLowerCase().trim()===code){sessionStorage.setItem('sounder_auth','1');g.style.opacity='0';setTimeout(function(){g.style.display='none';},500);}
      else{inp.value='';inp.style.borderColor='#ef4444';err.textContent='Invalid code';err.style.opacity='1';setTimeout(function(){inp.style.borderColor='#d4a37330';err.style.opacity='0';},1500);}
    }
  });
})();
</script>

<div id="canvas-container"></div>
<div id="dashboard">
    <div id="header">
        <div>
            <h1>SOUNDER</h1>
            <div class="subtitle">BIOLOGICAL LIFECYCLE INTELLIGENCE &middot; CHARLOTTE SUBSTRATE</div>
        </div>
        <div style="text-align:right">
            <div style="font-size:10px;color:#d4a373">Trogdon Genetics &middot; 3 Years</div>
            <div style="font-size:9px;color:#8a8578">382,197 LISP Facts &middot; First-Order Logic</div>
        </div>
    </div>
    <div id="stats">
        <div class="stat"><span class="stat-value">382,197</span><span class="stat-label">TOTAL FACTS</span></div>
        <div class="stat"><span class="stat-value">65,412</span><span class="stat-label">CPS BREEDERS</span></div>
        <div class="stat"><span class="stat-value">5,279</span><span class="stat-label">HERDMARKS</span></div>
        <div class="stat"><span class="stat-value">1,176</span><span class="stat-label">AUCTION SALES</span></div>
        <div class="stat"><span class="stat-value">$1.13M</span><span class="stat-label">REVENUE</span></div>
        <div class="stat"><span class="stat-value">11</span><span class="stat-label">BREEDS</span></div>
        <div class="stat"><span class="stat-value">50</span><span class="stat-label">STATES</span></div>
        <div class="stat"><span class="stat-value">35</span><span class="stat-label">AUCTIONS</span></div>
        <div class="stat"><span class="stat-value">90,582</span><span class="stat-label">TEMPORAL EDGES</span></div>
        <div class="stat"><span class="stat-value">117</span><span class="stat-label">SCRIPTS</span></div>
    </div>
    <div id="middle">
        <div id="left-panel">
            <div class="panel-title">SALES BY YEAR</div>
            <div id="sales-chart"></div>
            <div class="panel-title" style="margin-top:16px">TOP STATES (CPS)</div>
            <div id="state-chart"></div>
            <div class="panel-title" style="margin-top:16px">BREED DISTRIBUTION</div>
            <div id="breed-chart"></div>
            <div class="panel-title" style="margin-top:16px">SALE TYPES</div>
            <div id="type-chart"></div>
        </div>
        <div id="center-gap"></div>
        <div id="right-panel">
            <div class="panel-title">NODE TYPES</div>
            <div id="type-filters"></div>
            <div id="legend"></div>
            <div id="detail-panel">
                <h3 id="detail-name"></h3>
                <div class="detail-type" id="detail-type"></div>
                <div id="detail-stats"></div>
                <div class="connections" id="detail-connections"><strong>Connections:</strong><div id="conn-list"></div></div>
            </div>
        </div>
    </div>
    <div id="bottom-panel">
        <div class="encoding-col">
            <h4 class="enc-primitive">NODE</h4>
            <p>Animal <span class="enc-teal">(ear notch)</span><br>Breeder <span class="enc-teal">(herdmark)</span><br>Buyer <span class="enc-teal">(customer ID)</span><br>Sire / Dam <span class="enc-teal">(lineage)</span></p>
        </div>
        <div class="encoding-col">
            <h4 class="enc-primitive">EDGE</h4>
            <p><span class="enc-coral">IS_SIRE_OF</span> &middot; <span class="enc-coral">IS_DAM_OF</span><br><span class="enc-coral">BRED_BY</span> &middot; <span class="enc-coral">OWNED_BY</span><br><span class="enc-coral">SOLD_TO</span> &middot; <span class="enc-coral">FARROWED_ON</span><br><span class="enc-coral">BORN_ON</span> &middot; <span class="enc-coral">HAS_A</span></p>
        </div>
        <div class="encoding-col">
            <h4 class="enc-primitive">METRIC</h4>
            <p>Price <span class="enc-breed">($)</span><br>Weight <span class="enc-breed">(lbs)</span><br>Daily Gain &middot; Feed:Gain<br>Heart Rate <span class="enc-breed">(BPM)</span></p>
        </div>
        <div class="encoding-col">
            <h4 class="enc-primitive">SIGNAL</h4>
            <p>Sale event &middot; Breeding date<br>Farrow date &middot; Wean date<br>Show placement<br>Disease diagnosis</p>
        </div>
        <div class="encoding-col">
            <h4 class="enc-primitive">PROTOCOL</h4>
            <p>Medication schedule<br>Supplement regime<br>Vaccination program<br>Gestation monitoring</p>
        </div>
        <div id="fact-example">
            <span class="fact-op">;; LISP FACT ENCODING</span><br>
            <span class="fact-key">::OPERATION</span>:<span class="fact-val">2172753521</span><br>
            &nbsp;&nbsp;<span class="fact-key">::SALE</span>:<span class="fact-val">ANIMAL</span><br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="fact-key">::SEX</span>:<span class="fact-val">GILT</span> <span class="fact-key">::DAM</span>:<span class="fact-val">RIP_SIS</span> <span class="fact-key">::EAR</span>:<span class="fact-val">34-1</span><br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="fact-key">::CUSTOMER</span>:<span class="fact-val">KEVIN_TUCKER</span> <span class="fact-key">::PRICE</span>:<span class="fact-val">200</span><br>
            <span class="fact-op">;; FIRST-ORDER LOGIC</span><br>
            <span class="enc-mint">sale(rip_sis_34_1, kevin_tucker, 200, '2019-11-14').</span><br>
            <span class="enc-mint">is_dam_of(rip_sis, rip_sis_34_1). sex(rip_sis_34_1, gilt).</span>
        </div>
    </div>
</div>
<div id="tooltip"></div>
<div id="labels-container"></div>
<div id="controls-hint">ORBIT: drag &middot; ZOOM: scroll &middot; PAN: right-drag &middot; CLICK: inspect node</div>

<script type="importmap">
{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/" } }
</script>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

// === TYPE CONFIGURATION ===
const TYPE_CFG = {
    primitive:    { color: 0xbc8cff, css: '#bc8cff', label: 'Charlotte Primitive', geo: 'ico',   emissive: true },
    breed:        { color: 0xd4a373, css: '#d4a373', label: 'Breed',              geo: 'sphere', emissive: false },
    registry:     { color: 0x4ecdc4, css: '#4ecdc4', label: 'Registry',           geo: 'oct',    emissive: false },
    state:        { color: 0xffe066, css: '#ffe066', label: 'State',              geo: 'box',    emissive: false },
    relationship: { color: 0xff6b6b, css: '#ff6b6b', label: 'Edge Type',          geo: 'tetra',  emissive: false },
    pipeline:     { color: 0x95e1d3, css: '#95e1d3', label: 'Pipeline Stage',     geo: 'cyl',    emissive: false },
    fact_type:    { color: 0xf38181, css: '#f38181', label: 'FACT Type',          geo: 'dodec',  emissive: false },
    product:      { color: 0xaa96da, css: '#aa96da', label: 'Genetics Partner',   geo: 'sphere', emissive: false },
    animal_type:  { color: 0xa8e6cf, css: '#a8e6cf', label: 'Animal Type',        geo: 'sphere', emissive: false },
    health:       { color: 0xff8b94, css: '#ff8b94', label: 'Health Category',    geo: 'box',    emissive: false },
    buyer:        { color: 0xffd3b6, css: '#ffd3b6', label: 'Top Buyer',          geo: 'sphere', emissive: false },
    year:         { color: 0xdcedc1, css: '#dcedc1', label: 'Auction Year',       geo: 'sphere', emissive: false },
    sire:         { color: 0xc9a96e, css: '#c9a96e', label: 'Key Sire',           geo: 'sphere', emissive: false },
    show:         { color: 0xe9c46a, css: '#e9c46a', label: 'Show / Event',       geo: 'box',    emissive: false },
    source:       { color: 0x78c4d4, css: '#78c4d4', label: 'Data Source',        geo: 'oct',    emissive: false }
};

// === NODE DATA ===
const nodes = [
    // Charlotte Primitives
    { id:'NODE',     type:'primitive', label:'NODE',     size:3.5, desc:'Identity ‚Äî animals, breeders, buyers' },
    { id:'EDGE',     type:'primitive', label:'EDGE',     size:3.5, desc:'Relationship ‚Äî sire/dam, bred-by, sold-to' },
    { id:'METRIC',   type:'primitive', label:'METRIC',   size:3.5, desc:'Measurement ‚Äî price, weight, gain ratios' },
    { id:'SIGNAL',   type:'primitive', label:'SIGNAL',   size:3.5, desc:'Event ‚Äî sales, breedings, farrowings, shows' },
    { id:'PROTOCOL', type:'primitive', label:'PROTOCOL', size:3.5, desc:'Rule ‚Äî medication, supplement, disease mgmt' },
    // Breeds
    { id:'BERKSHIRE',  type:'breed', label:'Berkshire',     size:2.4, count:8808,  color:0x8B4513 },
    { id:'CHESTER',    type:'breed', label:'Chester White', size:2.9, count:18702, color:0xD2691E },
    { id:'DUROC',      type:'breed', label:'Duroc',         size:2.0, count:3763,  color:0xCD5C5C },
    { id:'HAMPSHIRE',  type:'breed', label:'Hampshire',     size:2.0, count:3763,  color:0x2E8B57 },
    { id:'HEREFORD',   type:'breed', label:'Hereford',      size:2.7, count:11432, color:0xB22222 },
    { id:'LANDRACE',   type:'breed', label:'Landrace',      size:1.8, count:3763,  color:0xDEB887 },
    { id:'POLAND',     type:'breed', label:'Poland China',  size:2.8, count:16655, color:0x666666 },
    { id:'SPOT',       type:'breed', label:'Spot',          size:2.9, count:18623, color:0x808080 },
    { id:'YORKSHIRE',  type:'breed', label:'Yorkshire',     size:1.8, count:3763,  color:0xFFE4C4 },
    { id:'TAMWORTH',   type:'breed', label:'Tamworth',      size:1.5, count:0,     color:0xFF8C00 },
    { id:'CROSS',      type:'breed', label:'Crossbred',     size:1.5, count:0,     color:0x9ACD32 },
    // Registries
    { id:'CPS', type:'registry', label:'CPS',  size:2.8, count:65412, desc:'Certified Pedigree Swine ‚Äî 65,412 entries' },
    { id:'NSR', type:'registry', label:'NSR',  size:2.2, count:3763,  desc:'National Swine Registry ‚Äî 3,763 breeders' },
    { id:'ABA', type:'registry', label:'ABA',  size:2.4, count:8808,  desc:'American Berkshire Association ‚Äî 8,808 entries' },
    // Top States
    { id:'IN', type:'state', label:'IN', size:2.2, count:14552 },
    { id:'OK', type:'state', label:'OK', size:2.0, count:9177 },
    { id:'TX', type:'state', label:'TX', size:2.0, count:9174 },
    { id:'IL', type:'state', label:'IL', size:1.8, count:5542 },
    { id:'OH', type:'state', label:'OH', size:1.7, count:4047 },
    { id:'MO', type:'state', label:'MO', size:1.5, count:2999 },
    { id:'IA', type:'state', label:'IA', size:1.5, count:2699 },
    { id:'WI', type:'state', label:'WI', size:1.4, count:2342 },
    { id:'KS', type:'state', label:'KS', size:1.3, count:1429 },
    { id:'PA', type:'state', label:'PA', size:1.2, count:1197 },
    { id:'MN', type:'state', label:'MN', size:1.2, count:1052 },
    { id:'TN', type:'state', label:'TN', size:1.2, count:1041 },
    // Edge Types
    { id:'IS_SIRE_OF', type:'relationship', label:'IS_SIRE_OF', size:1.2 },
    { id:'IS_DAM_OF',  type:'relationship', label:'IS_DAM_OF',  size:1.2 },
    { id:'BRED_BY',    type:'relationship', label:'BRED_BY',    size:1.2 },
    { id:'OWNED_BY',   type:'relationship', label:'OWNED_BY',   size:1.2 },
    { id:'SOLD_TO',    type:'relationship', label:'SOLD_TO',    size:1.2 },
    { id:'BORN_ON',    type:'relationship', label:'BORN_ON',    size:1.2 },
    { id:'FARROWED_ON',type:'relationship', label:'FARROWED_ON',size:1.2 },
    { id:'HAS_A',      type:'relationship', label:'HAS_A',      size:1.0 },
    { id:'IS_A',       type:'relationship', label:'IS_A',       size:1.0 },
    { id:'CUSTOMER_OF',type:'relationship', label:'CUSTOMER_OF',size:1.0 },
    // Pipeline
    { id:'SCRAPE',    type:'pipeline', label:'SCRAPE',    size:1.6, desc:'Puppeteer + Cheerio crawlers' },
    { id:'PARSE',     type:'pipeline', label:'PARSE',     size:1.6, desc:'HTML/PDF ‚Üí structured records' },
    { id:'NORMALIZE', type:'pipeline', label:'NORMALIZE', size:1.6, desc:'Dedup, clean, standardize' },
    { id:'GENERATE',  type:'pipeline', label:'GENERATE',  size:1.6, desc:'Create NEURON fact nodes' },
    { id:'AGGREGATE', type:'pipeline', label:'AGGREGATE', size:1.6, desc:'Pivot into DATAFRAMES' },
    { id:'DEPLOY',    type:'pipeline', label:'DEPLOY',    size:1.6, desc:'Upload to Firebase FACTS' },
    // FACT Types
    { id:'NEURON',             type:'fact_type', label:'NEURON',             size:1.5, desc:'Atomic fact unit ‚Äî single observation' },
    { id:'NEURAL_DATAFRAME',   type:'fact_type', label:'NEURAL_DATAFRAME',   size:1.5, desc:'Temporal aggregation of neurons' },
    { id:'COMPOUND_DATAFRAME', type:'fact_type', label:'COMPOUND_DATAFRAME', size:1.5, desc:'Cross-pivot aggregation' },
    { id:'SALE_FACT',          type:'fact_type', label:'SALE',               size:1.5, desc:'Auction transaction record' },
    // Products / Partners
    { id:'BAADE',         type:'product', label:'Baade Genetics',      size:1.0 },
    { id:'GENETIC_EDGE',  type:'product', label:'Genetic Edge',        size:1.0 },
    { id:'HEIMER_HAMPS',  type:'product', label:'Heimer Hampshires',   size:1.0 },
    { id:'HI_POINT',      type:'product', label:'Hi Point Genetics',   size:1.0 },
    { id:'PERRY',         type:'product', label:'Perry Swine',         size:1.0 },
    { id:'PREMIUM_BLEND', type:'product', label:'Premium Blend',       size:1.0 },
    { id:'SOUTHERN_GOLD', type:'product', label:'Southern Gold',       size:1.0 },
    { id:'TOP_CUT',       type:'product', label:'Top Cut Genetics',    size:1.0 },
    // Animal Types
    { id:'GILT',   type:'animal_type', label:'GILT',   size:1.4, count:430, desc:'Young female ‚Äî 430 sold' },
    { id:'BARROW', type:'animal_type', label:'BARROW', size:1.4, count:466, desc:'Castrated male ‚Äî 466 sold' },
    { id:'BOAR',   type:'animal_type', label:'BOAR',   size:1.2, count:30,  desc:'Breeding male ‚Äî 30 sold' },
    // Health Categories
    { id:'DISEASES',    type:'health', label:'DISEASES',    size:1.4, count:25, desc:'25 tracked: PRRS, CIRCOVIRUS, ASF, PEDV...' },
    { id:'MEDICATIONS', type:'health', label:'MEDICATIONS', size:1.4, count:8,  desc:'8 tracked: DEXTOMAX, IVOMEC, DRAXXIN...' },
    { id:'SUPPLEMENTS', type:'health', label:'SUPPLEMENTS', size:1.4, count:12, desc:'12 tracked: PG600, LUTALYSE, IRON...' },
    // Top Buyers
    { id:'DAN_SCROGGINS',     type:'buyer', label:'Dan Scroggins',     size:1.3, count:45 },
    { id:'DOUG_SMITH',        type:'buyer', label:'Doug Smith',        size:1.1, count:30 },
    { id:'JOSH_CAMPBELL',     type:'buyer', label:'Josh Campbell',     size:1.0, count:24 },
    { id:'CRAIG_HAMIL',       type:'buyer', label:'Craig Hamil',       size:1.0, count:20 },
    { id:'DAVE_GUYER',        type:'buyer', label:'Dave Guyer',        size:0.9, count:15 },
    { id:'NATALIE_HOFCHULTE', type:'buyer', label:'Natalie Hofchulte', size:0.9, count:14 },
    { id:'JOSH_DOUGLASS',     type:'buyer', label:'Josh Douglass',     size:0.9, count:14 },
    { id:'JOSH_POWELL',       type:'buyer', label:'Josh Powell',       size:0.9, count:12 },
    // Auction Years
    { id:'Y2017', type:'year', label:'2017', size:1.2, count:88 },
    { id:'Y2018', type:'year', label:'2018', size:1.5, count:245 },
    { id:'Y2019', type:'year', label:'2019', size:1.6, count:281 },
    { id:'Y2020', type:'year', label:'2020', size:1.5, count:270 },
    { id:'Y2021', type:'year', label:'2021', size:1.4, count:185 },
    { id:'Y2022', type:'year', label:'2022', size:1.2, count:107 },
    // Key Sires
    { id:'MONEY_LINE',     type:'sire', label:'Money Line',     size:1.1 },
    { id:'SLOW_MOTION',    type:'sire', label:'Slow Motion',    size:1.1 },
    { id:'CLAWS',          type:'sire', label:'Claws',          size:1.1 },
    { id:'WILD_RIDE',      type:'sire', label:'Wild Ride',      size:1.1 },
    { id:'QUITE_FRANKLY',  type:'sire', label:'Quite Frankly',  size:1.1 },
    { id:'BATTLE_CRY',     type:'sire', label:'Battle Cry',     size:1.1 },
    // Shows
    { id:'THE_EXPOSITION',      type:'show', label:'The Exposition',      size:1.4 },
    { id:'SUMMER_SPECTACULAR',  type:'show', label:'Summer Spectacular',  size:1.4 },
    { id:'NATIONAL_SWINE_EXPO', type:'show', label:'National Swine Expo', size:1.4 },
    // Data Sources
    { id:'NSR_WEBSITE',  type:'source', label:'NSR Website',  size:1.3, desc:'nationalswine.com ‚Äî 671M+ animal IDs' },
    { id:'CPS_WEBSITE',  type:'source', label:'CPS Website',  size:1.3, desc:'Certified Pedigree Swine portal' },
    { id:'WENDT_GROUP',  type:'source', label:'Wendt Group',  size:1.3, desc:'thewendtgroup.com ‚Äî 35 auctions scraped' }
];

// === EDGE DATA ===
const edges = [
    // Primitives ‚Üí Domain
    {s:'NODE',e:'BERKSHIRE',w:2},{s:'NODE',e:'CHESTER',w:2},{s:'NODE',e:'DUROC',w:2},{s:'NODE',e:'HAMPSHIRE',w:2},{s:'NODE',e:'HEREFORD',w:2},
    {s:'NODE',e:'GILT',w:1.5},{s:'NODE',e:'BARROW',w:1.5},{s:'NODE',e:'BOAR',w:1.5},
    {s:'EDGE',e:'IS_SIRE_OF',w:2},{s:'EDGE',e:'IS_DAM_OF',w:2},{s:'EDGE',e:'BRED_BY',w:2},{s:'EDGE',e:'OWNED_BY',w:2},{s:'EDGE',e:'SOLD_TO',w:2},{s:'EDGE',e:'BORN_ON',w:1.5},{s:'EDGE',e:'FARROWED_ON',w:1.5},{s:'EDGE',e:'HAS_A',w:1.5},{s:'EDGE',e:'IS_A',w:1.5},{s:'EDGE',e:'CUSTOMER_OF',w:1.5},
    {s:'METRIC',e:'SALE_FACT',w:1.5},{s:'METRIC',e:'NEURON',w:1.5},
    {s:'SIGNAL',e:'SALE_FACT',w:1.5},{s:'SIGNAL',e:'NEURON',w:1.5},{s:'SIGNAL',e:'NEURAL_DATAFRAME',w:1.5},
    {s:'PROTOCOL',e:'DISEASES',w:2},{s:'PROTOCOL',e:'MEDICATIONS',w:2},{s:'PROTOCOL',e:'SUPPLEMENTS',w:2},
    // Breeds ‚Üí Registries
    {s:'CHESTER',e:'CPS',w:1.5},{s:'SPOT',e:'CPS',w:1.5},{s:'POLAND',e:'CPS',w:1.5},{s:'HEREFORD',e:'CPS',w:1.5},
    {s:'BERKSHIRE',e:'ABA',w:1.5},{s:'BERKSHIRE',e:'NSR',w:1},
    {s:'DUROC',e:'NSR',w:1.5},{s:'HAMPSHIRE',e:'NSR',w:1.5},{s:'YORKSHIRE',e:'NSR',w:1.5},{s:'LANDRACE',e:'NSR',w:1.5},{s:'TAMWORTH',e:'NSR',w:1},
    // Registries ‚Üí States
    {s:'CPS',e:'IN',w:1.2},{s:'CPS',e:'OK',w:1},{s:'CPS',e:'TX',w:1},{s:'CPS',e:'IL',w:1},{s:'CPS',e:'OH',w:1},
    {s:'NSR',e:'IN',w:0.8},{s:'NSR',e:'MO',w:0.8},{s:'NSR',e:'IA',w:0.8},{s:'NSR',e:'WI',w:0.8},
    {s:'ABA',e:'IN',w:0.8},{s:'ABA',e:'OH',w:0.8},{s:'ABA',e:'TX',w:0.8},{s:'ABA',e:'IL',w:0.8},
    // Pipeline chain
    {s:'SCRAPE',e:'PARSE',w:2.5},{s:'PARSE',e:'NORMALIZE',w:2.5},{s:'NORMALIZE',e:'GENERATE',w:2.5},{s:'GENERATE',e:'AGGREGATE',w:2.5},{s:'AGGREGATE',e:'DEPLOY',w:2.5},
    // Pipeline ‚Üí Sources
    {s:'SCRAPE',e:'NSR_WEBSITE',w:1.5},{s:'SCRAPE',e:'CPS_WEBSITE',w:1.5},{s:'SCRAPE',e:'WENDT_GROUP',w:1.5},
    // Pipeline ‚Üí FACT Types
    {s:'GENERATE',e:'NEURON',w:1.5},{s:'GENERATE',e:'SALE_FACT',w:1.5},
    {s:'AGGREGATE',e:'NEURAL_DATAFRAME',w:1.5},{s:'AGGREGATE',e:'COMPOUND_DATAFRAME',w:1.5},
    // FACT type chain
    {s:'NEURON',e:'NEURAL_DATAFRAME',w:1.5},{s:'NEURAL_DATAFRAME',e:'COMPOUND_DATAFRAME',w:1.5},
    // Products ‚Üí Breeds
    {s:'HEIMER_HAMPS',e:'HAMPSHIRE',w:1},{s:'BAADE',e:'DUROC',w:1},{s:'GENETIC_EDGE',e:'BERKSHIRE',w:1},
    {s:'HI_POINT',e:'SPOT',w:1},{s:'PERRY',e:'YORKSHIRE',w:1},{s:'PREMIUM_BLEND',e:'DUROC',w:1},
    {s:'SOUTHERN_GOLD',e:'CHESTER',w:1},{s:'TOP_CUT',e:'HAMPSHIRE',w:1},
    // Buyers ‚Üí Years
    {s:'DAN_SCROGGINS',e:'Y2018',w:1},{s:'DAN_SCROGGINS',e:'Y2019',w:1},{s:'DAN_SCROGGINS',e:'Y2020',w:1},
    {s:'DOUG_SMITH',e:'Y2019',w:1},{s:'DOUG_SMITH',e:'Y2020',w:1},
    {s:'JOSH_CAMPBELL',e:'Y2018',w:1},{s:'JOSH_CAMPBELL',e:'Y2019',w:1},
    {s:'CRAIG_HAMIL',e:'Y2017',w:1},{s:'CRAIG_HAMIL',e:'Y2018',w:1},
    {s:'DAVE_GUYER',e:'Y2020',w:1},{s:'NATALIE_HOFCHULTE',e:'Y2021',w:1},
    {s:'JOSH_DOUGLASS',e:'Y2019',w:1},{s:'JOSH_POWELL',e:'Y2020',w:1},
    // Years ‚Üí Wendt Group
    {s:'Y2017',e:'WENDT_GROUP',w:0.8},{s:'Y2018',e:'WENDT_GROUP',w:0.8},{s:'Y2019',e:'WENDT_GROUP',w:0.8},
    {s:'Y2020',e:'WENDT_GROUP',w:0.8},{s:'Y2021',e:'WENDT_GROUP',w:0.8},{s:'Y2022',e:'WENDT_GROUP',w:0.8},
    // Sires ‚Üí Breeds
    {s:'MONEY_LINE',e:'DUROC',w:1},{s:'SLOW_MOTION',e:'HAMPSHIRE',w:1},{s:'CLAWS',e:'BERKSHIRE',w:1},
    {s:'WILD_RIDE',e:'DUROC',w:1},{s:'QUITE_FRANKLY',e:'YORKSHIRE',w:1},{s:'BATTLE_CRY',e:'HAMPSHIRE',w:1},
    // Sires ‚Üí IS_SIRE_OF
    {s:'MONEY_LINE',e:'IS_SIRE_OF',w:0.6},{s:'BATTLE_CRY',e:'IS_SIRE_OF',w:0.6},
    // Shows ‚Üí States + Breeds
    {s:'THE_EXPOSITION',e:'IL',w:0.8},{s:'SUMMER_SPECTACULAR',e:'IN',w:0.8},{s:'NATIONAL_SWINE_EXPO',e:'OH',w:0.8},
    {s:'THE_EXPOSITION',e:'BERKSHIRE',w:0.6},{s:'SUMMER_SPECTACULAR',e:'CHESTER',w:0.6},{s:'NATIONAL_SWINE_EXPO',e:'DUROC',w:0.6},
    // Animal types ‚Üí Breeds
    {s:'GILT',e:'BERKSHIRE',w:0.5},{s:'BARROW',e:'DUROC',w:0.5},{s:'BOAR',e:'HAMPSHIRE',w:0.5}
];

// === INITIALIZE NODE POSITIONS ===
const typeRadius = { primitive:0, breed:28, registry:38, state:55, relationship:22, pipeline:45, fact_type:35, product:42, animal_type:18, health:15, buyer:60, year:52, sire:35, show:50, source:55 };
const nodeMap = {};
nodes.forEach((n, i) => {
    const r = (typeRadius[n.type] || 40) + (Math.random() - 0.5) * 12;
    const theta = (i / nodes.length) * Math.PI * 2 + (Math.random() - 0.5) * 0.5;
    const phi = Math.PI * 0.3 + Math.random() * Math.PI * 0.4;
    n.x = r * Math.sin(phi) * Math.cos(theta);
    n.y = r * Math.cos(phi) + (Math.random() - 0.5) * 10;
    n.z = r * Math.sin(phi) * Math.sin(theta);
    n.vx = 0; n.vy = 0; n.vz = 0;
    nodeMap[n.id] = n;
});

// === THREE.JS SETUP ===
const W = window.innerWidth, H = window.innerHeight;
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(55, W / H, 0.1, 1200);
camera.position.set(0, 40, 130);
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false, powerPreference: 'high-performance' });
renderer.setSize(W, H);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setClearColor(0x0a0a0f);
document.getElementById('canvas-container').appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.08;
controls.minDistance = 30;
controls.maxDistance = 300;
controls.autoRotate = true;
controls.autoRotateSpeed = 0.3;

// Lights
scene.add(new THREE.AmbientLight(0x444455, 0.6));
const light1 = new THREE.PointLight(0xbc8cff, 1.5, 200);
light1.position.set(0, 20, 0);
scene.add(light1);
const light2 = new THREE.PointLight(0xd4a373, 1, 180);
light2.position.set(50, -10, 30);
scene.add(light2);
const light3 = new THREE.PointLight(0x4ecdc4, 0.8, 160);
light3.position.set(-40, 10, -30);
scene.add(light3);

// === STARFIELD ===
const starCount = 3000;
const starPos = new Float32Array(starCount * 3);
const starColors = new Float32Array(starCount * 3);
for (let i = 0; i < starCount; i++) {
    const r = 200 + Math.random() * 400;
    const theta = Math.random() * Math.PI * 2;
    const phi = Math.acos(2 * Math.random() - 1);
    starPos[i*3] = r * Math.sin(phi) * Math.cos(theta);
    starPos[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
    starPos[i*3+2] = r * Math.cos(phi);
    const brightness = 0.3 + Math.random() * 0.7;
    starColors[i*3] = brightness;
    starColors[i*3+1] = brightness;
    starColors[i*3+2] = brightness * (0.8 + Math.random() * 0.2);
}
const starsGeo = new THREE.BufferGeometry();
starsGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
starsGeo.setAttribute('color', new THREE.BufferAttribute(starColors, 3));
scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({ size: 0.5, vertexColors: true, transparent: true, opacity: 0.7 })));

// === GEOMETRY CACHE ===
const geoCache = {
    ico:   new THREE.IcosahedronGeometry(1, 2),
    sphere: new THREE.SphereGeometry(1, 16, 16),
    oct:   new THREE.OctahedronGeometry(1),
    box:   new THREE.BoxGeometry(1.5, 1.5, 1.5),
    tetra: new THREE.TetrahedronGeometry(1),
    cyl:   new THREE.CylinderGeometry(0.7, 0.7, 2, 16),
    dodec: new THREE.DodecahedronGeometry(1)
};

// === CREATE NODE MESHES ===
const meshes = [];
const meshMap = {};
const meshGroup = new THREE.Group();

for (const n of nodes) {
    const cfg = TYPE_CFG[n.type];
    const baseGeo = geoCache[cfg.geo];
    const color = n.color || cfg.color;
    const mat = new THREE.MeshStandardMaterial({
        color, roughness: 0.35, metalness: 0.25,
        emissive: cfg.emissive ? color : 0x000000,
        emissiveIntensity: cfg.emissive ? 0.6 : 0
    });
    const mesh = new THREE.Mesh(baseGeo, mat);
    mesh.scale.setScalar(n.size);
    mesh.position.set(n.x, n.y, n.z);
    mesh.userData = n;
    meshGroup.add(mesh);
    meshes.push(mesh);
    meshMap[n.id] = mesh;

    // Glow halo for primitives
    if (cfg.emissive) {
        const haloMat = new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.07, side: THREE.BackSide });
        const halo = new THREE.Mesh(baseGeo, haloMat);
        halo.scale.setScalar(n.size * 2.5);
        halo.position.copy(mesh.position);
        meshGroup.add(halo);
        n._halo = halo;
    }
}
scene.add(meshGroup);

// === CREATE EDGE LINES ===
const edgeLines = [];
for (const ed of edges) {
    const srcN = nodeMap[ed.s];
    const tgtN = nodeMap[ed.e];
    if (!srcN || !tgtN) continue;
    const positions = new Float32Array(6);
    const geo = new THREE.BufferGeometry();
    geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    const srcCfg = TYPE_CFG[srcN.type];
    const lineColor = srcCfg.color;
    const mat = new THREE.LineBasicMaterial({ color: lineColor, transparent: true, opacity: Math.min(0.35, 0.15 + (ed.w || 1) * 0.08) });
    const line = new THREE.Line(geo, mat);
    scene.add(line);
    edgeLines.push({ line, s: ed.s, e: ed.e });
}

function updateEdgePositions() {
    for (const el of edgeLines) {
        const sm = meshMap[el.s];
        const em = meshMap[el.e];
        if (!sm || !em) continue;
        const p = el.line.geometry.attributes.position.array;
        p[0] = sm.position.x; p[1] = sm.position.y; p[2] = sm.position.z;
        p[3] = em.position.x; p[4] = em.position.y; p[5] = em.position.z;
        el.line.geometry.attributes.position.needsUpdate = true;
    }
}

// === FORCE SIMULATION ===
let simAlpha = 1.0;
let simRunning = true;

function simulateStep() {
    if (!simRunning || simAlpha < 0.001) { simRunning = false; return; }
    simAlpha *= 0.992;

    // Repulsion
    for (let i = 0; i < nodes.length; i++) {
        for (let j = i + 1; j < nodes.length; j++) {
            const a = nodes[i], b = nodes[j];
            const dx = a.x - b.x, dy = a.y - b.y, dz = a.z - b.z;
            const dist2 = dx*dx + dy*dy + dz*dz + 1;
            const dist = Math.sqrt(dist2);
            const force = simAlpha * 600 / dist2;
            const fx = (dx/dist)*force, fy = (dy/dist)*force, fz = (dz/dist)*force;
            a.vx += fx; a.vy += fy; a.vz += fz;
            b.vx -= fx; b.vy -= fy; b.vz -= fz;
        }
    }

    // Attraction
    for (const ed of edges) {
        const a = nodeMap[ed.s], b = nodeMap[ed.e];
        if (!a || !b) continue;
        const dx = b.x - a.x, dy = b.y - a.y, dz = b.z - a.z;
        const dist = Math.sqrt(dx*dx + dy*dy + dz*dz) + 0.1;
        const force = simAlpha * 0.015 * (dist - 18) * (ed.w || 1);
        a.vx += (dx/dist)*force; a.vy += (dy/dist)*force; a.vz += (dz/dist)*force;
        b.vx -= (dx/dist)*force; b.vy -= (dy/dist)*force; b.vz -= (dz/dist)*force;
    }

    // Center gravity + damping
    for (const n of nodes) {
        n.vx -= n.x * 0.008 * simAlpha;
        n.vy -= n.y * 0.008 * simAlpha;
        n.vz -= n.z * 0.008 * simAlpha;
        const damp = 0.88;
        n.vx *= damp; n.vy *= damp; n.vz *= damp;
        const maxV = 4;
        n.vx = Math.max(-maxV, Math.min(maxV, n.vx));
        n.vy = Math.max(-maxV, Math.min(maxV, n.vy));
        n.vz = Math.max(-maxV, Math.min(maxV, n.vz));
        n.x += n.vx; n.y += n.vy; n.z += n.vz;

        const m = meshMap[n.id];
        m.position.set(n.x, n.y, n.z);
        if (n._halo) n._halo.position.set(n.x, n.y, n.z);
    }

    updateEdgePositions();
}

// === LABELS ===
const labelsContainer = document.getElementById('labels-container');
const labelEls = {};
for (const n of nodes) {
    const el = document.createElement('div');
    el.className = 'node-label';
    const cfg = TYPE_CFG[n.type];
    el.style.color = n.color ? '#' + n.color.toString(16).padStart(6, '0') : cfg.css;
    el.textContent = n.label;
    labelsContainer.appendChild(el);
    labelEls[n.id] = el;
}

let activeFilter = null;
function updateLabels() {
    const w = window.innerWidth, h = window.innerHeight;
    for (const n of nodes) {
        const m = meshMap[n.id];
        const v = m.position.clone().project(camera);
        const el = labelEls[n.id];
        if (v.z > 1 || v.z < -1) { el.style.opacity = '0'; continue; }
        const sx = (v.x * 0.5 + 0.5) * w;
        const sy = (-v.y * 0.5 + 0.5) * h;
        el.style.left = sx + 'px';
        el.style.top = (sy - n.size * 8 - 10) + 'px';

        // Show labels based on type importance and distance
        const camDist = camera.position.distanceTo(m.position);
        const important = n.type === 'primitive' || n.type === 'breed' || n.type === 'registry';
        const show = (activeFilter && n.type === activeFilter) || important || camDist < 80;
        el.style.opacity = show ? '1' : '0';
        el.style.fontSize = n.type === 'primitive' ? '11px' : '9px';
        el.style.fontWeight = n.type === 'primitive' ? '700' : '400';
    }
}

// === RAYCASTING ===
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
const tooltip = document.getElementById('tooltip');
let hoveredMesh = null;

renderer.domElement.addEventListener('mousemove', (ev) => {
    mouse.x = (ev.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(ev.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObjects(meshes);
    if (hits.length > 0 && hits[0].object.userData.id) {
        const n = hits[0].object.userData;
        if (hoveredMesh !== hits[0].object) {
            hoveredMesh = hits[0].object;
            hoveredMesh.material.emissiveIntensity = 0.8;
        }
        tooltip.style.display = 'block';
        tooltip.style.left = (ev.clientX + 15) + 'px';
        tooltip.style.top = (ev.clientY + 15) + 'px';
        const cfg = TYPE_CFG[n.type];
        let html = `<strong>${n.label}</strong><br><span class="tt-type">${cfg.label.toUpperCase()}</span>`;
        if (n.count) html += `<br>Count: ${n.count.toLocaleString()}`;
        if (n.desc) html += `<br><span style="color:#8a8578">${n.desc}</span>`;
        tooltip.innerHTML = html;
        renderer.domElement.style.cursor = 'pointer';
    } else {
        if (hoveredMesh) {
            const cfg = TYPE_CFG[hoveredMesh.userData.type];
            hoveredMesh.material.emissiveIntensity = cfg.emissive ? 0.6 : 0;
            hoveredMesh = null;
        }
        tooltip.style.display = 'none';
        renderer.domElement.style.cursor = 'grab';
    }
});

// Click to inspect
renderer.domElement.addEventListener('click', (ev) => {
    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObjects(meshes);
    if (hits.length > 0 && hits[0].object.userData.id) {
        showDetail(hits[0].object.userData);
    } else {
        document.getElementById('detail-panel').style.display = 'none';
    }
});

function showDetail(n) {
    const dp = document.getElementById('detail-panel');
    dp.style.display = 'block';
    document.getElementById('detail-name').textContent = n.label;
    document.getElementById('detail-type').textContent = TYPE_CFG[n.type].label.toUpperCase();
    let stats = '';
    if (n.count) stats += `<div class="detail-stat">Count: <strong>${n.count.toLocaleString()}</strong></div>`;
    if (n.desc) stats += `<div class="detail-stat">${n.desc}</div>`;
    document.getElementById('detail-stats').innerHTML = stats;

    // Find connections
    const conns = [];
    for (const ed of edges) {
        if (ed.s === n.id) { const t = nodeMap[ed.e]; if (t) conns.push(t.label); }
        if (ed.e === n.id) { const t = nodeMap[ed.s]; if (t) conns.push(t.label); }
    }
    document.getElementById('conn-list').innerHTML = conns.map(c =>
        `<div class="conn-item">${c}</div>`
    ).join('');
}

// === POPULATE DASHBOARD CHARTS ===
function makeBarChart(containerId, data, maxVal, colorFn) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    for (const d of data) {
        const pct = (d.value / maxVal * 100).toFixed(1);
        const row = document.createElement('div');
        row.className = 'chart-row';
        row.innerHTML = `<span class="chart-label">${d.label}</span><div class="chart-fill" style="width:${pct}%;background:${colorFn(d)}"></div><span class="chart-value">${d.display || d.value.toLocaleString()}</span>`;
        container.appendChild(row);
    }
}

makeBarChart('sales-chart',
    [{label:'2017',value:88},{label:'2018',value:245},{label:'2019',value:281},{label:'2020',value:270},{label:'2021',value:185},{label:'2022',value:107}],
    281, () => 'linear-gradient(90deg,#d4a373,#bc8cff)');

makeBarChart('state-chart',
    [{label:'IN',value:14552},{label:'OK',value:9177},{label:'TX',value:9174},{label:'IL',value:5542},{label:'OH',value:4047},{label:'MO',value:2999},{label:'IA',value:2699},{label:'WI',value:2342}],
    14552, () => 'linear-gradient(90deg,#ffe066,#d4a373)');

makeBarChart('breed-chart',
    [{label:'Chester',value:18702,c:'#D2691E'},{label:'Spot',value:18623,c:'#808080'},{label:'Poland',value:16655,c:'#666666'},{label:'Hereford',value:11432,c:'#B22222'},{label:'Berkshire',value:8808,c:'#8B4513'},{label:'Duroc',value:3763,c:'#CD5C5C'},{label:'Hampshire',value:3763,c:'#2E8B57'}],
    18702, d => d.c || '#d4a373');

makeBarChart('type-chart',
    [{label:'BARROW',value:466,display:'466 sold'},{label:'GILT',value:430,display:'430 sold'},{label:'BOAR',value:30,display:'30 sold'}],
    466, () => '#a8e6cf');

// === LEGEND + FILTER BUTTONS ===
const legend = document.getElementById('legend');
const typeFilters = document.getElementById('type-filters');
const typeCounts = {};
for (const n of nodes) typeCounts[n.type] = (typeCounts[n.type] || 0) + 1;

for (const [type, cfg] of Object.entries(TYPE_CFG)) {
    if (!typeCounts[type]) continue;
    // Legend item
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML = `<div class="legend-dot" style="background:${cfg.css}"></div><span>${cfg.label}</span><span class="legend-count">${typeCounts[type]}</span>`;
    item.addEventListener('click', () => toggleFilter(type));
    legend.appendChild(item);

    // Filter button
    const btn = document.createElement('button');
    btn.className = 'filter-btn';
    btn.textContent = cfg.label.split(' ')[0];
    btn.dataset.type = type;
    btn.addEventListener('click', () => toggleFilter(type));
    typeFilters.appendChild(btn);
}

// Add "All" button
const allBtn = document.createElement('button');
allBtn.className = 'filter-btn active';
allBtn.textContent = 'All';
allBtn.addEventListener('click', () => toggleFilter(null));
typeFilters.prepend(allBtn);

function toggleFilter(type) {
    activeFilter = activeFilter === type ? null : type;
    document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.toggle('active', activeFilter === null ? b.textContent === 'All' : b.dataset.type === activeFilter);
    });
    // Dim non-matching nodes
    for (const m of meshes) {
        const n = m.userData;
        if (!activeFilter || n.type === activeFilter) {
            m.material.opacity = 1;
            m.material.transparent = false;
            m.visible = true;
        } else {
            m.material.opacity = 0.12;
            m.material.transparent = true;
            m.visible = true;
        }
    }
    // Dim edges
    for (const el of edgeLines) {
        const sn = nodeMap[el.s], en = nodeMap[el.e];
        if (!activeFilter || (sn && sn.type === activeFilter) || (en && en.type === activeFilter)) {
            el.line.material.opacity = 0.3;
        } else {
            el.line.material.opacity = 0.03;
        }
    }
}

// === ANIMATION LOOP ===
let frameCount = 0;
function animate() {
    requestAnimationFrame(animate);
    frameCount++;

    // Run simulation
    simulateStep();

    // Rotate primitives slowly
    for (const m of meshes) {
        if (m.userData.type === 'primitive') {
            m.rotation.x += 0.004;
            m.rotation.y += 0.003;
        }
    }

    // Pulse primitive halos
    const pulse = 0.06 + Math.sin(frameCount * 0.02) * 0.03;
    for (const n of nodes) {
        if (n._halo) n._halo.material.opacity = pulse;
    }

    controls.update();
    updateLabels();
    renderer.render(scene, camera);
}

// === RESIZE ===
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

// === START ===
updateEdgePositions();
animate();

// Fade out controls hint
setTimeout(() => {
    const hint = document.getElementById('controls-hint');
    hint.style.transition = 'opacity 2s';
    hint.style.opacity = '0';
    setTimeout(() => hint.remove(), 2000);
}, 8000);
</script>
</body>
</html>
