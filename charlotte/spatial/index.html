<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Charlotte Spatial Substrate</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: #0A0A0A;
      color: #E8E0E0;
      overflow: hidden;
      height: 100vh;
    }

    /* ── Layout ── */
    .app { display: flex; height: 100vh; }
    .sidebar {
      width: 320px;
      min-width: 320px;
      background: #111;
      border-right: 1px solid #222;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #111;
      border-bottom: 1px solid #222;
      flex-wrap: wrap;
    }

    /* ── Sidebar ── */
    h1 { font-size: 16px; font-weight: 700; letter-spacing: -0.3px; color: #E53E3E; }
    .subtitle { font-size: 11px; color: #666; margin-top: 2px; }

    .section-title {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 1px; color: #555; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: baseline;
    }
    .section-title .total { font-size: 9px; color: #E53E3E; font-weight: 600; letter-spacing: 0; text-transform: none; }

    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .stat-card { background: #1A1A1A; border: 1px solid #222; border-radius: 8px; padding: 10px 12px; }
    .stat-card.wide { grid-column: span 2; }
    .stat-val { font-size: 18px; font-weight: 700; color: #E53E3E; letter-spacing: -0.5px; }
    .stat-val.green { color: #68D391; }
    .stat-val.amber { color: #F59E0B; }
    .stat-val.blue { color: #4A9EE5; }
    .stat-label { font-size: 10px; color: #666; margin-top: 2px; text-transform: uppercase; letter-spacing: 0.3px; }

    .insight {
      background: rgba(229,62,62,0.06); border: 1px solid rgba(229,62,62,0.15);
      border-radius: 8px; padding: 12px; font-size: 11px; line-height: 1.6; color: #999;
    }
    .insight strong { color: #E8E0E0; }
    .insight .hl { color: #E53E3E; font-weight: 600; }

    /* ── Region Legend ── */
    .legend { display: flex; flex-wrap: wrap; gap: 8px; }
    .legend-item {
      display: flex; align-items: center; gap: 5px;
      font-size: 10px; color: #888; cursor: pointer;
      padding: 3px 8px; border-radius: 4px;
      transition: background 0.15s;
    }
    .legend-item:hover { background: #1A1A1A; }
    .legend-item.dimmed { opacity: 0.3; }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

    /* ── Spatial Compass ── */
    #spatial-compass { max-width: 160px; margin: 0 auto; }
    #spatial-compass svg { width: 100%; height: auto; }
    .compass-caption { font-size: 9px; color: #444; text-align: center; margin-top: 4px; }

    /* ── Toolbar ── */
    .tool-label { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .tool-btn {
      background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
      border-radius: 4px; padding: 4px 10px; font-size: 10px; color: #666;
      font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s;
    }
    .tool-btn:hover { background: rgba(255,255,255,0.08); color: #999; }
    .tool-btn.active { background: rgba(229,62,62,0.15); border-color: rgba(229,62,62,0.3); color: #F56565; }
    .tool-sep { width: 1px; height: 20px; background: #222; }
    .tool-info { font-size: 10px; color: #444; margin-left: auto; }

    /* ── Graph SVG ── */
    #graph-container { flex: 1; position: relative; overflow: hidden; }
    #graph-container svg { width: 100%; height: 100%; }

    /* ── Inspector Panel ── */
    #inspector {
      position: absolute; right: 16px; top: 16px;
      width: 300px; max-height: calc(100vh - 100px);
      background: #141414; border: 1px solid #222; border-radius: 12px;
      padding: 0; z-index: 100; display: none;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      overflow: hidden;
    }
    #inspector.show { display: flex; flex-direction: column; }
    .insp-header {
      padding: 16px; border-bottom: 1px solid #222;
      display: flex; align-items: center; gap: 12px;
    }
    .insp-header h2 { font-size: 16px; font-weight: 700; flex: 1; }
    .insp-close {
      width: 24px; height: 24px; border-radius: 50%; border: none;
      background: #222; color: #888; font-size: 14px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .insp-close:hover { background: #333; color: #E8E0E0; }
    .insp-badge {
      display: inline-block; font-size: 9px; padding: 2px 8px;
      border-radius: 3px; text-transform: uppercase; letter-spacing: 0.4px;
      font-weight: 600;
    }
    .insp-hull-preview {
      padding: 12px 16px; background: #111; border-bottom: 1px solid #222;
      display: flex; justify-content: center;
    }
    .insp-hull-preview svg { max-width: 100%; max-height: 140px; }
    .insp-body {
      padding: 16px; overflow-y: auto; flex: 1;
      display: flex; flex-direction: column; gap: 12px;
    }
    .insp-row { display: flex; justify-content: space-between; font-size: 11px; }
    .insp-row .label { color: #666; }
    .insp-row .value { color: #E8E0E0; font-weight: 500; font-variant-numeric: tabular-nums; }
    .insp-section-title {
      font-size: 9px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.8px; color: #555; margin-top: 4px;
    }
    .insp-adj-list { display: flex; flex-wrap: wrap; gap: 4px; }
    .insp-adj-tag {
      font-size: 9px; padding: 2px 6px; border-radius: 3px;
      background: #1A1A1A; border: 1px solid #333; color: #999;
      cursor: pointer; transition: all 0.15s;
    }
    .insp-adj-tag:hover { border-color: #E53E3E; color: #E8E0E0; }
    .insp-dir-list {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 3px; max-height: 200px; overflow-y: auto;
    }
    .insp-dir-item {
      font-size: 9px; display: flex; justify-content: space-between;
      padding: 2px 4px; border-radius: 2px; cursor: pointer;
    }
    .insp-dir-item:hover { background: #1A1A1A; }
    .insp-dir-item .dir { color: #E53E3E; font-weight: 600; width: 20px; }
    .insp-dir-item .tgt { color: #999; flex: 1; }
    .insp-dir-item .km { color: #555; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
<div class="app">

  <!-- ═══ Sidebar ═══ -->
  <div class="sidebar">
    <div>
      <h1>Spatial Substrate</h1>
      <p class="subtitle">Charlotte's perception of US geographic space</p>
    </div>

    <!-- Spatial Compass -->
    <div>
      <div class="section-title">Spatial Compass</div>
      <div id="spatial-compass">
        <svg viewBox="0 0 160 160">
          <circle cx="80" cy="80" r="55" fill="none" stroke="#1A1A1A" stroke-width="1"/>
          <circle cx="80" cy="80" r="28" fill="none" stroke="#1A1A1A" stroke-width="1"/>
          <circle cx="80" cy="80" r="4" fill="#E53E3E" opacity="0.3"/>
          <circle cx="80" cy="80" r="2" fill="#E53E3E"/>
          <!-- N -->
          <line x1="80" y1="72" x2="80" y2="28" stroke="#E53E3E" stroke-width="1.5"/>
          <text x="80" y="20" text-anchor="middle" fill="#E53E3E" font-size="8" font-family="Inter" font-weight="700">N</text>
          <!-- S -->
          <line x1="80" y1="88" x2="80" y2="132" stroke="#4A9EE5" stroke-width="1.5"/>
          <text x="80" y="146" text-anchor="middle" fill="#4A9EE5" font-size="8" font-family="Inter" font-weight="700">S</text>
          <!-- E -->
          <line x1="88" y1="80" x2="132" y2="80" stroke="#68D391" stroke-width="1.5"/>
          <text x="144" y="83" text-anchor="middle" fill="#68D391" font-size="8" font-family="Inter" font-weight="700">E</text>
          <!-- W -->
          <line x1="72" y1="80" x2="28" y2="80" stroke="#F59E0B" stroke-width="1.5"/>
          <text x="16" y="83" text-anchor="middle" fill="#F59E0B" font-size="8" font-family="Inter" font-weight="700">W</text>
          <!-- Diagonals -->
          <line x1="85" y1="75" x2="116" y2="44" stroke="#555" stroke-width="0.5"/>
          <text x="122" y="40" text-anchor="middle" fill="#555" font-size="6" font-family="Inter" font-weight="600">NE</text>
          <line x1="85" y1="85" x2="116" y2="116" stroke="#555" stroke-width="0.5"/>
          <text x="122" y="122" text-anchor="middle" fill="#555" font-size="6" font-family="Inter" font-weight="600">SE</text>
          <line x1="75" y1="85" x2="44" y2="116" stroke="#555" stroke-width="0.5"/>
          <text x="38" y="122" text-anchor="middle" fill="#555" font-size="6" font-family="Inter" font-weight="600">SW</text>
          <line x1="75" y1="75" x2="44" y2="44" stroke="#555" stroke-width="0.5"/>
          <text x="38" y="40" text-anchor="middle" fill="#555" font-size="6" font-family="Inter" font-weight="600">NW</text>
        </svg>
      </div>
      <p class="compass-caption">8 cardinal directions between all state pairs</p>
    </div>

    <!-- Stats -->
    <div>
      <div class="section-title">Substrate <span class="total">4,604 KRF facts</span></div>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-val">51</div>
          <div class="stat-label">State Nodes</div>
        </div>
        <div class="stat-card">
          <div class="stat-val green">5</div>
          <div class="stat-label">Regions</div>
        </div>
        <div class="stat-card">
          <div class="stat-val amber">107</div>
          <div class="stat-label">Adjacent Pairs</div>
        </div>
        <div class="stat-card">
          <div class="stat-val blue">1,275</div>
          <div class="stat-label">Direction Edges</div>
        </div>
        <div class="stat-card wide">
          <div class="stat-val">2,550</div>
          <div class="stat-label">Bidirectional Cardinal Edges</div>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div>
      <div class="section-title">Regions</div>
      <div class="legend" id="legend"></div>
    </div>

    <!-- Insights -->
    <div class="insight">
      Every state knows its <strong>cardinal direction</strong> and <strong>distance</strong> to every other state.
      <span class="hl">1,275 directional edges</span> form a complete spatial knowledge graph.
      Click any state to explore its relationships.
    </div>
    <div class="insight">
      The <strong>convex hull</strong> of each state captures its geographic footprint as ordered vertices.
      The <span class="hl">continental hull</span> (23 points) wraps the entire lower 48.
      Every business operation maps onto this shared spatial substrate.
    </div>
  </div>

  <!-- ═══ Main ═══ -->
  <div class="main">
    <div class="toolbar">
      <span class="tool-label">View</span>
      <button class="tool-btn active" id="btn-graph" onclick="setView('graph')">Graph</button>
      <button class="tool-btn" id="btn-map" onclick="setView('map')">Map</button>
      <div class="tool-sep"></div>
      <span class="tool-label">Edges</span>
      <button class="tool-btn active" id="btn-adj" onclick="toggleEdgeType('adjacent')">Adjacent</button>
      <button class="tool-btn" id="btn-dir" onclick="toggleEdgeType('direction')">Directions</button>
      <div class="tool-sep"></div>
      <span class="tool-label">Layout</span>
      <button class="tool-btn" id="btn-reheat" onclick="reheat()">Reheat</button>
      <span class="tool-info" id="graph-info"></span>
    </div>
    <div id="graph-container"></div>
    <div id="inspector">
      <div class="insp-header">
        <h2 id="insp-name"></h2>
        <span class="insp-badge" id="insp-region"></span>
        <button class="insp-close" onclick="closeInspector()">&times;</button>
      </div>
      <div class="insp-hull-preview" id="insp-hull"></div>
      <div class="insp-body" id="insp-body"></div>
    </div>
  </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
(function() {

  // ════════════════════════════════════════════════════════════════
  // CONSTANTS
  // ════════════════════════════════════════════════════════════════

  var REGION_COLORS = {
    'W':  '#E53E3E',
    'MW': '#F59E0B',
    'NE': '#4A9EE5',
    'SE': '#68D391',
    'SW': '#FB923C'
  };
  var REGION_NAMES = {
    'W': 'West', 'MW': 'Midwest', 'NE': 'Northeast', 'SE': 'Southeast', 'SW': 'Southwest'
  };

  var currentView = 'graph';
  var showAdjacent = true;
  var showDirection = false;
  var selectedNode = null;
  var dimmedRegions = {};

  // ════════════════════════════════════════════════════════════════
  // DATA
  // ════════════════════════════════════════════════════════════════

  var DATA = null;
  var nodeMap = {};
  var adjEdges = [];
  var allEdges = [];

  function loadData() {
    return fetch('us-states.json').then(function(r) { return r.json(); }).then(function(d) {
      DATA = d;
      DATA.nodes.forEach(function(n) { nodeMap[n.id] = n; });
      DATA.edges.forEach(function(e) {
        allEdges.push(e);
        if (e.adjacent) adjEdges.push(e);
      });
    });
  }

  // ════════════════════════════════════════════════════════════════
  // LEGEND
  // ════════════════════════════════════════════════════════════════

  function buildLegend() {
    var el = document.getElementById('legend');
    var html = '';
    Object.keys(REGION_COLORS).forEach(function(r) {
      html += '<div class="legend-item" data-region="'+r+'" onclick="toggleRegion(\''+r+'\')">';
      html += '<span class="legend-dot" style="background:'+REGION_COLORS[r]+'"></span>';
      html += REGION_NAMES[r];
      html += '</div>';
    });
    el.innerHTML = html;
  }

  window.toggleRegion = function(r) {
    dimmedRegions[r] = !dimmedRegions[r];
    var items = document.querySelectorAll('.legend-item');
    items.forEach(function(it) {
      if (it.getAttribute('data-region') === r) {
        it.classList.toggle('dimmed');
      }
    });
    updateVisibility();
  };

  // ════════════════════════════════════════════════════════════════
  // D3 FORCE GRAPH
  // ════════════════════════════════════════════════════════════════

  var svg, sim, nodeEls, edgeEls, labelEls, gEdges, gNodes;
  var width, height;

  function initGraph() {
    var container = document.getElementById('graph-container');
    width = container.offsetWidth;
    height = container.offsetHeight;

    svg = d3.select('#graph-container').append('svg')
      .attr('width', width).attr('height', height);

    // Defs for glow
    var defs = svg.append('defs');
    Object.keys(REGION_COLORS).forEach(function(r) {
      var f = defs.append('filter').attr('id', 'glow-'+r).attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
      f.append('feGaussianBlur').attr('stdDeviation', '3').attr('result', 'blur');
      f.append('feFlood').attr('flood-color', REGION_COLORS[r]).attr('flood-opacity', '0.4').attr('result', 'color');
      f.append('feComposite').attr('in', 'color').attr('in2', 'blur').attr('operator', 'in').attr('result', 'glow');
      var merge = f.append('feMerge');
      merge.append('feMergeNode').attr('in', 'glow');
      merge.append('feMergeNode').attr('in', 'SourceGraphic');
    });

    var zoom = d3.zoom().scaleExtent([0.3, 5]).on('zoom', function(e) {
      gEdges.attr('transform', e.transform);
      gNodes.attr('transform', e.transform);
    });
    svg.call(zoom);

    gEdges = svg.append('g').attr('class', 'edges');
    gNodes = svg.append('g').attr('class', 'nodes');

    // Prepare simulation data
    var simNodes = DATA.nodes.map(function(n) {
      return { id: n.id, name: n.name, region: n.region, centroid: n.centroid, hull: n.hull, hull_points: n.hull_points, fips: n.fips };
    });

    var simEdges = adjEdges.map(function(e) {
      return { source: e.source, target: e.target };
    });

    sim = d3.forceSimulation(simNodes)
      .force('link', d3.forceLink(simEdges).id(function(d) { return d.id; }).distance(60).strength(0.5))
      .force('charge', d3.forceManyBody().strength(-200))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide(20))
      .on('tick', ticked);

    // Edges
    edgeEls = gEdges.selectAll('line').data(simEdges).enter().append('line')
      .attr('stroke', '#333').attr('stroke-width', 0.5).attr('stroke-opacity', 0.4);

    // Node groups
    var ng = gNodes.selectAll('g').data(simNodes).enter().append('g')
      .attr('cursor', 'pointer')
      .call(d3.drag().on('start', dragStart).on('drag', dragging).on('end', dragEnd))
      .on('click', function(ev, d) { ev.stopPropagation(); selectNode(d); });

    // Node circles
    ng.append('circle')
      .attr('r', function(d) { return d.id === 'AK' || d.id === 'TX' || d.id === 'CA' ? 14 : 10; })
      .attr('fill', function(d) { return REGION_COLORS[d.region]; })
      .attr('fill-opacity', 0.15)
      .attr('stroke', function(d) { return REGION_COLORS[d.region]; })
      .attr('stroke-width', 1.5)
      .attr('filter', function(d) { return 'url(#glow-'+d.region+')'; });

    // Labels
    ng.append('text')
      .text(function(d) { return d.id; })
      .attr('text-anchor', 'middle').attr('dy', '0.35em')
      .attr('fill', function(d) { return REGION_COLORS[d.region]; })
      .attr('font-size', '8px').attr('font-family', 'Inter').attr('font-weight', '700');

    nodeEls = ng;

    // Click background to deselect
    svg.on('click', function() { closeInspector(); deselectNode(); });

    updateInfo();
  }

  function ticked() {
    edgeEls.attr('x1', function(d) { return d.source.x; }).attr('y1', function(d) { return d.source.y; })
           .attr('x2', function(d) { return d.target.x; }).attr('y2', function(d) { return d.target.y; });
    nodeEls.attr('transform', function(d) { return 'translate('+d.x+','+d.y+')'; });
  }

  function dragStart(ev, d) { if (!ev.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
  function dragging(ev, d) { d.fx = ev.x; d.fy = ev.y; }
  function dragEnd(ev, d) { if (!ev.active) sim.alphaTarget(0); d.fx = null; d.fy = null; }

  // ════════════════════════════════════════════════════════════════
  // MAP VIEW
  // ════════════════════════════════════════════════════════════════

  function setToMapLayout() {
    sim.stop();
    var simNodes = sim.nodes();
    // Project centroids to screen using equirectangular
    var lngs = simNodes.map(function(n) { return n.centroid[0]; });
    var lats = simNodes.map(function(n) { return n.centroid[1]; });
    // Filter out Alaska for scale
    var contLngs = simNodes.filter(function(n) { return n.id !== 'AK' && n.id !== 'HI'; }).map(function(n) { return n.centroid[0]; });
    var contLats = simNodes.filter(function(n) { return n.id !== 'AK' && n.id !== 'HI'; }).map(function(n) { return n.centroid[1]; });

    var minLng = Math.min.apply(null, contLngs), maxLng = Math.max.apply(null, contLngs);
    var minLat = Math.min.apply(null, contLats), maxLat = Math.max.apply(null, contLats);
    var pad = 60;

    simNodes.forEach(function(n) {
      var px = pad + ((n.centroid[0] - minLng) / (maxLng - minLng)) * (width - 2 * pad);
      var py = pad + ((maxLat - n.centroid[1]) / (maxLat - minLat)) * (height - 2 * pad);
      // Special handling for AK/HI
      if (n.id === 'AK') { px = pad + 40; py = height - pad - 40; }
      if (n.id === 'HI') { px = pad + 140; py = height - pad - 20; }
      n.fx = px; n.fy = py;
    });
    sim.alpha(0.5).restart();
  }

  function setToGraphLayout() {
    sim.nodes().forEach(function(n) { n.fx = null; n.fy = null; });
    sim.alpha(0.8).restart();
  }

  window.setView = function(v) {
    currentView = v;
    document.getElementById('btn-graph').classList.toggle('active', v === 'graph');
    document.getElementById('btn-map').classList.toggle('active', v === 'map');
    if (v === 'map') setToMapLayout();
    else setToGraphLayout();
  };

  window.reheat = function() {
    if (currentView === 'map') setToMapLayout();
    else { sim.alpha(0.8).restart(); }
  };

  // ════════════════════════════════════════════════════════════════
  // EDGE VISIBILITY
  // ════════════════════════════════════════════════════════════════

  var dirEdgeEls = null;

  window.toggleEdgeType = function(type) {
    if (type === 'adjacent') {
      showAdjacent = !showAdjacent;
      document.getElementById('btn-adj').classList.toggle('active');
      edgeEls.attr('visibility', showAdjacent ? 'visible' : 'hidden');
    }
    if (type === 'direction') {
      showDirection = !showDirection;
      document.getElementById('btn-dir').classList.toggle('active');
      if (showDirection && selectedNode) {
        showDirectionEdges(selectedNode.id);
      } else {
        hideDirectionEdges();
      }
    }
  };

  function showDirectionEdges(nodeId) {
    hideDirectionEdges();
    if (!showDirection) return;

    var simNodeMap = {};
    sim.nodes().forEach(function(n) { simNodeMap[n.id] = n; });

    var dirs = allEdges.filter(function(e) { return e.source === nodeId; });
    dirEdgeEls = gEdges.selectAll('.dir-edge').data(dirs).enter().append('line')
      .attr('class', 'dir-edge')
      .attr('stroke', function(d) {
        var dirColors = { N: '#E53E3E', S: '#4A9EE5', E: '#68D391', W: '#F59E0B',
                          NE: '#EC8F5C', SE: '#58B8C8', NW: '#D19844', SW: '#94B074' };
        return dirColors[d.direction] || '#555';
      })
      .attr('stroke-width', 0.8)
      .attr('stroke-opacity', 0.3)
      .attr('stroke-dasharray', '3,3')
      .attr('x1', function(d) { return simNodeMap[d.source] ? simNodeMap[d.source].x : 0; })
      .attr('y1', function(d) { return simNodeMap[d.source] ? simNodeMap[d.source].y : 0; })
      .attr('x2', function(d) { return simNodeMap[d.target] ? simNodeMap[d.target].x : 0; })
      .attr('y2', function(d) { return simNodeMap[d.target] ? simNodeMap[d.target].y : 0; });

    // Update on tick
    sim.on('tick.dir', function() {
      if (dirEdgeEls) {
        dirEdgeEls
          .attr('x1', function(d) { return simNodeMap[d.source] ? simNodeMap[d.source].x : 0; })
          .attr('y1', function(d) { return simNodeMap[d.source] ? simNodeMap[d.source].y : 0; })
          .attr('x2', function(d) { return simNodeMap[d.target] ? simNodeMap[d.target].x : 0; })
          .attr('y2', function(d) { return simNodeMap[d.target] ? simNodeMap[d.target].y : 0; });
      }
    });
  }

  function hideDirectionEdges() {
    gEdges.selectAll('.dir-edge').remove();
    dirEdgeEls = null;
    sim.on('tick.dir', null);
  }

  function updateVisibility() {
    nodeEls.attr('opacity', function(d) { return dimmedRegions[d.region] ? 0.1 : 1; });
    edgeEls.attr('opacity', function(d) {
      return (dimmedRegions[d.source.region] || dimmedRegions[d.target.region]) ? 0.05 : 0.4;
    });
  }

  // ════════════════════════════════════════════════════════════════
  // NODE SELECTION + INSPECTOR
  // ════════════════════════════════════════════════════════════════

  function selectNode(d) {
    selectedNode = d;
    // Highlight
    nodeEls.select('circle')
      .attr('stroke-width', function(n) { return n.id === d.id ? 3 : 1.5; })
      .attr('fill-opacity', function(n) { return n.id === d.id ? 0.3 : 0.15; });

    if (showDirection) showDirectionEdges(d.id);

    openInspector(d);
    updateInfo();
  }

  function deselectNode() {
    selectedNode = null;
    nodeEls.select('circle').attr('stroke-width', 1.5).attr('fill-opacity', 0.15);
    hideDirectionEdges();
    updateInfo();
  }

  function openInspector(d) {
    var el = document.getElementById('inspector');
    el.classList.add('show');

    // Header
    document.getElementById('insp-name').textContent = d.name + ' (' + d.id + ')';
    var badge = document.getElementById('insp-region');
    badge.textContent = REGION_NAMES[d.region];
    badge.style.background = REGION_COLORS[d.region] + '22';
    badge.style.color = REGION_COLORS[d.region];

    // Hull preview SVG
    var hullEl = document.getElementById('insp-hull');
    var node = nodeMap[d.id];
    if (node && node.hull && node.hull.length > 2) {
      var hull = node.hull;
      var lngs = hull.map(function(p) { return p[0]; });
      var lats = hull.map(function(p) { return p[1]; });
      var mnLng = Math.min.apply(null, lngs), mxLng = Math.max.apply(null, lngs);
      var mnLat = Math.min.apply(null, lats), mxLat = Math.max.apply(null, lats);
      var pad = 10, svgW = 260, svgH = 120;
      var scale = Math.min((svgW - 2*pad) / (mxLng - mnLng || 1), (svgH - 2*pad) / (mxLat - mnLat || 1));
      var pts = hull.map(function(p) {
        var x = pad + (p[0] - mnLng) * scale;
        var y = pad + (mxLat - p[1]) * scale;
        return x + ',' + y;
      }).join(' ');
      hullEl.innerHTML = '<svg viewBox="0 0 '+svgW+' '+svgH+'" width="'+svgW+'" height="'+svgH+'">' +
        '<rect width="'+svgW+'" height="'+svgH+'" fill="#0A0A0A" rx="4"/>' +
        '<polygon points="'+pts+'" fill="'+REGION_COLORS[d.region]+'" fill-opacity="0.15" stroke="'+REGION_COLORS[d.region]+'" stroke-width="1.5"/>' +
        '<text x="'+(svgW/2)+'" y="'+(svgH-6)+'" text-anchor="middle" fill="#444" font-size="7" font-family="Inter">' +
        node.hull_points + ' hull vertices</text></svg>';
    } else {
      hullEl.innerHTML = '<span style="color:#555;font-size:10px">No hull data</span>';
    }

    // Body
    var body = document.getElementById('insp-body');
    var html = '';

    // Meta
    html += '<div class="insp-row"><span class="label">FIPS</span><span class="value">' + d.fips + '</span></div>';
    html += '<div class="insp-row"><span class="label">Centroid</span><span class="value">' + d.centroid[0].toFixed(2) + ', ' + d.centroid[1].toFixed(2) + '</span></div>';
    html += '<div class="insp-row"><span class="label">Hull Points</span><span class="value">' + (d.hull_points || '?') + '</span></div>';

    // Adjacent
    var adjs = allEdges.filter(function(e) { return e.source === d.id && e.adjacent; });
    html += '<div class="insp-section-title">Adjacent States (' + adjs.length + ')</div>';
    html += '<div class="insp-adj-list">';
    adjs.forEach(function(e) {
      html += '<span class="insp-adj-tag" onclick="clickAdj(\''+e.target+'\')">' + e.target + '</span>';
    });
    if (adjs.length === 0) html += '<span style="color:#555;font-size:9px">None (island state)</span>';
    html += '</div>';

    // Directions (sorted by distance)
    var dirs = allEdges.filter(function(e) { return e.source === d.id; }).sort(function(a, b) { return a.distance_km - b.distance_km; });
    html += '<div class="insp-section-title">Cardinal Directions ('+dirs.length+' states)</div>';
    html += '<div class="insp-dir-list">';
    dirs.forEach(function(e) {
      html += '<div class="insp-dir-item" onclick="clickAdj(\''+e.target+'\')">';
      html += '<span class="dir">' + e.direction + '</span>';
      html += '<span class="tgt">' + e.target + '</span>';
      html += '<span class="km">' + Math.round(e.distance_km) + 'km</span>';
      html += '</div>';
    });
    html += '</div>';

    body.innerHTML = html;
  }

  window.clickAdj = function(id) {
    var simNode = sim.nodes().find(function(n) { return n.id === id; });
    if (simNode) selectNode(simNode);
  };

  window.closeInspector = function() {
    document.getElementById('inspector').classList.remove('show');
  };

  function updateInfo() {
    var info = document.getElementById('graph-info');
    var vis = showAdjacent ? adjEdges.length + ' adjacency edges' : 'edges hidden';
    if (selectedNode) vis += ' | Selected: ' + selectedNode.id;
    info.textContent = vis;
  }

  // ════════════════════════════════════════════════════════════════
  // INIT
  // ════════════════════════════════════════════════════════════════

  buildLegend();
  loadData().then(function() {
    initGraph();
  });

})();
</script>
</body>
</html>
