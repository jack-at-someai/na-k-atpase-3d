<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Charlotte Charts — v3.3</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f0f4f8; --surface: #ffffff; --card: #ffffff;
      --text: #001219; --textDim: #64748b; --textMuted: #94a3b8;
      --border: #e2e8f0; --primary: #0077b6; --accent: #21d6c6;
      --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
      --font: 'Roboto', sans-serif;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
    body { font-family: var(--font); background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; -webkit-font-smoothing: antialiased; min-height: 100dvh; }

    /* Navbar */
    .navbar {
      position: sticky; top: 0; z-index: 100; backdrop-filter: blur(16px) saturate(180%);
      background: rgba(var(--bg-rgb, 240,244,248), 0.82);
      border-bottom: 1px solid var(--border); padding: 0 max(12px, env(safe-area-inset-left)); height: 48px;
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .navbar-brand { display: flex; align-items: center; gap: 8px; min-width: 0; }
    .navbar-logo { width: 26px; height: 26px; border-radius: 7px; background: var(--primary); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 13px; flex-shrink: 0; }
    .navbar-title { font-size: 14px; font-weight: 600; letter-spacing: -0.01em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .navbar-title span { color: var(--textMuted); font-weight: 400; font-size: 12px; margin-left: 4px; }
    .navbar-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .badge { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 20px; background: var(--primary); color: #fff; letter-spacing: 0.02em; white-space: nowrap; }
    .theme-select {
      padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--surface); color: var(--text); font-family: var(--font);
      font-size: 13px; cursor: pointer; outline: none; font-weight: 500;
      min-height: 36px; /* touch target */
    }
    .theme-select:focus { border-color: var(--primary); }

    /* Main — fluid padding with safe area insets */
    .main { max-width: 1400px; margin: 0 auto; padding: 0 max(12px, env(safe-area-inset-left)) 80px; }

    /* Story header */
    .story { margin-top: 48px; }
    .story-num { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--primary); margin-bottom: 4px; opacity: 0.85; }
    .story-title { font-size: clamp(18px, 4vw, 24px); font-weight: 700; letter-spacing: -0.02em; margin-bottom: 8px; }
    .story-desc { font-size: clamp(12px, 2.5vw, 14px); color: var(--textDim); line-height: 1.65; max-width: 680px; margin-bottom: 20px; }

    /* Grid — single column by default, auto-fill on wider screens */
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .wide { grid-column: 1 / -1; }

    /* Card */
    .cc { border-radius: 12px; overflow: hidden; border: 1px solid var(--border); background: var(--card); box-shadow: var(--shadow); transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .cc canvas { display: block; max-width: 100%; }
    .cc-tag { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--primary); padding: 12px 14px 0; opacity: 0.7; }
    .cc-head { padding: 4px 14px 0; }
    .cc-title { font-size: 14px; font-weight: 600; letter-spacing: -0.01em; }
    .cc-sub { font-size: 11px; color: var(--textMuted); margin-top: 1px; }
    .cc-legend { display: flex; gap: 10px; flex-wrap: wrap; padding: 6px 14px 0; }
    .cc-legend-item { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; color: var(--textDim); }
    .cc-legend-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
    .cc-body { padding: 10px 14px 14px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .cc-body::-webkit-scrollbar { display: none; }

    /* Stat row */
    .stat-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; grid-column: 1 / -1; }
    .stat-cell { border-radius: 12px; border: 1px solid var(--border); background: var(--card); box-shadow: var(--shadow); padding: 16px; overflow: hidden; }

    /* Subsection */
    .sub-label { grid-column: 1 / -1; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--textMuted); padding: 20px 0 4px; display: flex; align-items: center; gap: 10px; }
    .sub-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

    /* Variation strip — horizontal scroll on all screens */
    .var-strip { grid-column: 1 / -1; display: flex; gap: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; scroll-snap-type: x proximity; }
    .var-strip .cc { min-width: 240px; flex: 0 0 auto; scroll-snap-align: start; }

    /* ---- Tablet (≥600px): two-column grid ---- */
    @media (min-width: 600px) {
      .grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
      .wide { grid-column: span 2; }
      .stat-row { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
      .main { padding: 0 20px 80px; }
      .cc-tag { padding: 14px 18px 0; }
      .cc-head { padding: 4px 18px 0; }
      .cc-legend { padding: 8px 18px 0; }
      .cc-body { padding: 12px 18px 18px; }
      .cc { border-radius: 14px; }
    }

    /* ---- Desktop (≥1024px): wider cards, more padding ---- */
    @media (min-width: 1024px) {
      .grid { grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); }
      .main { padding: 0 40px 100px; }
      .navbar { padding: 0 40px; height: 52px; }
      .cc-tag { padding: 16px 20px 0; }
      .cc-head { padding: 4px 20px 0; }
      .cc-legend { padding: 8px 20px 0; }
      .cc-body { padding: 14px 20px 20px; }
      .stat-cell { padding: 20px; }
      .cc:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.08), 0 6px 20px rgba(0,0,0,0.05); }
    }

    /* ---- Small phone (≤360px) ---- */
    @media (max-width: 360px) {
      .navbar-title span { display: none; }
      .grid { gap: 8px; }
      .main { padding: 0 8px 40px; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-logo">C</div>
      <div class="navbar-title">Charlotte Charts<span>v3.3 — 34 types, 6 themes, 0 deps</span></div>
    </div>
    <div class="navbar-right">
      <span class="badge">34 Charts</span>
      <select class="theme-select" id="themeSwitcher">
        <option value="platform">Platform</option>
        <option value="someai">SomeAI</option>
        <option value="sounder">Sounder</option>
        <option value="isg">ISG</option>
        <option value="richard">Richard Ent.</option>
        <option value="allstate">All State</option>
      </select>
    </div>
  </nav>

  <div class="main" id="main"></div>

  <script src="../us-states.js"></script>
  <script src="../charlotte-charts.js"></script>
  <script>
  (function () {
    var CC = window.CharlotteCharts;
    var U = CC.utils;

    // ===================== SHARED DATA =====================
    // One revenue dataset powers Story 1 — raw, derivative, integral, MA
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var revenue   = [45, 52, 48, 61, 58, 72, 68, 85, 79, 92, 88, 105];
    var costs     = [32, 36, 35, 41, 39, 48, 46, 55, 52, 58, 56, 64];
    var profit    = revenue.map(function(r,i){ return r - costs[i]; });
    var revDelta  = U.derivative(revenue);
    var revCum    = U.integral(revenue);
    var revMA     = U.movingAverage(revenue, 3);
    var revPct    = U.percentChange(revenue);
    var profitCum = U.integral(profit);
    var revEMA    = U.ema(revenue, 4);

    // Framework competition dataset — powers Story 2
    var frameworks = ['React','Vue','Angular','Svelte','Solid'];
    var fwMonths = ['Jan','Mar','May','Jul','Sep','Nov'];
    var fwBump = [
      { name: 'React',   ranks: [1,1,1,2,2,1], color: '#61dafb' },
      { name: 'Vue',     ranks: [3,2,2,1,1,2], color: '#42b883' },
      { name: 'Angular', ranks: [2,3,4,4,4,4], color: '#dd0031' },
      { name: 'Svelte',  ranks: [4,4,3,3,3,3], color: '#ff3e00' },
    ];
    var fwRadar = { axes: ['Speed','Memory','DX','Ecosystem','Perf','Bundle Size'], series: [
      { name: 'React', values: [72,65,88,95,78,60], color: '#61dafb' },
      { name: 'Vue', values: [80,72,92,75,82,75], color: '#42b883' },
      { name: 'Svelte', values: [95,90,85,55,94,92], color: '#ff3e00' },
      { name: 'Angular', values: [60,50,65,80,70,45], color: '#dd0031' },
    ]};
    var fwSlope = { labelLeft: '2024', labelRight: '2026', items: [
      { label: 'React', start: 92, end: 84, color: '#61dafb' },
      { label: 'Vue', start: 68, end: 76, color: '#42b883' },
      { label: 'Svelte', start: 32, end: 61, color: '#ff3e00' },
      { label: 'Angular', start: 72, end: 52, color: '#dd0031' },
      { label: 'Solid', start: 12, end: 38, color: '#4f86c6' },
    ]};

    // Distribution dataset — powers Story 3
    function genDist(mean, sd, n) { var v=[]; for(var i=0;i<n;i++) { var u=0,w=0; do{u=Math.random()*2-1;w=Math.random()*2-1;}while(u*u+w*w>=1); v.push(mean+sd*u*Math.sqrt(-2*Math.log(u*u+w*w)/(u*u+w*w))); } return v; }
    var distControl = genDist(50, 12, 120);
    var distDrugA = genDist(65, 10, 120);
    var distDrugB = genDist(58, 15, 120);
    var distDrugC = genDist(72, 8, 120);
    function quartiles(arr) {
      var s = arr.slice().sort(function(a,b){return a-b;});
      var n = s.length;
      var q1 = s[Math.floor(n*0.25)], med = s[Math.floor(n*0.5)], q3 = s[Math.floor(n*0.75)];
      var iqr = q3 - q1;
      var lo = q1 - 1.5*iqr, hi = q3 + 1.5*iqr;
      var min = s.filter(function(v){return v>=lo;})[0] || s[0];
      var max = s.filter(function(v){return v<=hi;}).pop() || s[n-1];
      var outliers = s.filter(function(v){return v<lo||v>hi;});
      return { min: min, q1: q1, median: med, q3: q3, max: max, outliers: outliers };
    }

    // Financial dataset — powers Story 4
    var ohlc = [
      {label:'Mon',open:142,high:148,low:139,close:146},{label:'Tue',open:146,high:152,low:143,close:144},
      {label:'Wed',open:144,high:147,low:138,close:140},{label:'Thu',open:140,high:145,low:136,close:143},
      {label:'Fri',open:143,high:155,low:141,close:153},{label:'Mon',open:153,high:158,low:150,close:156},
      {label:'Tue',open:156,high:162,low:153,close:160},{label:'Wed',open:160,high:165,low:155,close:158},
      {label:'Thu',open:158,high:163,low:152,close:155},{label:'Fri',open:155,high:170,low:154,close:168},
      {label:'Mon',open:168,high:174,low:163,close:171},{label:'Tue',open:171,high:176,low:168,close:173},
      {label:'Wed',open:173,high:178,low:166,close:169},{label:'Thu',open:169,high:175,low:165,close:174},
      {label:'Fri',open:174,high:182,low:172,close:180},
    ];
    var closes = ohlc.map(function(c){return c.close;});
    var volume = ohlc.map(function(c){return Math.abs(c.close-c.open)*100+Math.floor(Math.random()*500+200);});
    var volDelta = U.derivative(volume);

    // Flow dataset — powers Story 5
    var sankeyData = {
      nodes: [
        {id:'rev',name:'Revenue',col:0},{id:'svc',name:'Services',col:1},{id:'prod',name:'Products',col:1},{id:'lic',name:'Licenses',col:1},
        {id:'eng',name:'Engineering',col:2},{id:'mkt',name:'Marketing',col:2},{id:'ops',name:'Operations',col:2},{id:'profit',name:'Net Profit',col:2},
      ],
      links: [
        {source:'rev',target:'svc',value:420},{source:'rev',target:'prod',value:280},{source:'rev',target:'lic',value:150},
        {source:'svc',target:'eng',value:200},{source:'svc',target:'profit',value:220},
        {source:'prod',target:'eng',value:120},{source:'prod',target:'mkt',value:80},{source:'prod',target:'profit',value:80},
        {source:'lic',target:'ops',value:50},{source:'lic',target:'profit',value:100},
      ]
    };

    // Activity dataset — powers Story 6
    var activityWeeks = 52, activityDays = 7;
    var activityCells = [];
    for (var w = 0; w < activityWeeks; w++) {
      for (var d = 0; d < activityDays; d++) {
        var seasonal = Math.sin((w / activityWeeks) * Math.PI * 2 - Math.PI/2) * 0.3 + 0.5;
        var dayBias = d < 5 ? 1 : 0.3;
        activityCells.push({ value: Math.random() < 0.15 ? 0 : Math.max(0, Math.round((Math.random() * 10 + 2) * seasonal * dayBias)) });
      }
    }
    var weeklyTotals = [];
    for (var w = 0; w < activityWeeks; w++) {
      var sum = 0;
      for (var d = 0; d < activityDays; d++) sum += activityCells[w * activityDays + d].value;
      weeklyTotals.push(sum);
    }
    var weeklyCum = U.integral(weeklyTotals);
    var weeklyMA = U.movingAverage(weeklyTotals, 4);

    // ===================== BUILDER HELPERS =====================

    function tag(t) { return '<div class="cc-tag">' + t + '</div>'; }
    function head(title, sub) {
      return '<div class="cc-head"><div class="cc-title" style="color:var(--text)">' + title + '</div>' +
        (sub ? '<div class="cc-sub">' + sub + '</div>' : '') + '</div>';
    }

    function makeCard(parent, cfg) {
      var theme = CC.getTheme();
      var el = document.createElement('div');
      el.className = 'cc' + (cfg.wide ? ' wide' : '');
      el.style.background = theme.card; el.style.borderColor = theme.border; el.style.boxShadow = theme.shadow;
      var html = '';
      if (cfg.tag) html += tag(cfg.tag);
      if (cfg.title) html += head(cfg.title, cfg.sub);
      if (cfg.legend) {
        html += '<div class="cc-legend">';
        cfg.legend.forEach(function(l, i) {
          html += '<span class="cc-legend-item"><span class="cc-legend-dot" style="background:' + (l.color || theme.categorical[i % 8]) + '"></span>' + (l.name || l.label || '') + '</span>';
        });
        html += '</div>';
      }
      html += '<div class="cc-body"></div>';
      el.innerHTML = html;
      parent.appendChild(el);
      return el.querySelector('.cc-body');
    }

    function makeStat(parent, cfg) {
      var el = document.createElement('div');
      el.className = 'stat-cell';
      var theme = CC.getTheme();
      el.style.background = theme.card; el.style.borderColor = theme.border; el.style.boxShadow = theme.shadow;
      parent.appendChild(el);
      CC.stat(el, cfg, { theme: undefined, sparkWidth: cfg.sparkWidth || 130 });
    }

    function storyHeader(parent, num, title, desc) {
      var d = document.createElement('div');
      d.className = 'story';
      d.innerHTML = '<div class="story-num">Story ' + num + '</div><div class="story-title" style="color:var(--text)">' + title + '</div><div class="story-desc">' + desc + '</div>';
      parent.appendChild(d);
    }

    function subLabel(parent, text) {
      var d = document.createElement('div');
      d.className = 'sub-label';
      d.textContent = text;
      parent.appendChild(d);
    }

    // ===================== RENDER =====================

    function renderAll(themeName) {
      CC.setTheme(themeName);
      var theme = CC.getTheme(themeName);
      var root = document.documentElement;
      document.body.style.background = theme.bg; document.body.style.color = theme.text;
      ['bg','surface','card','text','textDim','textMuted','border','primary','shadow'].forEach(function(k) {
        root.style.setProperty('--' + k, theme[k]);
      });
      if (theme.accent) root.style.setProperty('--accent', theme.accent);
      var m = theme.bg.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);
      if (m) root.style.setProperty('--bg-rgb', parseInt(m[1],16)+','+parseInt(m[2],16)+','+parseInt(m[3],16));

      var main = document.getElementById('main');
      main.innerHTML = '';
      var T = themeName;

      // ===================================================================
      // STORY 1 — THE REVENUE ENGINE
      // ===================================================================
      storyHeader(main, 1, 'The Revenue Engine',
        'One dataset, six lenses. The same 12-month revenue series shown as raw signal, ' +
        'its first derivative (month-over-month change), cumulative integral, moving average, ' +
        'waterfall decomposition, and goal tracking. Every chart tells a different part of the story.');

      var g1 = document.createElement('div'); g1.className = 'grid'; main.appendChild(g1);

      // KPIs
      var sr = document.createElement('div'); sr.className = 'stat-row'; g1.appendChild(sr);
      makeStat(sr, { label: 'Total Revenue', value: '$' + (revCum[11]/1).toFixed(0) + 'k', change: +(revPct[11]).toFixed(1), sparkline: revenue });
      makeStat(sr, { label: 'Total Profit', value: '$' + profitCum[11] + 'k', change: +((profit[11]-profit[10])/profit[10]*100).toFixed(1), sparkline: profit });
      makeStat(sr, { label: 'Avg Monthly', value: '$' + (revCum[11]/12).toFixed(0) + 'k', sparkline: U.movingAverage(revenue, 3).map(function(v){return v||revenue[0];}) });
      makeStat(sr, { label: 'Growth Rate', value: ((revenue[11]/revenue[0]-1)*100).toFixed(0) + '%', unit: 'YoY', change: +((revenue[11]-revenue[0])/revenue[0]*100).toFixed(0), sparkline: revPct });

      // Raw signal
      subLabel(g1, 'Raw Signal');
      var b;
      b = makeCard(g1, { tag: 'line', title: 'Monthly Revenue & Cost', sub: 'Raw time series — the foundation', legend: [{name:'Revenue',color:theme.categorical[0]},{name:'Cost',color:theme.categorical[1]},{name:'Profit',color:theme.categorical[2]}] });
      CC.line(b, { labels: months, series: [{ name: 'Revenue', values: revenue }, { name: 'Cost', values: costs }, { name: 'Profit', values: profit, showArea: true }] }, { theme: T, showArea: false });

      b = makeCard(g1, { tag: 'bar', title: 'Revenue vs Cost', sub: 'Grouped comparison by month', legend: [{name:'Revenue'},{name:'Cost'}] });
      CC.bar(b, { labels: months, series: [{ name: 'Revenue', values: revenue }, { name: 'Cost', values: costs }] }, { theme: T, variant: 'grouped' });

      // Derivative
      subLabel(g1, 'First Derivative — Rate of Change');
      b = makeCard(g1, { tag: 'bar · derivative', title: 'Month-over-Month Delta', sub: 'First difference of revenue — where is momentum?' });
      CC.bar(b, { labels: months, series: [{ name: '\u0394 Revenue', values: revDelta }] }, { theme: T });

      b = makeCard(g1, { tag: 'line · % change', title: 'Percent Change', sub: 'Normalized rate — growth velocity regardless of scale' });
      CC.line(b, { labels: months, series: [{ name: '% Change', values: revPct }] }, { theme: T, showArea: true });

      // Integral
      subLabel(g1, 'Integral — Cumulative Accumulation');
      b = makeCard(g1, { tag: 'area · integral', title: 'Cumulative Revenue', sub: 'Running total — area under the curve' });
      CC.line(b, { labels: months, series: [{ name: 'Cumulative', values: revCum, showArea: true }] }, { theme: T, showArea: true });

      b = makeCard(g1, { tag: 'stacked area', title: 'Cumulative Revenue & Profit', sub: 'Two integrals layered — cost is the gap' });
      CC.stackedArea(b, { labels: months, series: [{ name: 'Cost (cumulative)', values: U.integral(costs) }, { name: 'Profit (cumulative)', values: profitCum }] }, { theme: T });

      // Smoothing
      subLabel(g1, 'Smoothing & Trend');
      b = makeCard(g1, { tag: 'line · moving avg', title: 'Revenue + 3-Month MA + EMA', sub: 'Smoothed signals strip noise to reveal trend', legend: [{name:'Raw'},{name:'3M MA'},{name:'EMA(4)'}] });
      CC.line(b, { labels: months, series: [{ name: 'Raw', values: revenue }, { name: '3M MA', values: revMA.map(function(v){return v||null;}) }, { name: 'EMA(4)', values: revEMA }] }, { theme: T, showDots: true });

      b = makeCard(g1, { tag: 'gauge', title: 'Annual Target', sub: '$900k goal — where do we stand?' });
      CC.gauge(b, { value: revCum[11], max: 900, unit: 'k', label: 'of $900k target' }, { theme: T });

      // Decomposition
      subLabel(g1, 'Decomposition');
      b = makeCard(g1, { tag: 'waterfall', title: 'Revenue to Profit Bridge', sub: 'How the top line becomes the bottom line' });
      CC.waterfall(b, { items: [
        { label: 'Revenue', value: revCum[11], total: true },
        { label: 'COGS', value: -Math.round(revCum[11]*0.35) },
        { label: 'R&D', value: -Math.round(revCum[11]*0.18) },
        { label: 'S&M', value: -Math.round(revCum[11]*0.12) },
        { label: 'G&A', value: -Math.round(revCum[11]*0.08) },
        { label: 'Net', value: profitCum[11], total: true },
      ]}, { theme: T });

      b = makeCard(g1, { tag: 'donut', title: 'Cost Breakdown', sub: 'Where the money goes', legend: [{label:'COGS'},{label:'R&D'},{label:'Sales'},{label:'G&A'}] });
      CC.donut(b, { segments: [
        { label: 'COGS', value: 35 }, { label: 'R&D', value: 18 },
        { label: 'Sales', value: 12 }, { label: 'G&A', value: 8 },
      ], centerText: '73%', centerSub: 'of revenue' }, { theme: T });

      // ===================================================================
      // STORY 2 — COMPETITIVE LANDSCAPE
      // ===================================================================
      storyHeader(main, 2, 'Competitive Landscape',
        'Ranking, positioning, and multi-dimensional comparison. The same set of competitors ' +
        'analyzed through bump rankings, slope shift, radar profiles, parallel coordinates, ' +
        'and direct comparison. Each view reveals something the others hide.');

      var g2 = document.createElement('div'); g2.className = 'grid'; main.appendChild(g2);

      b = makeCard(g2, { tag: 'bump', title: 'Ranking Over Time', sub: 'Who is rising, who is falling — the race', wide: true, legend: fwBump });
      CC.bump(b, { labels: fwMonths, series: fwBump }, { theme: T });

      b = makeCard(g2, { tag: 'slope', title: '2024 → 2026 Adoption Shift', sub: 'Before and after — who gained, who lost' });
      CC.slope(b, fwSlope, { theme: T });

      b = makeCard(g2, { tag: 'radar', title: 'Multi-Axis Profile', sub: '6 dimensions at a glance', legend: fwRadar.series });
      CC.radar(b, fwRadar, { theme: T });

      b = makeCard(g2, { tag: 'parallel', title: 'Parallel Coordinates', sub: 'Same data, different topology — cross-axis patterns', wide: true });
      CC.parallel(b, { axes: fwRadar.axes, items: fwRadar.series.map(function(s){ return { name: s.name, values: s.values, color: s.color }; }) }, { theme: T });

      b = makeCard(g2, { tag: 'lollipop', title: 'Adoption Score (2026)', sub: 'Current absolute position' });
      CC.lollipop(b, { labels: fwSlope.items.map(function(i){return i.label;}), values: fwSlope.items.map(function(i){return i.end;}), colors: fwSlope.items.map(function(i){return i.color;}) }, { theme: T });

      b = makeCard(g2, { tag: 'dumbbell', title: '2024 vs 2026 Range', sub: 'Start-to-end gap — magnitude of change' });
      CC.dumbbell(b, { items: fwSlope.items.map(function(i){return {label:i.label,start:i.start,end:i.end};}), colorA: theme.categorical[0], colorB: theme.categorical[1] }, { theme: T });

      // ===================================================================
      // STORY 3 — UNDERSTANDING DISTRIBUTION
      // ===================================================================
      storyHeader(main, 3, 'Understanding Distribution',
        'The same clinical trial dataset viewed through four statistical lenses. ' +
        'Box plots show quartile structure. Violin plots reveal the full density shape. ' +
        'Histograms bin the raw observations. Scatter plots show individual data points.');

      var g3 = document.createElement('div'); g3.className = 'grid'; main.appendChild(g3);

      var distGroups = [
        { label: 'Control', values: distControl },
        { label: 'Drug A', values: distDrugA },
        { label: 'Drug B', values: distDrugB },
        { label: 'Drug C', values: distDrugC },
      ];
      var boxGroups = distGroups.map(function(g) {
        var q = quartiles(g.values);
        return { label: g.label, min: +q.min.toFixed(1), q1: +q.q1.toFixed(1), median: +q.median.toFixed(1), q3: +q.q3.toFixed(1), max: +q.max.toFixed(1), outliers: q.outliers.map(function(v){return +v.toFixed(1);}) };
      });

      b = makeCard(g3, { tag: 'box plot', title: 'Quartile Structure', sub: 'Min, Q1, median, Q3, max + outliers' });
      CC.boxPlot(b, { groups: boxGroups }, { theme: T });

      b = makeCard(g3, { tag: 'violin', title: 'Density Shape', sub: 'KDE reveals bimodality, skew, and spread' });
      CC.violin(b, { groups: distGroups }, { theme: T });

      subLabel(g3, 'Per-Group Histograms');
      b = makeCard(g3, { tag: 'histogram · control', title: 'Control Distribution', sub: 'n=' + distControl.length + ', KDE overlay' });
      CC.histogram(b, { values: distControl, min: 10, max: 100 }, { theme: T, bins: 16 });

      b = makeCard(g3, { tag: 'histogram · drug a', title: 'Drug A Distribution', sub: 'n=' + distDrugA.length + ', right-shifted' });
      CC.histogram(b, { values: distDrugA, min: 10, max: 100 }, { theme: T, bins: 16 });

      b = makeCard(g3, { tag: 'scatter · bubble', title: 'Individual Observations', sub: 'Each point is a patient — clusters reveal subgroups', legend: [{name:'Control'},{name:'Drug A'},{name:'Drug B'},{name:'Drug C'}] });
      CC.scatter(b, { series: distGroups.map(function(g, i) {
        return { name: g.label, points: g.values.map(function(v, j) { return [j, v, 2]; }) };
      }) }, { theme: T });

      b = makeCard(g3, { tag: 'bar · grouped', title: 'Mean Response by Group', sub: 'Summary statistic comparison' });
      CC.bar(b, { labels: distGroups.map(function(g){return g.label;}), series: [{
        name: 'Mean', values: distGroups.map(function(g){ return +(g.values.reduce(function(s,v){return s+v;},0)/g.values.length).toFixed(1); })
      }] }, { theme: T });

      // ===================================================================
      // STORY 4 — FINANCIAL PULSE
      // ===================================================================
      storyHeader(main, 4, 'Financial Pulse',
        'Price action, volume, and technical indicators from the same 15-day trading window. ' +
        'Candlesticks show OHLC structure. The closing prices get smoothed with a moving average. ' +
        'Volume is the derivative of market conviction.');

      var g4 = document.createElement('div'); g4.className = 'grid'; main.appendChild(g4);

      var sr4 = document.createElement('div'); sr4.className = 'stat-row'; g4.appendChild(sr4);
      makeStat(sr4, { label: 'Last Close', value: '$' + closes[closes.length-1], change: +((closes[closes.length-1]/closes[0]-1)*100).toFixed(1), sparkline: closes });
      makeStat(sr4, { label: 'High', value: '$' + Math.max.apply(null, ohlc.map(function(c){return c.high;})), sparkline: ohlc.map(function(c){return c.high;}) });
      makeStat(sr4, { label: 'Avg Volume', value: Math.round(volume.reduce(function(s,v){return s+v;},0)/volume.length).toString(), unit: 'units', sparkline: volume });
      makeStat(sr4, { label: 'Volatility', value: U.stdev(closes).toFixed(1), unit: 'pts', sparkline: U.derivative(closes).map(function(v){return Math.abs(v);}) });

      b = makeCard(g4, { tag: 'candlestick', title: '15-Day OHLC', sub: 'Green = bullish, red = bearish', wide: true });
      CC.candlestick(b, { candles: ohlc }, { theme: T });

      b = makeCard(g4, { tag: 'line · close + MA', title: 'Closing Price + Trend', sub: '3-period MA and EMA smoothing', legend: [{name:'Close'},{name:'3P MA'},{name:'EMA(5)'}] });
      CC.line(b, { labels: ohlc.map(function(c){return c.label;}), series: [
        { name: 'Close', values: closes },
        { name: '3P MA', values: U.movingAverage(closes, 3).map(function(v){return v||null;}) },
        { name: 'EMA(5)', values: U.ema(closes, 5) },
      ]}, { theme: T });

      b = makeCard(g4, { tag: 'bar · volume', title: 'Daily Volume', sub: 'Trade activity — raw signal' });
      CC.bar(b, { labels: ohlc.map(function(c){return c.label;}), series: [{ name: 'Volume', values: volume }] }, { theme: T });

      b = makeCard(g4, { tag: 'bar · volume delta', title: 'Volume Delta', sub: 'Day-over-day change — momentum derivative' });
      CC.bar(b, { labels: ohlc.map(function(c){return c.label;}), series: [{ name: '\u0394 Volume', values: volDelta }] }, { theme: T });

      b = makeCard(g4, { tag: 'area · cumulative', title: 'Cumulative Volume', sub: 'Integral — total market participation' });
      CC.line(b, { labels: ohlc.map(function(c){return c.label;}), series: [{ name: 'Cum. Volume', values: U.integral(volume), showArea: true }] }, { theme: T, showArea: true });

      // ===================================================================
      // STORY 5 — FLOW & COMPOSITION
      // ===================================================================
      storyHeader(main, 5, 'Flow & Composition',
        'How money, users, or energy moves through a system. Sankey tracks flow between nodes. ' +
        'Funnel narrows a pipeline. Marimekko combines width and height to encode two dimensions. ' +
        'Treemap shows proportional space. Every view answers "where does it go?"');

      var g5 = document.createElement('div'); g5.className = 'grid'; main.appendChild(g5);

      b = makeCard(g5, { tag: 'sankey', title: 'Revenue Flow', sub: 'Source → department → outcome', wide: true });
      CC.sankey(b, sankeyData, { theme: T });

      b = makeCard(g5, { tag: 'funnel', title: 'Sales Pipeline', sub: '12k visitors → 680 closed deals' });
      CC.funnel(b, { stages: [{label:'Visitors',value:12000},{label:'Leads',value:5200},{label:'Qualified',value:2800},{label:'Proposals',value:1400},{label:'Closed',value:680}] }, { theme: T });

      b = makeCard(g5, { tag: 'marimekko', title: 'Mobile OS by Region', sub: 'Width = market size, height = share', wide: true });
      CC.marimekko(b, { columns: [
        {label:'US',width:350,segments:[{label:'iOS',value:58},{label:'Android',value:40},{label:'Other',value:2}]},
        {label:'EU',width:280,segments:[{label:'iOS',value:35},{label:'Android',value:62},{label:'Other',value:3}]},
        {label:'Asia',width:520,segments:[{label:'iOS',value:22},{label:'Android',value:72},{label:'Other',value:6}]},
        {label:'Other',width:150,segments:[{label:'iOS',value:18},{label:'Android',value:75},{label:'Other',value:7}]},
      ]}, { theme: T });

      b = makeCard(g5, { tag: 'treemap', title: 'Market Composition', sub: 'Area = share of total' });
      CC.treemap(b, { items: [{label:'Services',value:420},{label:'Products',value:280},{label:'Licenses',value:150},{label:'Support',value:90},{label:'Consulting',value:60}] }, { theme: T });

      b = makeCard(g5, { tag: 'donut', title: 'Revenue Segments', sub: 'Parts of the whole', legend: [{label:'Services'},{label:'Products'},{label:'Licenses'}] });
      CC.donut(b, { segments: [{label:'Services',value:420},{label:'Products',value:280},{label:'Licenses',value:150}], centerText: '$850k', centerSub: 'total' }, { theme: T });

      b = makeCard(g5, { tag: 'stacked bar', title: 'Quarterly Revenue by Segment', sub: 'Composition over time' });
      CC.bar(b, { labels: ['Q1','Q2','Q3','Q4'], series: [
        {name:'Services',values:[90,105,110,115]},{name:'Products',values:[60,70,72,78]},{name:'Licenses',values:[30,35,40,45]}
      ]}, { theme: T, variant: 'stacked' });

      // ===================================================================
      // STORY 6 — ACTIVITY & ENGAGEMENT
      // ===================================================================
      storyHeader(main, 6, 'Activity & Engagement',
        'A year of daily activity data rolled up into weekly totals, cumulative integrals, ' +
        'moving averages, and pattern heatmaps. The heatmap shows the raw grid. The line charts ' +
        'show the signal, its derivative, and its integral — three views of the same heartbeat.');

      var g6 = document.createElement('div'); g6.className = 'grid'; main.appendChild(g6);

      var sr6 = document.createElement('div'); sr6.className = 'stat-row'; g6.appendChild(sr6);
      var totalAct = activityCells.reduce(function(s,c){return s+c.value;},0);
      makeStat(sr6, { label: 'Total Contributions', value: totalAct.toString(), sparkline: weeklyTotals.slice(-20) });
      makeStat(sr6, { label: 'Weekly Average', value: Math.round(totalAct / activityWeeks).toString(), sparkline: weeklyMA.slice(-16).map(function(v){return v||0;}) });
      makeStat(sr6, { label: 'Peak Week', value: Math.max.apply(null, weeklyTotals).toString(), sparkline: weeklyTotals.slice(-20) });
      makeStat(sr6, { label: 'Active Days', value: activityCells.filter(function(c){return c.value>0;}).length.toString(), unit: '/ 364' });

      var colLabels = [];
      var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      for (var w = 0; w < activityWeeks; w++) colLabels.push(w % 4 === 0 ? monthNames[Math.floor(w/4.33)] || '' : '');

      b = makeCard(g6, { tag: 'heatmap', title: 'Contribution Grid', sub: '52 weeks × 7 days — seasonal patterns visible', wide: true });
      CC.heatmap(b, { cells: activityCells, rows: 7, cols: 52, colLabels: colLabels }, { theme: T, cellSize: 11, gap: 2 });

      var weekLabels = [];
      for (var w = 0; w < activityWeeks; w++) weekLabels.push(w % 4 === 0 ? 'W' + (w+1) : '');

      b = makeCard(g6, { tag: 'line · weekly', title: 'Weekly Totals + 4W Moving Average', sub: 'Raw weekly signal with smoothing', legend: [{name:'Weekly'},{name:'4W MA'}] });
      CC.line(b, { labels: weekLabels, series: [
        { name: 'Weekly', values: weeklyTotals },
        { name: '4W MA', values: weeklyMA.map(function(v){return v||null;}) },
      ]}, { theme: T });

      b = makeCard(g6, { tag: 'bar · derivative', title: 'Week-over-Week Delta', sub: 'First derivative — acceleration and deceleration' });
      CC.bar(b, { labels: weekLabels, series: [{ name: '\u0394 Weekly', values: U.derivative(weeklyTotals) }] }, { theme: T });

      b = makeCard(g6, { tag: 'area · integral', title: 'Cumulative Contributions', sub: 'Integral — total work done over time' });
      CC.line(b, { labels: weekLabels, series: [{ name: 'Cumulative', values: weeklyCum, showArea: true }] }, { theme: T, showArea: true });

      b = makeCard(g6, { tag: 'stream', title: 'Channel Mix Over Time', sub: 'Organic flow of activity by platform', wide: true });
      CC.stream(b, { labels: months, series: [
        { name: 'Code', values: [30,35,42,48,55,62,58,52,45,38,32,28] },
        { name: 'Reviews', values: [15,18,22,28,35,42,48,52,48,38,25,18] },
        { name: 'Issues', values: [20,18,15,12,10,8,10,12,15,18,22,25] },
        { name: 'Docs', values: [8,10,14,18,22,25,28,30,26,20,15,10] },
      ]}, { theme: T });

      // ===================================================================
      // STORY 7 — NETWORK & TERRITORY
      // ===================================================================
      storyHeader(main, 7, 'Network & Territory',
        'Entity relationships and geographic distribution. The force-directed graph shows how nodes ' +
        'cluster by affinity. The choropleth maps metric intensity across US states. ' +
        'The timeline shows temporal phases. The ring chart tracks goal attainment.');

      var g7 = document.createElement('div'); g7.className = 'grid'; main.appendChild(g7);

      b = makeCard(g7, { tag: 'network', title: 'Charlotte Entity Graph', sub: 'Force-directed — clustered by relationship strength' });
      CC.network(b, {
        nodes: [
          {id:'charlotte',name:'Charlotte',value:20,group:0},{id:'someai',name:'SomeAI',value:14,group:0},
          {id:'sounder',name:'Sounder',value:12,group:1},{id:'isg',name:'ISG',value:12,group:2},
          {id:'re',name:'Richard Ent.',value:10,group:0},{id:'nsr',name:'NSR',value:8,group:1},
          {id:'allstate',name:'All State',value:6,group:3},{id:'toptier',name:'Top Tier',value:6,group:3},
          {id:'prier',name:'Prier',value:6,group:3},
        ],
        edges: [
          {source:'charlotte',target:'someai',weight:3},{source:'someai',target:'sounder',weight:3},
          {source:'someai',target:'isg',weight:3},{source:'someai',target:'re',weight:2},
          {source:'sounder',target:'nsr',weight:2},{source:'someai',target:'allstate',weight:1},
          {source:'someai',target:'toptier',weight:1},{source:'someai',target:'prier',weight:1},
          {source:'charlotte',target:'isg',weight:2},{source:'re',target:'sounder',weight:1},
        ]
      }, { theme: T });

      b = makeCard(g7, { tag: 'choropleth', title: 'US Client Density', sub: '51 states from Charlotte spatial substrate', wide: true });
      CC.choropleth(b, { states: {CA:95,TX:82,NY:78,FL:71,IL:65,PA:60,OH:55,GA:52,NC:48,MI:45,NJ:43,VA:40,WA:38,AZ:35,MA:33,TN:30,IN:28,MO:25,MD:23,WI:20,CO:18,MN:16,SC:14,AL:12,LA:10,KY:9,OR:8,OK:7,CT:6,UT:5,IA:4,NV:3,AR:2,MS:1,KS:1,NE:1,NM:1,ID:1,WV:1,HI:2,NH:1,ME:1,MT:1,RI:1,DE:1,SD:1,ND:1,AK:2,VT:1,WY:1,DC:5} }, { theme: T, height: 380 });

      b = makeCard(g7, { tag: 'timeline', title: 'Project Phases', sub: 'Gantt-style temporal layout' });
      CC.timeline(b, { phases: [
        {label:'Discovery',start:0,end:25},{label:'Planning',start:20,end:45},
        {label:'Development',start:40,end:80,status:'active'},{label:'Testing',start:70,end:90},
        {label:'Launch',start:88,end:100},
      ]}, { theme: T });

      b = makeCard(g7, { tag: 'rings', title: 'Goal Attainment', sub: 'Concentric progress rings' });
      CC.rings(b, { rings: [{label:'Revenue',value:88,max:100},{label:'Users',value:72,max:100},{label:'NPS',value:94,max:100}], centerText: '85%' }, { theme: T });

      b = makeCard(g7, { tag: 'progress', title: 'Deployment Checklist', sub: 'Linear progress indicators' });
      CC.progress(b, { items: [{label:'Infrastructure',value:100,max:100},{label:'Backend',value:92,max:100},{label:'Frontend',value:78,max:100},{label:'QA',value:45,max:100},{label:'Docs',value:20,max:100}] }, { theme: T });

      b = makeCard(g7, { tag: 'bullet', title: 'Quarterly Targets', sub: 'Actual vs target with qualitative ranges' });
      CC.bullet(b, { items: [{label:'Revenue',actual:275,target:250,max:300},{label:'Profit',actual:85,target:100,max:150},{label:'NPS',actual:92,target:90,max:100}] }, { theme: T });

      // ===================================================================
      // STORY 8 — ANATOMY OF A PREDICTION (DIKW PIPELINE)
      // The knowledge graph is the traversal layer. The horizon chart is the
      // detail layer. When scope shifts from traversal to focus, the horizon
      // kicks in to describe the node and predict its future state.
      // ===================================================================
      storyHeader(main, 8, 'Anatomy of a Prediction \u2014 The DIKW Pipeline',
        'The knowledge graph is the traversal layer \u2014 navigate freely between nodes and edges. ' +
        'When scope shifts from traversal to a single node, the horizon chart kicks in: every metric, ' +
        'every signal, compressed into bands where color intensity encodes magnitude. ' +
        'Read across for time, down for comparison. Raw Data becomes Information through derivatives. ' +
        'Information becomes Knowledge through correlations and feature weights. ' +
        'Knowledge becomes Wisdom through prediction. The forecast is a byproduct of observation.');

      var g9 = document.createElement('div'); g9.className = 'grid'; main.appendChild(g9);

      // ---- TRAVERSAL: Knowledge Graph ----
      subLabel(g9, 'TRAVERSAL \u2014 The Knowledge Graph (freeflow navigation between nodes)');

      b = makeCard(g9, { tag: 'network', title: 'Charlotte Knowledge Graph', sub: 'Scope shifts from traversal to focus when a node is selected \u2014 NODE-1247 highlighted', wide: true });
      CC.network(b, {
        nodes: [
          {id:'1247',name:'NODE-1247',value:20,group:0},
          {id:'1248',name:'NODE-1248',value:10,group:1},{id:'1249',name:'NODE-1249',value:10,group:1},
          {id:'1250',name:'NODE-1250',value:8,group:2},{id:'1251',name:'NODE-1251',value:8,group:2},
          {id:'1252',name:'NODE-1252',value:6,group:3},{id:'1253',name:'NODE-1253',value:6,group:3},
          {id:'hood1',name:'Oakwood',value:14,group:0},{id:'hood2',name:'Riverside',value:12,group:1},
          {id:'school',name:'Lincoln HS',value:10,group:0},{id:'market',name:'Market Index',value:12,group:4},
        ],
        edges: [
          {source:'1247',target:'hood1',weight:3},{source:'1248',target:'hood1',weight:2},
          {source:'1249',target:'hood2',weight:2},{source:'1250',target:'hood2',weight:2},
          {source:'1251',target:'hood1',weight:1},{source:'1252',target:'hood2',weight:1},
          {source:'1253',target:'hood2',weight:1},{source:'1247',target:'school',weight:2},
          {source:'1248',target:'school',weight:2},{source:'hood1',target:'market',weight:2},
          {source:'hood2',target:'market',weight:2},{source:'1247',target:'1248',weight:1},
          {source:'1250',target:'1251',weight:1},
        ]
      }, { theme: T, height: 300 });

      // ---- Generate 100-day metric data for NODE-1247 ----
      var ND = 100;
      var dLabels = [];
      for (var di = 0; di < ND; di++) dLabels.push(di % 10 === 0 ? 'D' + (di + 1) : '');

      var propValue  = U.randomWalk(340, 0.55, 8, ND, 101);
      var sqFoot     = U.randomWalk(2100, 0, 2, ND, 201);
      for (var di = 65; di < ND; di++) sqFoot[di] += 250; // renovation bump
      var hoodIdx    = U.randomWalk(72, 0.08, 3, ND, 301);
      var intRate    = U.randomWalk(6.8, -0.005, 0.15, ND, 401);
      var daysMkt    = U.randomWalk(45, -0.15, 4, ND, 501);
      var crimeIdx   = U.randomWalk(12, -0.03, 1.5, ND, 601);
      var schoolRt   = U.randomWalk(7.2, 0.008, 0.5, ND, 701);
      var walkScr    = U.randomWalk(62, 0.05, 2, ND, 801);
      var medIncome  = U.randomWalk(78, 0.06, 2.5, ND, 901);
      var renoFactor = U.randomWalk(0.2, 0.005, 0.15, ND, 1001);
      for (var di = 65; di < ND; di++) renoFactor[di] += 0.5;

      var mNames = ['Est. Value ($K)', 'Sq Footage', 'Neighborhood Idx', 'Interest Rate (%)',
        'Days on Market', 'Crime Index', 'School Rating', 'Walk Score', 'Median Income ($K)', 'Renovation Factor'];
      var mArrays = [propValue, sqFoot, hoodIdx, intRate, daysMkt, crimeIdx, schoolRt, walkScr, medIncome, renoFactor];
      var shortN = mNames.map(function (n) { return n.split(' ')[0].substring(0, 8); });

      // ---- DATA: Raw Signals ----
      subLabel(g9, 'DATA \u2014 Raw Signals (each row = one metric, color intensity = magnitude)');

      b = makeCard(g9, { tag: 'horizon', title: 'NODE-1247 \u2014 Signal Dashboard', sub: '10 attributes \u00d7 100 days \u00d7 4-band compression. Every metric the model sees.', wide: true });
      CC.horizon(b, {
        series: mNames.map(function (name, i) { return { name: name, values: mArrays[i] }; }),
        labels: dLabels, bands: 4, step: 28,
      }, { theme: T });

      // ---- INFORMATION: Signal Processing ----
      subLabel(g9, 'INFORMATION \u2014 Signal Velocity (first derivative: blue = accelerating, red = decelerating)');

      b = makeCard(g9, { tag: 'horizon \u00b7 derivative', title: 'Rate of Change \u2014 All Metrics', sub: 'Derivatives cross zero \u2014 positive bands (theme color) vs negative bands (red)', wide: true });
      CC.horizon(b, {
        series: mNames.map(function (name, i) {
          return { name: '\u0394 ' + name.split(' ')[0], values: U.derivative(mArrays[i]) };
        }),
        labels: dLabels, bands: 3, step: 24,
      }, { theme: T });

      b = makeCard(g9, { tag: 'line \u00b7 normalized', title: 'Normalized Overlay (Metrics 1\u20135)', sub: 'All signals scaled 0\u20131 for direct comparison' });
      CC.line(b, {
        labels: dLabels,
        series: mArrays.slice(0, 5).map(function (arr, i) { return { name: mNames[i].split(' ')[0], values: U.normalize(arr) }; }),
      }, { theme: T, yMin: 0 });

      b = makeCard(g9, { tag: 'line \u00b7 normalized', title: 'Normalized Overlay (Metrics 6\u201310)', sub: 'Same 0\u20131 scale, different signals' });
      CC.line(b, {
        labels: dLabels,
        series: mArrays.slice(5).map(function (arr, i) { return { name: mNames[i + 5].split(' ')[0], values: U.normalize(arr) }; }),
      }, { theme: T, yMin: 0 });

      // ---- KNOWLEDGE: Feature Weights & Correlations ----
      subLabel(g9, 'KNOWLEDGE \u2014 Feature Importance & Signal Correlations');

      var fWeights = [32, 18, 12, 14, 8, 6, 9, 4, 7, 11];
      b = makeCard(g9, { tag: 'lollipop', title: 'Feature Importance', sub: 'Weight each metric contributes to valuation \u2014 one-hot encoded attributes included' });
      CC.lollipop(b, {
        labels: mNames.map(function (n) { return n.split('(')[0].trim(); }),
        values: fWeights,
      }, { theme: T });

      var corrMat = U.correlationMatrix(mArrays);
      b = makeCard(g9, { tag: 'heatmap \u00b7 correlation', title: 'Correlation Matrix', sub: 'Pearson r between all signal pairs \u2014 reveals multicollinearity' });
      CC.heatmap(b, {
        values: corrMat.map(function (row) { return row.map(function (v) { return Math.round((v + 1) * 50); }); }),
        rowLabels: shortN,
        colLabels: shortN,
      }, { theme: T, height: 300 });

      // ---- WISDOM: The Prediction ----
      subLabel(g9, 'WISDOM \u2014 The Prediction (forecast emerges from signal quality)');

      var boll = U.bollinger(propValue, 14, 2);
      var bollU = boll.upper.map(function (v) { return v !== null ? v : propValue[0]; });
      var bollM = boll.middle.map(function (v) { return v !== null ? v : propValue[0]; });
      var bollL = boll.lower.map(function (v) { return v !== null ? v : propValue[0]; });

      b = makeCard(g9, { tag: 'line \u00b7 bollinger', title: 'Valuation Forecast with Confidence Bands', sub: 'Bollinger bands (14-day MA \u00b1 2\u03c3) \u2014 prediction envelope narrows with better signals', wide: true });
      CC.line(b, {
        labels: dLabels,
        series: [
          { name: 'Upper Band', values: bollU },
          { name: 'Predicted (MA)', values: bollM },
          { name: 'Lower Band', values: bollL },
          { name: 'Actual Value', values: propValue },
        ],
      }, { theme: T });

      var statRow9 = document.createElement('div'); statRow9.className = 'stat-row'; g9.appendChild(statRow9);
      var lastP = propValue[ND - 1], firstP = propValue[0];
      var pGain = ((lastP - firstP) / firstP * 100);
      makeStat(statRow9, { label: 'Current Estimate', value: '$' + lastP.toFixed(0) + 'K', change: pGain, sparkline: propValue.slice(-20).map(function (v) { return (v - 300) / 100; }) });
      makeStat(statRow9, { label: '30-Day Forecast', value: '$' + (lastP * 1.015).toFixed(0) + 'K', change: 1.5, sparkline: [0.4,0.45,0.5,0.48,0.52,0.55,0.58,0.6] });
      makeStat(statRow9, { label: 'Model Confidence', value: '87%', change: 2.1, sparkline: [0.8,0.82,0.84,0.83,0.85,0.86,0.87,0.87] });
      makeStat(statRow9, { label: 'Signal Coverage', value: '10/10', change: 0, sparkline: [1,1,1,1,1,1,1,1] });

      b = makeCard(g9, { tag: 'gauge', title: 'Prediction Confidence', sub: '87% \u2014 high signal coverage drives certainty' });
      CC.gauge(b, { value: 87, max: 100, label: 'Confidence' }, { theme: T });

      b = makeCard(g9, { tag: 'radar', title: 'Signal Quality Profile', sub: 'Per-metric data completeness and signal-to-noise ratio' });
      CC.radar(b, {
        axes: shortN,
        series: [
          { name: 'Completeness', values: [100, 100, 95, 100, 92, 88, 97, 94, 96, 100] },
          { name: 'Signal Strength', values: [85, 45, 72, 88, 65, 58, 70, 40, 62, 78] },
        ],
      }, { theme: T });

      // ===================================================================
      // VARIATIONS GALLERY
      // ===================================================================
      storyHeader(main, '~', 'Variations Gallery',
        'The same data rendered through every applicable chart type. ' +
        'Shows how form changes meaning — a bar is not a lollipop is not a dot.');

      var g8 = document.createElement('div'); g8.className = 'grid'; main.appendChild(g8);

      subLabel(g8, 'Same data: 5 frameworks → 5 views');
      var fwLabels = frameworks;
      var fwVals = [84, 76, 52, 61, 38];

      b = makeCard(g8, { tag: 'bar · vertical', title: 'Bar (Vertical)' });
      CC.bar(b, { labels: fwLabels, series: [{ name: 'Score', values: fwVals }] }, { theme: T });

      b = makeCard(g8, { tag: 'bar · horizontal', title: 'Bar (Horizontal)' });
      CC.bar(b, { labels: fwLabels, series: [{ name: 'Score', values: fwVals }] }, { theme: T, variant: 'horizontal' });

      b = makeCard(g8, { tag: 'lollipop', title: 'Lollipop' });
      CC.lollipop(b, { labels: fwLabels, values: fwVals }, { theme: T });

      b = makeCard(g8, { tag: 'radial bar', title: 'Radial Bar' });
      CC.radialBar(b, { items: fwLabels.map(function(l,i){return {label:l,value:fwVals[i]};}), max: 100 }, { theme: T });

      subLabel(g8, 'Same data: Monthly revenue → 4 views');

      b = makeCard(g8, { tag: 'line', title: 'Line' });
      CC.line(b, { labels: months, series: [{name:'Rev',values:revenue}] }, { theme: T });

      b = makeCard(g8, { tag: 'area', title: 'Area Fill' });
      CC.line(b, { labels: months, series: [{name:'Rev',values:revenue,showArea:true}] }, { theme: T, showArea: true });

      b = makeCard(g8, { tag: 'sparkline', title: 'Sparkline' });
      CC.sparkline(b, { values: revenue, showArea: true }, { theme: T, height: 60 });

      b = makeCard(g8, { tag: 'bar', title: 'Bar' });
      CC.bar(b, { labels: months, series: [{name:'Rev',values:revenue}] }, { theme: T });

      subLabel(g8, 'Same data: Composition → 4 views');
      var compSegs = [{label:'Services',value:420},{label:'Products',value:280},{label:'Licenses',value:150},{label:'Support',value:90}];

      b = makeCard(g8, { tag: 'donut', title: 'Donut' });
      CC.donut(b, { segments: compSegs, centerText: '$940k' }, { theme: T });

      b = makeCard(g8, { tag: 'pie', title: 'Pie' });
      CC.donut(b, { segments: compSegs }, { theme: T, innerRadius: 0 });

      b = makeCard(g8, { tag: 'treemap', title: 'Treemap' });
      CC.treemap(b, { items: compSegs.map(function(s){return {label:s.label,value:s.value};}) }, { theme: T });

      b = makeCard(g8, { tag: 'stacked bar', title: 'Stacked Bar' });
      CC.bar(b, { labels: ['Total'], series: compSegs.map(function(s){return {name:s.label,values:[s.value]};}) }, { theme: T, variant: 'stacked' });
    }

    // ===================== INIT =====================
    document.getElementById('themeSwitcher').addEventListener('change', function () { renderAll(this.value); });
    renderAll('platform');
  })();
  </script>
</body>
</html>
