<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Charlotte Temporal Spine</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: #0A0A0A;
      color: #E8E0E0;
      overflow: hidden;
      height: 100vh;
    }

    /* ── Layout ── */
    .app { display: flex; height: 100vh; }
    .sidebar {
      width: 320px;
      min-width: 320px;
      background: #111;
      border-right: 1px solid #222;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #111;
      border-bottom: 1px solid #222;
      flex-wrap: wrap;
    }
    .timeline-viewport {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
    }
    #scroll-spacer {
      width: 1px;
      pointer-events: none;
    }
    #timeline-canvas {
      display: block;
      width: 100%;
      position: sticky;
      top: 0;
      left: 0;
    }

    /* ── Sidebar ── */
    h1 {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.3px;
      color: #E53E3E;
    }
    .subtitle { font-size: 11px; color: #666; margin-top: 2px; }

    .section-title {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #555;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }
    .section-title .total {
      font-size: 9px;
      color: #E53E3E;
      font-weight: 600;
      letter-spacing: 0;
      text-transform: none;
    }

    .insight {
      background: rgba(229,62,62,0.06);
      border: 1px solid rgba(229,62,62,0.15);
      border-radius: 8px;
      padding: 12px;
      font-size: 11px;
      line-height: 1.6;
      color: #999;
    }
    .insight strong { color: #E8E0E0; }
    .insight .hl { color: #E53E3E; font-weight: 600; }

    /* ── Polar Clock ── */
    #polar-clock {
      width: 100%;
      aspect-ratio: 1;
      max-width: 240px;
      margin: 0 auto;
    }
    #polar-clock svg { width: 100%; height: 100%; }

    /* ── Temporal Compass ── */
    #temporal-compass {
      max-width: 180px;
      margin: 0 auto;
    }
    #temporal-compass svg { width: 100%; height: auto; }
    .compass-caption {
      font-size: 9px;
      color: #444;
      text-align: center;
      margin-top: 4px;
    }

    /* ── Resolution Stack ── */
    #resolution-stack {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .res-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 6px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .res-bar:hover { background: #1A1A1A; }
    .res-bar.active { background: rgba(229,62,62,0.08); }
    .res-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
      opacity: 0.4;
    }
    .res-bar.active .res-dot { opacity: 1; }
    .res-name {
      font-size: 9px;
      color: #555;
      width: 64px;
      flex-shrink: 0;
      font-weight: 500;
    }
    .res-bar.active .res-name { color: #E8E0E0; }
    .res-track {
      flex: 1;
      height: 4px;
      background: #1A1A1A;
      border-radius: 2px;
      overflow: hidden;
    }
    .res-fill {
      height: 100%;
      border-radius: 2px;
      opacity: 0.25;
      transition: opacity 0.15s;
    }
    .res-bar.active .res-fill { opacity: 0.8; }
    .res-count {
      font-size: 8px;
      color: #444;
      width: 52px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      flex-shrink: 0;
    }
    .res-bar.active .res-count { color: #999; }
    .res-divider {
      height: 1px;
      background: #1A1A1A;
      margin: 3px 0;
    }

    /* ── Toolbar ── */
    .tool-label {
      font-size: 10px;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    .tool-group-label {
      font-size: 7px;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
      margin-left: 4px;
    }
    .tool-input {
      background: #1A1A1A;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 11px;
      color: #E8E0E0;
      font-family: inherit;
      outline: none;
      width: 64px;
    }
    .tool-input:focus { border-color: #E53E3E; }
    .tool-btn {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 4px;
      padding: 3px 8px;
      font-size: 10px;
      color: #666;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .tool-btn:hover { background: rgba(255,255,255,0.08); color: #999; }
    .tool-btn.active { background: rgba(229,62,62,0.15); border-color: rgba(229,62,62,0.3); color: #F56565; }
    .tool-sep {
      width: 1px;
      height: 20px;
      background: #222;
      margin: 0 4px;
    }
    .tool-info {
      font-size: 10px;
      color: #444;
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }
  </style>
</head>
<body>
<div class="app">

  <!-- ═══ Sidebar ═══ -->
  <div class="sidebar">
    <div>
      <h1>Temporal Spine</h1>
      <p class="subtitle">Charlotte's perception of time: 0 &ndash; 2048 CE</p>
    </div>

    <!-- Polar Clock -->
    <div>
      <div class="section-title">Now</div>
      <div id="polar-clock"></div>
    </div>

    <!-- Temporal Compass -->
    <div>
      <div class="section-title">Temporal Compass</div>
      <div id="temporal-compass">
        <svg viewBox="0 0 180 180">
          <defs>
            <marker id="ah" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="5" markerHeight="5" orient="auto"><path d="M0,1 L9,5 L0,9Z" fill="#E53E3E"/></marker>
            <marker id="af" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="5" markerHeight="5" orient="auto"><path d="M0,1 L9,5 L0,9Z" fill="#4A9EE5"/></marker>
            <marker id="ae" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="5" markerHeight="5" orient="auto"><path d="M0,1 L9,5 L0,9Z" fill="#F59E0B"/></marker>
            <marker id="al" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="5" markerHeight="5" orient="auto"><path d="M0,1 L9,5 L0,9Z" fill="#68D391"/></marker>
          </defs>
          <!-- Rings -->
          <circle cx="90" cy="90" r="60" fill="none" stroke="#1A1A1A" stroke-width="1"/>
          <circle cx="90" cy="90" r="30" fill="none" stroke="#1A1A1A" stroke-width="1"/>
          <!-- Center -->
          <circle cx="90" cy="90" r="5" fill="#E53E3E" opacity="0.3"/>
          <circle cx="90" cy="90" r="2" fill="#E53E3E"/>
          <!-- Coarser (up) -->
          <line x1="90" y1="78" x2="90" y2="25" stroke="#E53E3E" stroke-width="1.5" marker-end="url(#ah)"/>
          <text x="90" y="16" text-anchor="middle" fill="#E53E3E" font-size="8" font-family="Inter" font-weight="700">COARSER</text>
          <!-- Finer (down) -->
          <line x1="90" y1="102" x2="90" y2="155" stroke="#4A9EE5" stroke-width="1.5" marker-end="url(#af)"/>
          <text x="90" y="170" text-anchor="middle" fill="#4A9EE5" font-size="8" font-family="Inter" font-weight="700">FINER</text>
          <!-- Earlier (left) -->
          <line x1="78" y1="90" x2="25" y2="90" stroke="#F59E0B" stroke-width="1.5" marker-end="url(#ae)"/>
          <text x="14" y="80" text-anchor="middle" fill="#F59E0B" font-size="8" font-family="Inter" font-weight="700" transform="rotate(-90,14,80)">EARLIER</text>
          <!-- Later (right) -->
          <line x1="102" y1="90" x2="155" y2="90" stroke="#68D391" stroke-width="1.5" marker-end="url(#al)"/>
          <text x="166" y="80" text-anchor="middle" fill="#68D391" font-size="8" font-family="Inter" font-weight="700" transform="rotate(90,166,80)">LATER</text>
          <!-- Level labels on Coarser/Finer axis -->
          <text x="100" y="42" fill="#555" font-size="6" font-family="Inter">Millennium</text>
          <text x="100" y="50" fill="#444" font-size="6" font-family="Inter">Century</text>
          <text x="100" y="58" fill="#444" font-size="6" font-family="Inter">Decade</text>
          <text x="100" y="66" fill="#444" font-size="6" font-family="Inter">Year</text>
          <text x="100" y="120" fill="#444" font-size="6" font-family="Inter">Month</text>
          <text x="100" y="128" fill="#444" font-size="6" font-family="Inter">Week</text>
          <text x="100" y="136" fill="#444" font-size="6" font-family="Inter">Day</text>
          <text x="100" y="148" fill="#555" font-size="6" font-family="Inter">Hour</text>
        </svg>
      </div>
      <p class="compass-caption">4 directions to navigate temporal space</p>
    </div>

    <!-- Resolution Stack -->
    <div>
      <div class="section-title">Resolution Stack <span class="total" id="total-nodes">22.6M nodes</span></div>
      <div id="resolution-stack"></div>
    </div>

    <!-- Insights -->
    <div class="insight">
      The hierarchy <strong>branches</strong>: Year splits into the financial chain
      (<span class="hl">HalfYear &rarr; Quarter</span>) and the academic chain
      (<span class="hl">Trimester</span>). Day splits into the civil chain
      (<span class="hl">HalfDay &rarr; AM/PM</span>) and the industrial chain
      (<span class="hl">Shift &rarr; 8hr blocks</span>). Both rejoin at Month and Hour.
    </div>

    <div class="insight">
      <strong>58 categorical nodes</strong> map recurring patterns.
      <span class="hl">January</span> recurs 2,049 times.
      <span class="hl">Monday</span> recurs ~106,862 times.
      The instance plane has 22.6M nodes. Same spine, radically different cardinality.
    </div>
  </div>

  <!-- ═══ Main Timeline ═══ -->
  <div class="main">
    <div class="toolbar" id="toolbar">
      <span class="tool-label">Jump</span>
      <input class="tool-input" type="number" id="jump-year" value="2025" min="0" max="2048">
      <button class="tool-btn" onclick="jumpToYear()">Go</button>
      <div class="tool-sep"></div>

      <span class="tool-group-label">MACRO</span>
      <button class="tool-btn" data-lane="millennium" onclick="toggleLane('millennium')">Mlnm</button>
      <button class="tool-btn" data-lane="century" onclick="toggleLane('century')">Cent</button>
      <button class="tool-btn" data-lane="halfcentury" onclick="toggleLane('halfcentury')">50yr</button>
      <button class="tool-btn" data-lane="decade" onclick="toggleLane('decade')">Dcde</button>

      <span class="tool-group-label">ANNUAL</span>
      <button class="tool-btn active" data-lane="year" onclick="toggleLane('year')">Year</button>
      <button class="tool-btn" data-lane="halfyear" onclick="toggleLane('halfyear')">&#189;Yr</button>
      <button class="tool-btn" data-lane="trimester" onclick="toggleLane('trimester')">Tri</button>
      <button class="tool-btn" data-lane="quarter" onclick="toggleLane('quarter')">Qtr</button>

      <span class="tool-group-label">PERIODIC</span>
      <button class="tool-btn active" data-lane="month" onclick="toggleLane('month')">Mo</button>
      <button class="tool-btn" data-lane="fortnight" onclick="toggleLane('fortnight')">Ftn</button>
      <button class="tool-btn active" data-lane="week" onclick="toggleLane('week')">Wk</button>

      <span class="tool-group-label">DAILY</span>
      <button class="tool-btn active" data-lane="day" onclick="toggleLane('day')">Day</button>
      <button class="tool-btn" data-lane="halfday" onclick="toggleLane('halfday')">&#189;D</button>
      <button class="tool-btn" data-lane="shift" onclick="toggleLane('shift')">Shft</button>
      <button class="tool-btn" data-lane="hour" onclick="toggleLane('hour')">Hr</button>

      <div class="tool-sep"></div>
      <button class="tool-btn" onclick="toggleCategorical()" id="btn-cat">Cat</button>
      <span class="tool-info" id="viewport-info"></span>
    </div>
    <div class="timeline-viewport" id="viewport">
      <div id="scroll-spacer"></div>
      <canvas id="timeline-canvas"></canvas>
    </div>
  </div>
</div>

<script>
(function() {
  // ════════════════════════════════════════════════════════════════
  // POLAR CLOCK
  // ════════════════════════════════════════════════════════════════

  var PC = document.getElementById('polar-clock');
  var pcSize = 240;

  function buildPolarClock() {
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('viewBox', '0 0 ' + pcSize + ' ' + pcSize);
    PC.innerHTML = '';
    PC.appendChild(svg);
    return svg;
  }

  var pcSvg = buildPolarClock();
  var pcFields = [
    { label: 'Second',  max: 60, radius: 0.92, color: '#E53E3E' },
    { label: 'Minute',  max: 60, radius: 0.78, color: '#F56565' },
    { label: 'Hour',    max: 24, radius: 0.64, color: '#F59E0B' },
    { label: 'Weekday', max: 7,  radius: 0.50, color: '#68D391' },
    { label: 'Day',     max: 31, radius: 0.36, color: '#4A9EE5' },
    { label: 'Month',   max: 12, radius: 0.22, color: '#A855F7' }
  ];

  function polarArc(cx, cy, r, startAngle, endAngle, thickness) {
    var ir = r - thickness / 2, or = r + thickness / 2;
    var sa = startAngle - Math.PI / 2, ea = endAngle - Math.PI / 2;
    var large = (endAngle - startAngle) > Math.PI ? 1 : 0;
    var x1 = cx + or * Math.cos(sa), y1 = cy + or * Math.sin(sa);
    var x2 = cx + or * Math.cos(ea), y2 = cy + or * Math.sin(ea);
    var x3 = cx + ir * Math.cos(ea), y3 = cy + ir * Math.sin(ea);
    var x4 = cx + ir * Math.cos(sa), y4 = cy + ir * Math.sin(sa);
    return 'M'+x1+','+y1+' A'+or+','+or+' 0 '+large+',1 '+x2+','+y2+
           ' L'+x3+','+y3+' A'+ir+','+ir+' 0 '+large+',0 '+x4+','+y4+' Z';
  }

  function updatePolarClock() {
    var now = new Date();
    var cx = pcSize / 2, cy = pcSize / 2, maxR = pcSize / 2 - 4, th = 10;
    var vals = [
      now.getSeconds() + now.getMilliseconds() / 1000,
      now.getMinutes() + now.getSeconds() / 60,
      now.getHours() + now.getMinutes() / 60,
      (now.getDay() === 0 ? 7 : now.getDay()) - 1 + now.getHours() / 24,
      now.getDate() - 1 + now.getHours() / 24,
      now.getMonth() + now.getDate() / 31
    ];
    var h = '';
    for (var i = 0; i < pcFields.length; i++) {
      var f = pcFields[i], r = maxR * f.radius;
      h += '<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="none" stroke="#222" stroke-width="'+th+'" opacity="0.5"/>';
    }
    for (var i = 0; i < pcFields.length; i++) {
      var f = pcFields[i], r = maxR * f.radius;
      var frac = Math.max(0.001, vals[i] / f.max);
      h += '<path d="'+polarArc(cx, cy, r, 0, frac * Math.PI * 2, th)+'" fill="'+f.color+'" opacity="0.8"/>';
    }
    for (var i = 0; i < pcFields.length; i++) {
      var f = pcFields[i], r = maxR * f.radius;
      h += '<text x="'+cx+'" y="'+(cy - r)+'" fill="#666" font-size="6" font-family="Inter" font-weight="600" text-anchor="middle" dy="-7">'+f.label+'</text>';
    }
    var ts = now.toLocaleTimeString('en-US', { hour12: false });
    var ds = now.toISOString().slice(0, 10);
    h += '<text x="'+cx+'" y="'+(cy-4)+'" fill="#E8E0E0" font-size="10" font-family="Inter" font-weight="700" text-anchor="middle">'+ts+'</text>';
    h += '<text x="'+cx+'" y="'+(cy+8)+'" fill="#666" font-size="7" font-family="Inter" font-weight="500" text-anchor="middle">'+ds+'</text>';
    pcSvg.innerHTML = h;
  }
  updatePolarClock();
  setInterval(updatePolarClock, 100);

  // ════════════════════════════════════════════════════════════════
  // LANE CONFIGURATION
  // ════════════════════════════════════════════════════════════════

  var LANES = [
    { id:'millennium',  label:'Millennium',   color:'#FF1744', nodes:3,        vis:false, r:14 },
    { id:'century',     label:'Century',      color:'#D50000', nodes:21,       vis:false, r:12 },
    { id:'halfcentury', label:'Half-Century',  color:'#C62828', nodes:41,       vis:false, r:11 },
    { id:'decade',      label:'Decade',       color:'#EF5350', nodes:205,      vis:false, r:10 },
    { id:'year',        label:'Year',         color:'#E53E3E', nodes:2049,     vis:true,  r:10 },
    { id:'halfyear',    label:'Half-Year',    color:'#66BB6A', nodes:4098,     vis:false, r:9  },
    { id:'trimester',   label:'Trimester',    color:'#2E7D32', nodes:6147,     vis:false, r:9  },
    { id:'quarter',     label:'Quarter',      color:'#43A047', nodes:8196,     vis:false, r:8  },
    { id:'month',       label:'Month',        color:'#68D391', nodes:24588,    vis:true,  r:8  },
    { id:'fortnight',   label:'Fortnight',    color:'#FFB74D', nodes:53431,    vis:false, r:7  },
    { id:'week',        label:'Week',         color:'#F59E0B', nodes:106862,   vis:true,  r:6  },
    { id:'day',         label:'Day',          color:'#4A9EE5', nodes:748294,   vis:true,  r:4  },
    { id:'halfday',     label:'Half-Day',     color:'#42A5F5', nodes:1496588,  vis:false, r:0  },
    { id:'shift',       label:'Shift',        color:'#1E88E5', nodes:2244882,  vis:false, r:0  },
    { id:'hour',        label:'Hour',         color:'#1565C0', nodes:17959056, vis:false, r:0  }
  ];

  var LANE_MAP = {};
  for (var i = 0; i < LANES.length; i++) LANE_MAP[LANES[i].id] = LANES[i];

  var SUBDAY = { halfday: 2, shift: 3, hour: 24 };
  var showCategorical = false;

  var MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var DAY_NAMES = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

  // ════════════════════════════════════════════════════════════════
  // RESOLUTION STACK (density affordance)
  // ════════════════════════════════════════════════════════════════

  var GROUPS = [
    { after: 3, label: 'macro' },
    { after: 7, label: 'annual' },
    { after: 10, label: 'periodic' },
    { after: 14, label: 'daily+sub' }
  ];

  function buildResolutionStack() {
    var el = document.getElementById('resolution-stack');
    var maxLog = Math.log10(17959056);
    var html = '';
    for (var i = 0; i < LANES.length; i++) {
      var L = LANES[i];
      var pct = (Math.log10(Math.max(1, L.nodes)) / maxLog) * 100;
      var act = L.vis ? ' active' : '';
      html += '<div class="res-bar'+act+'" data-lane="'+L.id+'" onclick="toggleLane(\''+L.id+'\')">';
      html += '<span class="res-dot" style="background:'+L.color+'"></span>';
      html += '<span class="res-name">'+L.label+'</span>';
      html += '<div class="res-track"><div class="res-fill" style="width:'+pct+'%;background:'+L.color+'"></div></div>';
      html += '<span class="res-count">'+L.nodes.toLocaleString()+'</span>';
      html += '</div>';
      for (var g = 0; g < GROUPS.length; g++) {
        if (GROUPS[g].after === i && i < LANES.length - 1) {
          html += '<div class="res-divider"></div>';
        }
      }
    }
    el.innerHTML = html;
  }

  function syncResolutionStack() {
    var bars = document.querySelectorAll('.res-bar');
    for (var i = 0; i < bars.length; i++) {
      var lid = bars[i].getAttribute('data-lane');
      if (LANE_MAP[lid].vis) bars[i].classList.add('active');
      else bars[i].classList.remove('active');
    }
  }

  function syncToolbar() {
    var btns = document.querySelectorAll('[data-lane]');
    for (var i = 0; i < btns.length; i++) {
      var lid = btns[i].getAttribute('data-lane');
      if (btns[i].classList.contains('res-bar')) continue;
      if (LANE_MAP[lid].vis) btns[i].classList.add('active');
      else btns[i].classList.remove('active');
    }
  }

  // ════════════════════════════════════════════════════════════════
  // DATE MATH
  // ════════════════════════════════════════════════════════════════

  var YEAR_START = 0, YEAR_END = 2048;
  var ROW_H = 28;
  var LANE_W = 120;
  var LANE_GAP = 40;
  var LEFT_PAD = 30;
  var HEADER_H = 32;

  function isLeapYear(y) { return (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0); }
  function daysInMonth(y, m) {
    var d = [31,28,31,30,31,30,31,31,30,31,30,31];
    return (m === 1 && isLeapYear(y)) ? 29 : d[m];
  }
  function daysInYear(y) { return isLeapYear(y) ? 366 : 365; }

  function makeDate(y, m, d) {
    var dt = new Date(0); dt.setFullYear(y, m, d); dt.setHours(0,0,0,0); return dt;
  }
  function isoWeek(y, m, d) {
    var dt = makeDate(y, m, d);
    dt.setDate(dt.getDate() + 3 - (dt.getDay() + 6) % 7);
    var jan4 = makeDate(dt.getFullYear(), 0, 4);
    return Math.round(((dt - jan4) / 86400000 - 3 + (jan4.getDay() + 6) % 7) / 7) + 1;
  }
  function dayOfWeek(y, m, d) {
    var dow = makeDate(y, m, d).getDay();
    return dow === 0 ? 6 : dow - 1;
  }

  // Precompute cumulative day offsets
  var yearDayOffset = new Array(YEAR_END + 2);
  yearDayOffset[0] = 0;
  for (var y = 0; y <= YEAR_END; y++) yearDayOffset[y+1] = yearDayOffset[y] + daysInYear(y);
  var TOTAL_DAYS = yearDayOffset[YEAR_END + 1];

  function dayFromIndex(idx) {
    var lo = 0, hi = YEAR_END;
    while (lo < hi) { var mid = (lo + hi + 1) >> 1; if (yearDayOffset[mid] <= idx) lo = mid; else hi = mid - 1; }
    var y = lo, rem = idx - yearDayOffset[y], m = 0;
    while (m < 11 && rem >= daysInMonth(y, m)) { rem -= daysInMonth(y, m); m++; }
    return { year: y, month: m, day: rem };
  }

  function pad2(n) { return n < 10 ? '0' + n : '' + n; }

  // ════════════════════════════════════════════════════════════════
  // CANVAS SETUP
  // ════════════════════════════════════════════════════════════════

  var canvas = document.getElementById('timeline-canvas');
  var ctx = canvas.getContext('2d');
  var viewport = document.getElementById('viewport');
  var scrollSpacer = document.getElementById('scroll-spacer');
  var dpr = window.devicePixelRatio || 1;
  var canvasW, viewH, totalH;

  function resizeCanvas() {
    canvasW = viewport.offsetWidth;
    viewH = viewport.offsetHeight;
    totalH = TOTAL_DAYS * ROW_H + viewH;
    scrollSpacer.style.height = totalH + 'px';
    canvas.style.width = canvasW + 'px';
    canvas.style.height = viewH + 'px';
    canvas.width = canvasW * dpr;
    canvas.height = viewH * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  // ════════════════════════════════════════════════════════════════
  // VISIBLE LANES + LAYOUT
  // ════════════════════════════════════════════════════════════════

  function getVisibleLanes() {
    var arr = [];
    for (var i = 0; i < LANES.length; i++) {
      if (LANES[i].vis) arr.push(LANES[i].id);
    }
    return arr;
  }

  function laneX(idx) {
    return LEFT_PAD + idx * (LANE_W + LANE_GAP) + LANE_W / 2;
  }

  // ════════════════════════════════════════════════════════════════
  // BOUNDARY DETECTION
  // ════════════════════════════════════════════════════════════════

  function getBoundaries(y, m, d, wk, dow) {
    var fm = (d === 0);
    var fy = fm && (m === 0);
    return {
      millennium:  fy && (y % 1000 === 0),
      century:     fy && (y % 100 === 0),
      halfcentury: fy && (y % 50 === 0),
      decade:      fy && (y % 10 === 0),
      year:        fy,
      halfyear:    fm && (m % 6 === 0),
      trimester:   fm && (m % 4 === 0),
      quarter:     fm && (m % 3 === 0),
      month:       fm,
      fortnight:   (dow === 0) && (wk % 2 === 1),
      week:        (dow === 0),
      day:         true
    };
  }

  // ════════════════════════════════════════════════════════════════
  // LANE LABELS
  // ════════════════════════════════════════════════════════════════

  function laneLabel(id, y, m, d, wk) {
    switch (id) {
      case 'millennium':  return 'M' + Math.floor(y / 1000);
      case 'century':     return 'C' + Math.floor(y / 100);
      case 'halfcentury': return Math.floor(y / 50) * 50 + 's';
      case 'decade':      return Math.floor(y / 10) * 10 + 's';
      case 'year':        return String(y);
      case 'halfyear':    return (m < 6 ? 'H1' : 'H2') + ' ' + y;
      case 'trimester':   return 'T' + (Math.floor(m / 4) + 1) + ' ' + y;
      case 'quarter':     return 'Q' + (Math.floor(m / 3) + 1) + ' ' + y;
      case 'month':       return MONTH_NAMES[m] + ' ' + y;
      case 'fortnight':   return 'Fn' + Math.ceil(wk / 2);
      case 'week':        return 'W' + wk;
      case 'day':         return y + '-' + pad2(m + 1) + '-' + pad2(d + 1);
      default:            return '';
    }
  }

  // ════════════════════════════════════════════════════════════════
  // DRAWING
  // ════════════════════════════════════════════════════════════════

  // Track previous boundary keys to draw spine lines between boundary nodes
  var prevBounds = {};

  function draw() {
    var scrollTop = viewport.scrollTop;
    ctx.clearRect(0, 0, canvasW, viewH);

    var visLanes = getVisibleLanes();
    var numCols = visLanes.length;
    var laneXs = {};
    for (var i = 0; i < numCols; i++) laneXs[visLanes[i]] = laneX(i);

    // Categorical column position
    var catX = numCols > 0 ? laneX(numCols) + 20 : LEFT_PAD;

    // ── Header row ──
    ctx.fillStyle = '#0A0A0A';
    ctx.fillRect(0, 0, canvasW, HEADER_H);
    ctx.font = '600 8px Inter';
    ctx.textAlign = 'center';
    for (var i = 0; i < numCols; i++) {
      var lane = LANE_MAP[visLanes[i]];
      ctx.fillStyle = lane.color;
      ctx.globalAlpha = 0.6;
      ctx.fillText(lane.label.toUpperCase(), laneXs[visLanes[i]], 20);
    }
    if (showCategorical) {
      ctx.fillStyle = '#A855F7';
      ctx.fillText('CATEGORICAL', catX, 20);
    }
    ctx.globalAlpha = 1;

    // ── Spine lines ──
    ctx.strokeStyle = '#161616';
    ctx.lineWidth = 1;
    for (var i = 0; i < numCols; i++) {
      var x = laneXs[visLanes[i]];
      ctx.beginPath(); ctx.moveTo(x, HEADER_H); ctx.lineTo(x, viewH); ctx.stroke();
    }

    // ── Row range ──
    var startRow = Math.max(0, Math.floor(scrollTop / ROW_H) - 2);
    var endRow = Math.min(TOTAL_DAYS - 1, Math.ceil((scrollTop + viewH) / ROW_H) + 2);

    // Reset prev boundary tracking
    prevBounds = {};

    for (var row = startRow; row <= endRow; row++) {
      var screenY = row * ROW_H - scrollTop + HEADER_H + 8;
      if (screenY < HEADER_H - ROW_H || screenY > viewH + ROW_H) continue;

      var info = dayFromIndex(row);
      var y = info.year, m = info.month, d = info.day;
      var wk = 1, dow = 0;
      try { wk = isoWeek(y, m, d); } catch(e) {}
      try { dow = dayOfWeek(y, m, d); } catch(e) {}

      var bounds = getBoundaries(y, m, d, wk, dow);

      // Draw each visible lane
      for (var li = 0; li < numCols; li++) {
        var lid = visLanes[li];
        var lane = LANE_MAP[lid];
        var lx = laneXs[lid];

        // Sub-day density lanes
        if (SUBDAY[lid] !== undefined) {
          var count = SUBDAY[lid];
          var barW = Math.min(count * 3, 48);
          var segW = barW / count;

          ctx.globalAlpha = 0.25;
          for (var s = 0; s < count; s++) {
            var shade = s % 2 === 0 ? lane.color : shadeColor(lane.color, -20);
            ctx.fillStyle = shade;
            ctx.fillRect(lx - barW/2 + s * segW, screenY - 4, segW - 0.5, 8);
          }
          ctx.globalAlpha = 1;

          // Count label
          ctx.fillStyle = lane.color;
          ctx.globalAlpha = 0.4;
          ctx.font = '600 7px Inter';
          ctx.textAlign = 'left';
          ctx.fillText('x' + count, lx + barW/2 + 4, screenY + 2);
          ctx.globalAlpha = 1;
          continue;
        }

        // Boundary lanes (Millennium through Day)
        if (bounds[lid]) {
          // Node circle
          var nr = lane.r;
          ctx.fillStyle = lane.color;
          ctx.globalAlpha = 0.12;
          ctx.beginPath(); ctx.arc(lx, screenY, nr, 0, Math.PI * 2); ctx.fill();
          ctx.globalAlpha = 1;
          ctx.strokeStyle = lane.color;
          ctx.lineWidth = 1.5;
          ctx.beginPath(); ctx.arc(lx, screenY, nr, 0, Math.PI * 2); ctx.stroke();

          // Label
          ctx.fillStyle = lane.color;
          ctx.font = (nr >= 10 ? '700 10px' : nr >= 7 ? '600 9px' : '500 8px') + ' Inter';
          ctx.textAlign = 'center';
          var label = laneLabel(lid, y, m, d, wk);
          ctx.fillText(label, lx, screenY + 3);

          // Day-of-week after day label
          if (lid === 'day') {
            ctx.fillStyle = '#444';
            ctx.font = '500 7px Inter';
            ctx.textAlign = 'left';
            ctx.fillText(DAY_NAMES[dow], lx + 62, screenY + 2);
          }

          // Cross-edge to next coarser visible lane
          var coarserX = findCoarserLaneX(lid, visLanes, laneXs);
          if (coarserX !== null && lid !== 'day') {
            ctx.strokeStyle = '#333';
            ctx.globalAlpha = 0.2;
            ctx.lineWidth = 0.5;
            ctx.setLineDash([2, 3]);
            ctx.beginPath();
            ctx.moveTo(lx - nr, screenY);
            ctx.lineTo(coarserX + (LANE_MAP[getCoarserLane(lid, visLanes)].r || 8), screenY);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.globalAlpha = 1;
          }

          // Categorical edge
          if (showCategorical && (lid === 'month' || lid === 'day')) {
            ctx.strokeStyle = '#A855F7';
            ctx.globalAlpha = 0.15;
            ctx.lineWidth = 0.5;
            ctx.setLineDash([2, 4]);
            ctx.beginPath();
            ctx.moveTo(lx + nr + 2, screenY);
            ctx.lineTo(catX - 20, screenY);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.globalAlpha = 1;
            ctx.fillStyle = '#A855F7';
            ctx.globalAlpha = 0.4;
            ctx.font = '500 7px Inter';
            ctx.textAlign = 'left';
            if (lid === 'month') ctx.fillText(MONTH_NAMES[m], catX - 16, screenY + 2);
            if (lid === 'day') ctx.fillText(DAY_NAMES[dow], catX - 16, screenY + 2);
            ctx.globalAlpha = 1;
          }

        } else {
          // Spine segment (double-link between prev and next boundary)
          ctx.strokeStyle = lane.color;
          ctx.globalAlpha = 0.04;
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(lx, screenY - ROW_H / 2);
          ctx.lineTo(lx, screenY + ROW_H / 2);
          ctx.stroke();
          ctx.globalAlpha = 1;
        }
      }

      // ── Double-link arrows for Day lane (always connect to prev row) ──
      if (laneXs.day !== undefined && row > startRow) {
        var dx = laneXs.day;
        ctx.strokeStyle = LANE_MAP.day.color;
        ctx.globalAlpha = 0.12;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(dx, screenY - 4);
        ctx.lineTo(dx, screenY - ROW_H + 4);
        ctx.stroke();
        ctx.globalAlpha = 1;
      }
    }

    // ── Viewport info ──
    var centerRow = Math.max(0, Math.min(TOTAL_DAYS - 1, Math.floor((scrollTop + viewH / 2) / ROW_H)));
    var ci = dayFromIndex(centerRow);
    document.getElementById('viewport-info').textContent =
      'Day ' + centerRow.toLocaleString() + ' / ' + TOTAL_DAYS.toLocaleString() +
      ' | ' + ci.year + '-' + pad2(ci.month + 1) + '-' + pad2(ci.day + 1);
  }

  // ════════════════════════════════════════════════════════════════
  // CROSS-EDGE HELPERS
  // ════════════════════════════════════════════════════════════════

  // Coarser-than ordering (finest first)
  var COARSER_ORDER = ['hour','shift','halfday','day','week','fortnight','month','quarter','trimester','halfyear','year','decade','halfcentury','century','millennium'];

  function getCoarserLane(lid, visLanes) {
    var myIdx = COARSER_ORDER.indexOf(lid);
    for (var i = myIdx + 1; i < COARSER_ORDER.length; i++) {
      if (visLanes.indexOf(COARSER_ORDER[i]) !== -1) return COARSER_ORDER[i];
    }
    return null;
  }

  function findCoarserLaneX(lid, visLanes, laneXs) {
    var coarser = getCoarserLane(lid, visLanes);
    return coarser ? laneXs[coarser] : null;
  }

  function shadeColor(hex, amt) {
    var r = parseInt(hex.slice(1,3),16) + amt;
    var g = parseInt(hex.slice(3,5),16) + amt;
    var b = parseInt(hex.slice(5,7),16) + amt;
    r = Math.max(0,Math.min(255,r));
    g = Math.max(0,Math.min(255,g));
    b = Math.max(0,Math.min(255,b));
    return '#' + (r<16?'0':'') + r.toString(16) + (g<16?'0':'') + g.toString(16) + (b<16?'0':'') + b.toString(16);
  }

  // ════════════════════════════════════════════════════════════════
  // CONTROLS
  // ════════════════════════════════════════════════════════════════

  window.jumpToYear = function() {
    var y = parseInt(document.getElementById('jump-year').value) || 2025;
    y = Math.max(0, Math.min(YEAR_END, y));
    viewport.scrollTop = yearDayOffset[y] * ROW_H;
  };

  window.toggleLane = function(id) {
    LANE_MAP[id].vis = !LANE_MAP[id].vis;
    syncToolbar();
    syncResolutionStack();
    draw();
  };

  window.toggleCategorical = function() {
    showCategorical = !showCategorical;
    document.getElementById('btn-cat').classList.toggle('active');
    draw();
  };

  // ════════════════════════════════════════════════════════════════
  // INIT
  // ════════════════════════════════════════════════════════════════

  function init() {
    buildResolutionStack();
    syncToolbar();
    resizeCanvas();
    viewport.scrollTop = yearDayOffset[2025] * ROW_H;
    draw();
  }

  var rafPending = false;
  viewport.addEventListener('scroll', function() {
    if (!rafPending) {
      rafPending = true;
      requestAnimationFrame(function() { draw(); rafPending = false; });
    }
  });

  window.addEventListener('resize', function() { resizeCanvas(); draw(); });

  init();
})();
</script>
</body>
</html>
