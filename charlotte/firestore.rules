rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Charlotte Security Rules - FACT Substrate
    // Single collection architecture: all data in /facts
    // Types: NODE, EDGE, METRIC, SIGNAL, PROTOCOL

    // Default: deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // Facts collection - the entire substrate
    match /facts/{factId} {
      // Anyone authenticated can read facts
      allow read: if request.auth != null;

      // Create: authenticated users can create facts
      allow create: if request.auth != null &&
        // Must have required fields
        request.resource.data[':ID'] != null &&
        request.resource.data[':TYPE'] != null &&
        request.resource.data[':CREATED'] != null &&
        // Type must be valid
        request.resource.data[':TYPE'] in ['NODE', 'EDGE', 'METRIC', 'SIGNAL', 'PROTOCOL'];

      // Update: only NODE and PROTOCOL can be updated
      // EDGE, METRIC, SIGNAL are append-only (create new, don't modify)
      allow update: if request.auth != null &&
        resource.data[':TYPE'] in ['NODE', 'PROTOCOL'];

      // Delete: never from client (admin SDK only for cleanup)
      allow delete: if false;
    }

    // Users collection (FCM tokens, preferences)
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }
  }
}
